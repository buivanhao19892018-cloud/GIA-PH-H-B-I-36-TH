<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Gia ph·∫£ h·ªç B√πi ‚Ä¢ PWA (Local)</title>
  <meta name="theme-color" content="#7f1d1d" />
  <style>
    :root{
      --bg:#0b1020; --card:#0f1730; --card2:#0b1329;
      --text:#e8f0ff; --muted:#a8b7d6; --line:rgba(255,255,255,.08);
      --brand:#7f1d1d; --brand2:#b91c1c; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --r:18px;
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1100px 700px at 18% 0%, rgba(185,28,28,.22), transparent 60%),
                 radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
                 var(--bg);
      color:var(--text)
    }
    a{color:inherit}
    .wrap{max-width:1050px; margin:0 auto; padding:14px 14px 96px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg, rgba(127,29,29,.95), rgba(15,23,48,.65));
      border:1px solid var(--line); border-radius:22px; padding:14px;
      box-shadow:var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0}
    .logo{
      width:46px; height:46px; border-radius:16px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), rgba(0,0,0,.25);
      display:grid; place-items:center; border:1px solid rgba(255,255,255,.14);
      font-weight:900; letter-spacing:.5px;
      flex:0 0 auto;
    }
    .title{font-weight:900; font-size:16px; line-height:1.1}
    .sub{color:rgba(255,255,255,.8); font-size:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px; border-radius:14px;
      font-weight:800; cursor:pointer;
      user-select:none;
    }
    .btn.primary{background:linear-gradient(135deg, var(--brand2), var(--brand)); border-color:rgba(255,255,255,.18)}
    .btn.good{background:linear-gradient(135deg, rgba(34,197,94,.9), rgba(22,163,74,.9))}
    .btn.warn{background:linear-gradient(135deg, rgba(245,158,11,.95), rgba(217,119,6,.95))}
    .btn.bad{background:linear-gradient(135deg, rgba(239,68,68,.95), rgba(185,28,28,.95))}
    .pill{padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(0,0,0,.25); font-size:12px}
    .card{
      margin-top:14px;
      border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.18)}
    .card .hd h3{margin:0; font-size:14px}
    .card .bd{padding:12px}
    .grid{display:grid; gap:10px}
    @media(min-width:900px){ .grid.two{grid-template-columns:1fr 1fr} .grid.three{grid-template-columns:1.2fr .8fr .8fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22); color:var(--text);
      outline:none;
    }
    .field textarea{min-height:110px; resize:vertical}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.12); border-radius:16px;
      background:rgba(0,0,0,.2); padding:10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .left{display:flex; gap:10px; align-items:center; min-width:0}
    .avatar{
      width:44px; height:44px; border-radius:14px; background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12); overflow:hidden; flex:0 0 auto; display:grid; place-items:center;
      font-weight:900; color:rgba(255,255,255,.7)
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .name{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:58vw}
    .meta{font-size:12px; color:var(--muted)}
    .tabs{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(11,16,32,.88);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      display:flex; gap:10px; justify-content:center;
      z-index:50;
    }
    .tab{
      width:min(160px, 22vw); text-align:center; padding:10px 10px;
      border-radius:14px; border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20); cursor:pointer; font-weight:900;
      user-select:none;
    }
    .tab.on{background:linear-gradient(135deg, rgba(185,28,28,.92), rgba(127,29,29,.92))}
    .hide{display:none !important}
    .toast{position:fixed; top:12px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.75); border:1px solid rgba(255,255,255,.18); padding:10px 12px; border-radius:14px; z-index:99; max-width:92vw}
    .treeBox{border:1px dashed rgba(255,255,255,.16); border-radius:16px; padding:10px; overflow:auto; background:rgba(0,0,0,.18)}
    svg{max-width:100%}
    .sep{height:1px; background:rgba(255,255,255,.10); margin:10px 0}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .pill{font-weight:900}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .qrBox{display:grid; place-items:center; padding:12px; border:1px dashed rgba(255,255,255,.18); border-radius:16px; background:rgba(0,0,0,.18)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">BU</div>
        <div style="min-width:0">
          <div class="title">Gia ph·∫£ h·ªç B√πi ‚Ä¢ PWA (Local)</div>
          <div class="sub">T√°c gi·∫£: <b>B√πi H√†o</b> ‚Ä¢ L∆∞u d·ªØ li·ªáu tr√™n m√°y (Export/Import ƒë·ªÉ sao l∆∞u & chia s·∫ª)</div>
        </div>
      </div>
      <div class="row">
        <span class="pill" id="pillFamily">Ch∆∞a t·∫°o gia ph·∫£</span>
        <button class="btn" id="btnQR">QR v√†o app</button>
        <button class="btn warn" id="btnExport">Export</button>
        <button class="btn" id="btnImport">Import</button>
        <button class="btn bad" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- SETUP -->
    <section class="card" id="secSetup">
      <div class="hd">
        <h3>1) Thi·∫øt l·∫≠p gia ph·∫£</h3>
        <span class="muted small">T·∫°o ‚ÄúGia ph·∫£ h·ªç B√πi‚Äù ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
      </div>
      <div class="bd grid two">
        <div class="field">
          <label>T√™n gia ph·∫£</label>
          <input id="famName" value="Gia ph·∫£ h·ªç B√πi" />
        </div>
        <div class="field">
          <label>ƒê·ªãa ch·ªâ / qu√™ qu√°n</label>
          <input id="famAddr" placeholder="Thanh H√≥a, ..." />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>M√¥ t·∫£ ng·∫Øn</label>
          <input id="famDesc" placeholder="V√≠ d·ª•: D√≤ng h·ªç B√πi ‚Äì chi X ‚Äì th√¥n ... x√£ ... huy·ªán ... t·ªânh ..." />
        </div>
        <div class="row">
          <button class="btn primary" id="btnCreate">T·∫°o / L∆∞u thi·∫øt l·∫≠p</button>
          <button class="btn good" id="btnSeed">T·∫°o m·∫´u 5 ng∆∞·ªùi</button>
        </div>
        <div class="muted small" style="grid-column:1/-1">
          G·ª£i √Ω: T·∫°o ‚ÄúC·ª• t·ªï‚Äù tr∆∞·ªõc ‚Üí th√™m con/ch√°u ‚Üí t·∫°o quan h·ªá CHA/M·∫∏ ‚Üî CON ‚Üí qua tab ‚ÄúC√¢y‚Äù ƒë·ªÉ xem ph·∫£ ƒë·ªì.
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="card" id="secApp">
      <div class="hd">
        <h3 id="hApp">2) Qu·∫£n l√Ω</h3>
        <div class="kpi">
          <span class="pill" id="statPeople">0 th√†nh vi√™n</span>
          <span class="pill" id="statEvents">0 s·ª± ki·ªán</span>
          <span class="pill" id="statPhotos">0 ·∫£nh</span>
          <span class="pill" id="statBranches">0 nh√°nh</span>
        </div>
      </div>
      <div class="bd">
        <!-- screens -->
        <div id="screenDashboard">
          <div class="grid two">
            <div class="card" style="margin:0">
              <div class="hd"><h3>T·ªïng quan</h3></div>
              <div class="bd">
                <div class="muted small" id="famInfo">Ch∆∞a c√≥ d·ªØ li·ªáu gia ph·∫£.</div>
                <div class="sep"></div>
                <div class="row">
                  <button class="btn primary" id="btnAddPersonQuick">+ Th√™m ng∆∞·ªùi</button>
                  <button class="btn" id="btnAddRelQuick">+ Th√™m quan h·ªá</button>
                  <button class="btn" id="btnAddEventQuick">+ S·ª± ki·ªán</button>
                  <button class="btn" id="btnAddPhotoQuick">+ ·∫¢nh</button>
                </div>
                <div class="sep"></div>
                <div class="muted small">
                  ‚úÖ C√≥ ƒë·ªß m·ª•c: Th√†nh vi√™n, Quan h·ªá, C√¢y gia ph·∫£, S·ª± ki·ªán/M·ªëc, Ph·∫£ k√Ω, T·ª´ ƒë∆∞·ªùng, ·∫¢nh, Import/Export.  
                  ‚ö†Ô∏è B·∫£n local: d·ªØ li·ªáu n·∫±m tr√™n m√°y b·∫°n; mu·ªën ƒë∆∞a cho ng∆∞·ªùi kh√°c d√πng chung ‚Üí Export file JSON.
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <div class="hd"><h3>T√¨m nhanh</h3></div>
              <div class="bd">
                <div class="row" style="margin-bottom:10px">
                  <input id="q" style="flex:1; min-width:220px" placeholder="T√¨m t√™n, nƒÉm sinh, qu√™ qu√°n..." />
                  <button class="btn" id="btnSearch">T√¨m</button>
                </div>
                <div class="muted small">K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü tab ‚ÄúTh√†nh vi√™n‚Äù.</div>
                <div class="sep"></div>
                <div class="row">
                  <button class="btn" id="btnOpenPhaky">Ph·∫£ k√Ω</button>
                  <button class="btn" id="btnOpenTuduong">T·ª´ ƒë∆∞·ªùng</button>
                  <button class="btn" id="btnOpenQR2">M√£ QR chia s·∫ª link</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PEOPLE -->
        <div id="screenPeople" class="hide">
          <div class="row" style="margin-bottom:10px">
            <input id="q2" style="flex:1; min-width:220px" placeholder="T√¨m t√™n, nƒÉm sinh, qu√™ qu√°n..." />
            <button class="btn" id="btnSearch2">T√¨m</button>
            <button class="btn primary" id="btnAddPerson">+ Th√™m</button>
          </div>
          <div class="list" id="peopleList"></div>
        </div>

        <!-- TREE -->
        <div id="screenTree" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" id="btnBuildTree">V·∫Ω c√¢y</button>
            <select id="rootSelect" style="flex:1; min-width:220px"></select>
            <button class="btn" id="btnTreeMode">Ch·∫ø ƒë·ªô: G·ªçn</button>
          </div>
          <div class="treeBox" id="treeBox">
            <div class="muted small">Ch·ªçn ‚Äúg·ªëc‚Äù r·ªìi b·∫•m V·∫Ω c√¢y. B·∫£n n√†y l√† layout SVG ƒë∆°n gi·∫£n (ƒë·ªß d√πng).</div>
          </div>
        </div>

        <!-- RELATIONS -->
        <div id="screenRelations" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" id="btnAddRelation">+ Th√™m quan h·ªá</button>
            <button class="btn" id="btnRelCheck">Ki·ªÉm tra l·ªói quan h·ªá</button>
          </div>
          <div class="list" id="relList"></div>
          <div class="muted small" style="margin-top:10px">
            Quy ∆∞·ªõc: CHA/M·∫∏ ‚Üí CON l√† quan h·ªá ch√≠nh ƒë·ªÉ v·∫Ω c√¢y. V·ª£/Ch·ªìng, Anh/Ch·ªã/Em ƒë·ªÉ ghi ch√∫.
          </div>
        </div>

        <!-- EVENTS -->
        <div id="screenEvents" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" id="btnAddEvent">+ Th√™m s·ª± ki·ªán</button>
            <button class="btn" id="btnSortEvents">S·∫Øp x·∫øp: M·ªõi ‚Üí C≈©</button>
          </div>
          <div class="list" id="eventList"></div>
        </div>

        <!-- NOTES -->
        <div id="screenNotes" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn" data-kind="phaky" id="btnNotePhaky">Ph·∫£ k√Ω</button>
            <button class="btn" data-kind="tuduong" id="btnNoteTuduong">T·ª´ ƒë∆∞·ªùng</button>
            <span class="pill" id="noteKind">-</span>
          </div>
          <div class="grid">
            <div class="field">
              <label>Ti√™u ƒë·ªÅ</label>
              <input id="noteTitle" />
            </div>
            <div class="field">
              <label>N·ªôi dung</label>
              <textarea id="noteContent" placeholder="Vi·∫øt l·ªãch s·ª≠ d√≤ng h·ªç / quy ∆∞·ªõc t·ª´ ƒë∆∞·ªùng / b√†i vƒÉn t·∫ø..."></textarea>
            </div>
            <div class="row">
              <button class="btn good" id="btnSaveNote">L∆∞u</button>
              <button class="btn" id="btnPrintNote">In/Copy</button>
            </div>
          </div>
        </div>

        <!-- PHOTOS -->
        <div id="screenPhotos" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" id="btnAddPhoto">+ Th√™m ·∫£nh</button>
            <button class="btn" id="btnClearPhotos">X√≥a to√†n b·ªô ·∫£nh (local)</button>
          </div>
          <div class="muted small">·∫¢nh ƒë∆∞·ª£c n√©n v√† l∆∞u ngay trong m√°y (base64). N√™n Export ƒë·ªÉ sao l∆∞u.</div>
          <div class="sep"></div>
          <div class="list" id="photoList"></div>
        </div>

        <!-- MODAL -->
        <div class="card hide" id="modal" style="margin-top:14px">
          <div class="hd">
            <h3 id="mTitle">Modal</h3>
            <button class="btn" id="mClose">ƒê√≥ng</button>
          </div>
          <div class="bd" id="mBody"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab on" data-tab="dashboard">Gia ph·∫£</div>
    <div class="tab" data-tab="tree">C√¢y</div>
    <div class="tab" data-tab="people">Th√†nh vi√™n</div>
    <div class="tab" data-tab="relations">Quan h·ªá</div>
    <div class="tab" data-tab="events">S·ª± ki·ªán</div>
    <div class="tab" data-tab="notes">Ph·∫£ k√Ω</div>
    <div class="tab" data-tab="photos">·∫¢nh</div>
  </div>

  <div class="toast hide" id="toast"></div>

  <!-- QR (pure JS) -->
  <script>
    /***************
     * Gia ph·∫£ h·ªç B√πi ‚Ä¢ PWA (Local) ‚Äî T√°c gi·∫£: B√πi H√†o
     * 1-file version: localStorage + Export/Import + Photos (base64)
     ***************/

    // ====== helpers ======
    const $ = s => document.querySelector(s);
    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+Date.now()));
    const nowISO = () => new Date().toISOString();
    const escapeHtml = (s)=> (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    const toast = (msg) => { const t=$("#toast"); t.textContent=msg; t.classList.remove("hide"); setTimeout(()=>t.classList.add("hide"), 2200); };
    const show = (id, on=true) => $(id).classList.toggle("hide", !on);

    // ====== storage ======
    const KEY = "giapha_bui_local_v1";
    const load = () => {
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    };
    const save = () => localStorage.setItem(KEY, JSON.stringify(state));

    // ====== state ======
    let state = load() || {
      family: { name:"", address:"", desc:"", created_at: nowISO(), updated_at: nowISO() },
      people: [],
      relations: [],
      events: [],
      notes: { phaky:{title:"", content:"", updated_at:null}, tuduong:{title:"", content:"", updated_at:null} },
      photos: [],
      settings: { treeMode:"compact", eventSort:"desc" }
    };

    // ====== UI init ======
    function refreshHeader(){
      const fam = state.family;
      const ok = !!(fam.name && fam.name.trim());
      $("#pillFamily").textContent = ok ? fam.name : "Ch∆∞a t·∫°o gia ph·∫£";
      $("#hApp").textContent = ok ? `2) Qu·∫£n l√Ω ‚Ä¢ ${fam.name}` : "2) Qu·∫£n l√Ω";
      $("#famInfo").innerHTML = ok
        ? `‚Ä¢ <b>${escapeHtml(fam.name)}</b><br>‚Ä¢ Qu√™ qu√°n: ${escapeHtml(fam.address||"(ch∆∞a nh·∫≠p)")}<br>‚Ä¢ M√¥ t·∫£: ${escapeHtml(fam.desc||"(ch∆∞a nh·∫≠p)")}`
        : "Ch∆∞a c√≥ d·ªØ li·ªáu gia ph·∫£. H√£y t·∫°o thi·∫øt l·∫≠p ·ªü m·ª•c 1).";
      $("#famName").value = fam.name || "Gia ph·∫£ h·ªç B√πi";
      $("#famAddr").value = fam.address || "";
      $("#famDesc").value = fam.desc || "";
      updateStats();
      fillRootSelect();
      renderPeople(state.people);
      renderRelations();
      renderEvents();
      renderPhotos();
      save();
    }

    function updateStats(){
      $("#statPeople").textContent = `${state.people.length} th√†nh vi√™n`;
      $("#statEvents").textContent = `${state.events.length} s·ª± ki·ªán`;
      $("#statPhotos").textContent = `${state.photos.length} ·∫£nh`;
      $("#statBranches").textContent = `${countBranches()} nh√°nh`;
    }

    // ====== tabs ======
    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
    function goTab(tab){
      ["dashboard","tree","people","relations","events","notes","photos"].forEach(t=>{
        $("#screen"+cap(t)).classList.toggle("hide", t!==tab);
      });
      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("on", el.dataset.tab===tab);
      });
    }
    document.querySelectorAll(".tab").forEach(el=> el.addEventListener("click", ()=> goTab(el.dataset.tab)));

    // ====== setup ======
    $("#btnCreate").addEventListener("click", ()=>{
      state.family.name = ($("#famName").value||"").trim() || "Gia ph·∫£ h·ªç B√πi";
      state.family.address = ($("#famAddr").value||"").trim();
      state.family.desc = ($("#famDesc").value||"").trim();
      state.family.updated_at = nowISO();
      toast("ƒê√£ l∆∞u thi·∫øt l·∫≠p");
      refreshHeader();
    });

    $("#btnSeed").addEventListener("click", ()=>{
      if(state.people.length) return toast("ƒê√£ c√≥ d·ªØ li·ªáu, kh√¥ng seed n·ªØa");
      const A = addPerson({display_role:"C·ª• t·ªï", full_name:"B√πi (C·ª• t·ªï)", gender:"Nam", birth_year: 1900, hometown_province:"Thanh H√≥a"});
      const B = addPerson({display_role:"C·ª• b√†", full_name:"(C·ª• b√†)", gender:"N·ªØ", birth_year: 1905});
      const C = addPerson({display_role:"ƒê·ªùi 2", full_name:"B√πi VƒÉn A", gender:"Nam", birth_year: 1930});
      const D = addPerson({display_role:"ƒê·ªùi 2", full_name:"B√πi Th·ªã B", gender:"N·ªØ", birth_year: 1933});
      const E = addPerson({display_role:"ƒê·ªùi 3", full_name:"B√πi H√†o", gender:"Nam", birth_year: 1998, phone:"", job:"", hometown_province:"Thanh H√≥a"});
      // relations: A parent of C,D ; C parent of E ; spouses A-B
      addRelation({a:A.id, b:C.id, type:"parent"});
      addRelation({a:A.id, b:D.id, type:"parent"});
      addRelation({a:C.id, b:E.id, type:"parent"});
      addRelation({a:A.id, b:B.id, type:"spouse"});
      toast("ƒê√£ t·∫°o m·∫´u 5 ng∆∞·ªùi");
      refreshHeader();
      goTab("people");
    });

    // ====== people ======
    function addPerson(p){
      const obj = {
        id: uid(),
        display_role: p.display_role||"",
        full_name: p.full_name||"",
        other_name: p.other_name||"",
        gender: p.gender||"Nam",
        birth_day: p.birth_day??null, birth_month: p.birth_month??null, birth_year: p.birth_year??null,
        marital_status: p.marital_status||"",
        phone: p.phone||"",
        education: p.education||"",
        job: p.job||"",
        hometown_province: p.hometown_province||"",
        hometown_district: p.hometown_district||"",
        hometown_ward: p.hometown_ward||"",
        current_address: p.current_address||"",
        map_link: p.map_link||"",
        bio: p.bio||"",
        death_lunar_day: p.death_lunar_day??null,
        death_lunar_month: p.death_lunar_month??null,
        death_lunar_year: p.death_lunar_year??null,
        death_lunar_text: p.death_lunar_text||"",
        worship_place: p.worship_place||"",
        caretaker_name: p.caretaker_name||"",
        tomb_address: p.tomb_address||"",
        avatar_data: p.avatar_data||"", // base64
        created_at: nowISO(),
        updated_at: nowISO(),
      };
      state.people.unshift(obj);
      return obj;
    }

    function personAvatar(p){
      if(p.avatar_data) return `<img src="${p.avatar_data}" alt="avatar">`;
      const initial = (p.full_name||"?").trim().slice(0,1).toUpperCase();
      return `<span>${escapeHtml(initial)}</span>`;
    }

    function renderPeople(arr){
      const box = $("#peopleList");
      box.innerHTML = "";
      if(!arr.length){
        box.innerHTML = `<div class="muted small">Ch∆∞a c√≥ th√†nh vi√™n. B·∫•m ‚Äú+ Th√™m‚Äù ƒë·ªÉ t·∫°o.</div>`;
        return;
      }
      arr.forEach(p=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div class="avatar">${personAvatar(p)}</div>
            <div style="min-width:0">
              <div class="name">${escapeHtml(p.full_name)} ${p.display_role?`<span class="pill">${escapeHtml(p.display_role)}</span>`:""}</div>
              <div class="meta">${escapeHtml(p.gender||"")} ‚Ä¢ ${fmtY(p.birth_year)} ‚Ä¢ ${escapeHtml(p.hometown_province||"")}</div>
            </div>
          </div>
          <div class="row">
            <button class="btn" data-id="${p.id}" data-act="view">Xem</button>
            <button class="btn warn" data-id="${p.id}" data-act="edit">S·ª≠a</button>
          </div>
        `;
        el.addEventListener("click", (e)=>{
          const b = e.target.closest("button");
          if(!b) return;
          const id=b.dataset.id, act=b.dataset.act;
          const person = state.people.find(x=>x.id===id);
          if(!person) return;
          if(act==="view") openPerson(person, false);
          if(act==="edit") openPerson(person, true);
        });
        box.appendChild(el);
      });
    }

    function fillRootSelect(){
      const sel = $("#rootSelect");
      sel.innerHTML = "";
      const arr = state.people.slice().reverse();
      if(!arr.length){
        sel.innerHTML = `<option value="">(Ch∆∞a c√≥ ng∆∞·ªùi)</option>`;
        return;
      }
      arr.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.full_name || "(kh√¥ng t√™n)";
        sel.appendChild(opt);
      });
    }

    function openPerson(p={}, editable=true){
      showModal(editable ? (p.id?"S·ª≠a th√†nh vi√™n":"Th√™m th√†nh vi√™n") : "Th√¥ng tin th√†nh vi√™n", personForm(p, editable));
      wirePersonForm(p, editable);
    }

    function personForm(p={}, editable=true){
      const dis = editable ? "" : "disabled";
      return `
        <div class="grid two">
          <div class="field">
            <label>·∫¢nh ƒë·∫°i di·ªán</label>
            <div class="row">
              <div class="avatar" style="width:72px;height:72px;border-radius:18px">${p.avatar_data?`<img src="${p.avatar_data}">`: (p.full_name?escapeHtml(p.full_name.trim().slice(0,1).toUpperCase()):"?" )}</div>
              ${editable ? `<input ${dis} type="file" id="avatarFile" accept="image/*" />` : `<span class="muted small">Ch·ªâ xem</span>`}
            </div>
            <div class="muted small">B·∫£n local: ·∫£nh l∆∞u trong m√°y (n√©n jpg).</div>
          </div>

          <div class="field">
            <label>Vai v·∫ø (C·ª• t·ªï...)</label>
            <input ${dis} id="display_role" value="${val(p.display_role)}" />
          </div>

          <div class="field">
            <label>H·ªç v√† t√™n*</label>
            <input ${dis} id="full_name" value="${val(p.full_name)}" />
          </div>

          <div class="field">
            <label>T√™n kh√°c</label>
            <input ${dis} id="other_name" value="${val(p.other_name)}" />
          </div>

          <div class="field">
            <label>Gi·ªõi t√≠nh</label>
            <select ${dis} id="gender">
              ${opt(p.gender, ["Nam","N·ªØ","Kh√°c"])}
            </select>
          </div>

          <div class="field">
            <label>T√¨nh tr·∫°ng h√¥n nh√¢n</label>
            <input ${dis} id="marital_status" value="${val(p.marital_status)}" placeholder="ƒê·ªôc th√¢n, 1 v·ª£..." />
          </div>

          <div class="field">
            <label>Ng√†y sinh (d/m/y)</label>
            <div class="row" style="width:100%">
              <input ${dis} id="birth_day" style="flex:1" value="${val(p.birth_day)}" placeholder="dd">
              <input ${dis} id="birth_month" style="flex:1" value="${val(p.birth_month)}" placeholder="mm">
              <input ${dis} id="birth_year" style="flex:1" value="${val(p.birth_year)}" placeholder="yyyy">
            </div>
          </div>

          <div class="field">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input ${dis} id="phone" value="${val(p.phone)}" placeholder="VD: 09..." />
          </div>

          <div class="field">
            <label>Tr√¨nh ƒë·ªô</label>
            <input ${dis} id="education" value="${val(p.education)}" />
          </div>

          <div class="field">
            <label>Ngh·ªÅ nghi·ªáp</label>
            <input ${dis} id="job" value="${val(p.job)}" />
          </div>

          <div class="field">
            <label>Nguy√™n qu√°n (T·ªânh / Huy·ªán / X√£)</label>
            <div class="row" style="width:100%">
              <input ${dis} id="hp" style="flex:1" value="${val(p.hometown_province)}" placeholder="T·ªânh">
              <input ${dis} id="hd" style="flex:1" value="${val(p.hometown_district)}" placeholder="Huy·ªán">
              <input ${dis} id="hw" style="flex:1" value="${val(p.hometown_ward)}" placeholder="X√£/Ph∆∞·ªùng">
            </div>
          </div>

          <div class="field">
            <label>ƒê·ªãa ch·ªâ hi·ªán t·∫°i</label>
            <input ${dis} id="current_address" value="${val(p.current_address)}" />
          </div>

          <div class="field">
            <label>Link Google Map</label>
            <input ${dis} id="map_link" value="${val(p.map_link)}" placeholder="https://maps.google.com/..." />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ti·ªÉu s·ª≠</label>
            <textarea ${dis} id="bio">${val(p.bio)}</textarea>
          </div>

          <div class="field">
            <label>Ng√†y gi·ªó (√Çm l·ªãch) (d/m/y)</label>
            <div class="row" style="width:100%">
              <input ${dis} id="death_lunar_day" style="flex:1" value="${val(p.death_lunar_day)}" placeholder="dd">
              <input ${dis} id="death_lunar_month" style="flex:1" value="${val(p.death_lunar_month)}" placeholder="mm">
              <input ${dis} id="death_lunar_year" style="flex:1" value="${val(p.death_lunar_year)}" placeholder="yyyy">
            </div>
          </div>

          <div class="field">
            <label>Ng√†y gi·ªó t√™n √¢m l·ªãch</label>
            <input ${dis} id="death_lunar_text" value="${val(p.death_lunar_text)}" placeholder="Gi·ªù Tu·∫•t th√°ng Ch·∫°p..." />
          </div>

          <div class="field">
            <label>Th·ªù c√∫ng t·∫°i</label>
            <input ${dis} id="worship_place" value="${val(p.worship_place)}" placeholder="T·ª´ ƒë∆∞·ªùng ch√≠nh..." />
          </div>

          <div class="field">
            <label>Ng∆∞·ªùi ph·ª• tr√°ch</label>
            <input ${dis} id="caretaker_name" value="${val(p.caretaker_name)}" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>M·ªô t√°ng</label>
            <input ${dis} id="tomb_address" value="${val(p.tomb_address)}" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          ${editable ? `<button class="btn good" id="btnSavePerson">${p.id?"L∆∞u":"T·∫°o"}</button>` : ``}
          <button class="btn" id="btnOpenRel">Quan h·ªá</button>
          ${p.id ? `<button class="btn bad" id="btnDelPerson">X√≥a</button>` : ``}
        </div>
      `;
    }

    function val(x){ return escapeHtml(x??""); }
    function opt(cur, arr){
      const c = (cur??arr[0]??"");
      return arr.map(x=>`<option ${x===c?"selected":""}>${escapeHtml(x)}</option>`).join("");
    }
    function toInt(v){ const n = parseInt(v,10); return Number.isFinite(n)?n:null; }
    function fmtY(y){ return y?`SN ${y}`:""; }

    async function wirePersonForm(p={}, editable=true){
      const isNew = !p.id;
      $("#btnOpenRel")?.addEventListener("click", ()=>{
        closeModal();
        goTab("relations");
        openRelationEditor(p.id ? p : null);
      });

      $("#btnDelPerson")?.addEventListener("click", ()=>{
        if(!confirm("X√≥a th√†nh vi√™n n√†y? (Quan h·ªá & s·ª± ki·ªán li√™n quan s·∫Ω b·ªã g·ª° tham chi·∫øu)")) return;
        // remove person
        state.people = state.people.filter(x=>x.id!==p.id);
        // remove relations tied
        state.relations = state.relations.filter(r=>r.a!==p.id && r.b!==p.id);
        // detach events
        state.events = state.events.map(ev=> ev.person_id===p.id ? ({...ev, person_id:null}) : ev);
        // photos detach
        state.photos = state.photos.map(ph=> ph.person_id===p.id ? ({...ph, person_id:null}) : ph);
        toast("ƒê√£ x√≥a");
        closeModal();
        refreshHeader();
      });

      $("#btnSavePerson")?.addEventListener("click", async ()=>{
        const payload = {
          display_role: $("#display_role").value.trim(),
          full_name: $("#full_name").value.trim(),
          other_name: $("#other_name").value.trim(),
          gender: $("#gender").value,
          birth_day: toInt($("#birth_day").value),
          birth_month: toInt($("#birth_month").value),
          birth_year: toInt($("#birth_year").value),
          marital_status: $("#marital_status").value.trim(),
          phone: $("#phone").value.trim(),
          education: $("#education").value.trim(),
          job: $("#job").value.trim(),
          hometown_province: $("#hp").value.trim(),
          hometown_district: $("#hd").value.trim(),
          hometown_ward: $("#hw").value.trim(),
          current_address: $("#current_address").value.trim(),
          map_link: $("#map_link").value.trim(),
          bio: $("#bio").value,
          death_lunar_day: toInt($("#death_lunar_day").value),
          death_lunar_month: toInt($("#death_lunar_month").value),
          death_lunar_year: toInt($("#death_lunar_year").value),
          death_lunar_text: $("#death_lunar_text").value.trim(),
          worship_place: $("#worship_place").value.trim(),
          caretaker_name: $("#caretaker_name").value.trim(),
          tomb_address: $("#tomb_address").value.trim(),
          updated_at: nowISO()
        };
        if(!payload.full_name) return toast("Thi·∫øu h·ªç t√™n");

        let personId = p.id;
        if(isNew){
          const created = addPerson(payload);
          personId = created.id;
          toast("ƒê√£ t·∫°o");
        }else{
          const idx = state.people.findIndex(x=>x.id===p.id);
          if(idx>=0) state.people[idx] = {...state.people[idx], ...payload};
          toast("ƒê√£ l∆∞u");
        }

        const file = $("#avatarFile")?.files?.[0];
        if(file){
          const base64 = await compressToDataUrl(file, 512, 0.82);
          const idx = state.people.findIndex(x=>x.id===personId);
          if(idx>=0) state.people[idx].avatar_data = base64;
          toast("ƒê√£ l∆∞u avatar");
        }

        closeModal();
        refreshHeader();
      });
    }

    // ====== relations ======
    function addRelation(r){
      // avoid duplicates simplistic
      const exists = state.relations.some(x=> x.a===r.a && x.b===r.b && x.type===r.type);
      if(exists) return null;
      const obj = { id: uid(), a:r.a, b:r.b, type:r.type, note:r.note||"", created_at: nowISO() };
      state.relations.unshift(obj);
      return obj;
    }

    function openRelationEditor(person=null){
      if(!state.people.length) return toast("Ch∆∞a c√≥ ng∆∞·ªùi");
      const aDefault = person?.id || state.people[0].id;
      const options = state.people.map(x=>`<option value="${x.id}">${escapeHtml(x.full_name||"(kh√¥ng t√™n)")}</option>`).join("");
      const html = `
        <div class="muted small">T·∫°o quan h·ªá (A ‚Üî B)</div>
        <div class="grid two" style="margin-top:10px">
          <div class="field">
            <label>A</label>
            <select id="relA">${options}</select>
          </div>
          <div class="field">
            <label>B</label>
            <select id="relB">${options}</select>
          </div>
          <div class="field">
            <label>Lo·∫°i quan h·ªá</label>
            <select id="relType">
              <option value="parent">A l√† CHA/M·∫∏ c·ªßa B</option>
              <option value="child">A l√† CON c·ªßa B</option>
              <option value="spouse">V·ª£/Ch·ªìng</option>
              <option value="sibling">Anh/Ch·ªã/Em</option>
            </select>
          </div>
          <div class="field">
            <label>Ghi ch√∫</label>
            <input id="relNote" placeholder="V√≠ d·ª•: con tr∆∞·ªüng / con th·ª©..." />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnSaveRel">L∆∞u quan h·ªá</button>
        </div>
        <div class="muted small" style="margin-top:10px">
          Tip: Quan h·ªá ‚Äúparent/child‚Äù d√πng ƒë·ªÉ v·∫Ω c√¢y. V·ª£/Ch·ªìng/Anh em ch·ªâ ghi ch√∫.
        </div>
      `;
      showModal("Th√™m quan h·ªá", html);
      $("#relA").value = aDefault;
      $("#btnSaveRel").addEventListener("click", ()=>{
        const a = $("#relA").value;
        const b = $("#relB").value;
        const type = $("#relType").value;
        const note = ($("#relNote").value||"").trim();
        if(!a || !b) return toast("Ch·ªçn A & B");
        if(a===b) return toast("Kh√¥ng th·ªÉ t·ª± li√™n quan");
        addRelation({a,b,type,note});
        toast("ƒê√£ l∆∞u quan h·ªá");
        closeModal();
        renderRelations();
        updateStats(); save();
      });
    }

    function relText(r){
      const A = state.people.find(x=>x.id===r.a)?.full_name || "?";
      const B = state.people.find(x=>x.id===r.b)?.full_name || "?";
      const t = r.type==="parent" ? "CHA/M·∫∏ ‚Üí CON"
            : r.type==="child" ? "CON ‚Üí CHA/M·∫∏"
            : r.type==="spouse" ? "V·ª¢/CH·ªíNG"
            : "ANH/CH·ªä/EM";
      return {A,B,t};
    }

    function renderRelations(){
      const box = $("#relList");
      box.innerHTML = "";
      if(!state.relations.length){
        box.innerHTML = `<div class="muted small">Ch∆∞a c√≥ quan h·ªá. B·∫•m ‚Äú+ Th√™m quan h·ªá‚Äù.</div>`;
        return;
      }
      state.relations.forEach(r=>{
        const {A,B,t} = relText(r);
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div style="min-width:0">
              <div class="name">${escapeHtml(A)} <span class="pill">${escapeHtml(t)}</span> ${escapeHtml(B)}</div>
              <div class="meta">${r.note?escapeHtml(r.note):""}</div>
            </div>
          </div>
          <div class="row">
            <button class="btn bad" data-id="${r.id}">X√≥a</button>
          </div>
        `;
        el.querySelector("button").addEventListener("click", ()=>{
          if(!confirm("X√≥a quan h·ªá n√†y?")) return;
          state.relations = state.relations.filter(x=>x.id!==r.id);
          toast("ƒê√£ x√≥a");
          renderRelations(); save();
        });
        box.appendChild(el);
      });
    }

    function checkRelations(){
      // basic checks: cycles for parent edges, missing ids
      const ids = new Set(state.people.map(p=>p.id));
      const bad = [];
      state.relations.forEach(r=>{
        if(!ids.has(r.a) || !ids.has(r.b)) bad.push(`Quan h·ªá m·∫•t ng∆∞·ªùi: ${r.id}`);
        if(r.type==="parent" && r.a===r.b) bad.push(`Quan h·ªá t·ª± th√¢n: ${r.id}`);
      });
      // cycle detect for parent edges A->B
      const g = {};
      state.people.forEach(p=> g[p.id]=[]);
      state.relations.forEach(r=>{
        if(r.type==="parent") g[r.a].push(r.b);
        if(r.type==="child") g[r.b].push(r.a);
      });
      const seen = new Set(), stack = new Set();
      const dfs = (u)=>{
        if(stack.has(u)) return true;
        if(seen.has(u)) return false;
        seen.add(u); stack.add(u);
        for(const v of (g[u]||[])) if(dfs(v)) return true;
        stack.delete(u); return false;
      };
      let hasCycle=false;
      for(const id of Object.keys(g)){ if(dfs(id)){ hasCycle=true; break; } }
      if(hasCycle) bad.push("Ph√°t hi·ªán v√≤ng l·∫∑p CHA/M·∫∏‚ÜíCON (sai d·ªØ li·ªáu).");

      showModal("K·∫øt qu·∫£ ki·ªÉm tra", `
        <div class="muted small">N·∫øu c√≥ v√≤ng l·∫∑p, c√¢y s·∫Ω v·∫Ω sai. H√£y x√≥a/ƒë·ªïi quan h·ªá parent/child.</div>
        <div class="sep"></div>
        <div class="list">
          ${bad.length ? bad.map(x=>`<div class="item"><div class="left"><div>${escapeHtml(x)}</div></div></div>`).join("") : `<div class="muted small">‚úÖ Kh√¥ng th·∫•y l·ªói c∆° b·∫£n.</div>`}
        </div>
      `);
    }

    // ====== events ======
    function addEvent(ev){
      const obj = {
        id: uid(),
        title: ev.title||"",
        event_type: ev.event_type||"custom", // gio, birth, death, anniversary, custom
        person_id: ev.person_id||null,
        date_greg: ev.date_greg||"",
        date_lunar: ev.date_lunar||"",
        note: ev.note||"",
        created_at: nowISO()
      };
      state.events.unshift(obj);
      return obj;
    }

    function renderEvents(){
      const box = $("#eventList");
      box.innerHTML = "";
      if(!state.events.length){
        box.innerHTML = `<div class="muted small">Ch∆∞a c√≥ s·ª± ki·ªán. B·∫•m ‚Äú+ Th√™m s·ª± ki·ªán‚Äù.</div>`;
        return;
      }
      const arr = state.settings.eventSort==="desc" ? state.events.slice() : state.events.slice().reverse();
      arr.forEach(ev=>{
        const p = ev.person_id ? state.people.find(x=>x.id===ev.person_id) : null;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div style="min-width:0">
              <div class="name">${escapeHtml(ev.title)} <span class="pill">${escapeHtml(ev.event_type)}</span></div>
              <div class="meta">${p ? ("üë§ "+escapeHtml(p.full_name)+" ‚Ä¢ ") : ""}${escapeHtml(ev.date_greg||"")} ${ev.date_lunar?("‚Ä¢ "+escapeHtml(ev.date_lunar)):""}</div>
            </div>
          </div>
          <div class="row">
            <button class="btn warn" data-id="${ev.id}">S·ª≠a</button>
            <button class="btn bad" data-id="${ev.id}" data-del="1">X√≥a</button>
          </div>
        `;
        el.addEventListener("click",(e)=>{
          const b=e.target.closest("button"); if(!b) return;
          const id=b.dataset.id;
          const item = state.events.find(x=>x.id===id);
          if(!item) return;
          if(b.dataset.del){
            if(!confirm("X√≥a s·ª± ki·ªán?")) return;
            state.events = state.events.filter(x=>x.id!==id);
            toast("ƒê√£ x√≥a");
            renderEvents(); updateStats(); save();
          }else{
            openEvent(item);
          }
        });
        box.appendChild(el);
      });
    }

    function openEvent(ev=null){
      const options = [`<option value="">(kh√¥ng g·∫Øn ng∆∞·ªùi)</option>`].concat(
        state.people.map(p=>`<option value="${p.id}" ${ev?.person_id===p.id?"selected":""}>${escapeHtml(p.full_name||"(kh√¥ng t√™n)")}</option>`)
      ).join("");
      const html = `
        <div class="grid two">
          <div class="field"><label>Ti√™u ƒë·ªÅ</label><input id="evTitle" value="${val(ev?.title)}"></div>
          <div class="field"><label>Lo·∫°i</label>
            <select id="evType">
              ${opt(ev?.event_type, ["gi·ªó","birth","death","anniversary","custom"])}
            </select>
          </div>
          <div class="field"><label>G·∫Øn v·ªõi ng∆∞·ªùi</label><select id="evPerson">${options}</select></div>
          <div class="field"><label>Ng√†y d∆∞∆°ng (text)</label><input id="evGreg" value="${val(ev?.date_greg)}" placeholder="2026-02-05"></div>
          <div class="field" style="grid-column:1/-1"><label>Ng√†y √¢m (text)</label><input id="evLunar" value="${val(ev?.date_lunar)}" placeholder="10/10 Canh Ng·ªç..."></div>
          <div class="field" style="grid-column:1/-1"><label>Ghi ch√∫</label><textarea id="evNote">${val(ev?.note)}</textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnSaveEv">${ev?.id?"L∆∞u":"T·∫°o"}</button>
        </div>
      `;
      showModal(ev?.id ? "S·ª≠a s·ª± ki·ªán" : "Th√™m s·ª± ki·ªán", html);
      $("#btnSaveEv").addEventListener("click", ()=>{
        const payload = {
          title: ($("#evTitle").value||"").trim(),
          event_type: $("#evType").value,
          person_id: $("#evPerson").value || null,
          date_greg: ($("#evGreg").value||"").trim(),
          date_lunar: ($("#evLunar").value||"").trim(),
          note: $("#evNote").value||""
        };
        if(!payload.title) return toast("Thi·∫øu ti√™u ƒë·ªÅ");
        if(ev?.id){
          const idx = state.events.findIndex(x=>x.id===ev.id);
          if(idx>=0) state.events[idx] = {...state.events[idx], ...payload};
          toast("ƒê√£ l∆∞u");
        }else{
          addEvent(payload);
          toast("ƒê√£ t·∫°o");
        }
        closeModal();
        renderEvents(); updateStats(); save();
      });
    }

    // ====== notes ======
    let noteKind = "phaky";
    function openNote(kind){
      noteKind = kind;
      $("#noteKind").textContent = kind==="phaky" ? "Ph·∫£ k√Ω" : "T·ª´ ƒë∆∞·ªùng";
      const n = state.notes[kind] || {title:"", content:""};
      $("#noteTitle").value = n.title || "";
      $("#noteContent").value = n.content || "";
      goTab("notes");
    }
    function saveNote(){
      state.notes[noteKind] = {
        title: ($("#noteTitle").value||"").trim(),
        content: $("#noteContent").value||"",
        updated_at: nowISO()
      };
      toast("ƒê√£ l∆∞u");
      save();
    }
    function printNote(){
      const t = ($("#noteTitle").value||"").trim();
      const c = $("#noteContent").value||"";
      const txt = `${t}\n\n${c}\n\n‚Äî Gia ph·∫£ h·ªç B√πi ‚Ä¢ T√°c gi·∫£: B√πi H√†o`;
      navigator.clipboard?.writeText(txt).then(()=>toast("ƒê√£ copy n·ªôi dung")).catch(()=>toast("Kh√¥ng copy ƒë∆∞·ª£c (tr√¨nh duy·ªát ch·∫∑n)"));
      showModal("In/Copy", `
        <div class="muted small">ƒê√£ th·ª≠ copy v√†o clipboard. B·∫°n c≈©ng c√≥ th·ªÉ ch·ªçn/copy th·ªß c√¥ng.</div>
        <textarea style="width:100%;min-height:220px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:var(--text);padding:12px">${escapeHtml(txt)}</textarea>
      `);
    }

    // ====== photos ======
    function addPhoto(obj){
      const p = {
        id: uid(),
        title: obj.title||"",
        person_id: obj.person_id||null,
        data: obj.data||"", // base64
        note: obj.note||"",
        created_at: nowISO()
      };
      state.photos.unshift(p);
      return p;
    }

    function renderPhotos(){
      const box = $("#photoList");
      box.innerHTML = "";
      if(!state.photos.length){
        box.innerHTML = `<div class="muted small">Ch∆∞a c√≥ ·∫£nh. B·∫•m ‚Äú+ Th√™m ·∫£nh‚Äù.</div>`;
        return;
      }
      state.photos.forEach(ph=>{
        const p = ph.person_id ? state.people.find(x=>x.id===ph.person_id) : null;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div class="avatar" style="width:54px;height:54px;border-radius:16px">${ph.data?`<img src="${ph.data}">`:"üì∑"}</div>
            <div style="min-width:0">
              <div class="name">${escapeHtml(ph.title||"·∫¢nh")} ${p?`<span class="pill">üë§ ${escapeHtml(p.full_name)}</span>`:""}</div>
              <div class="meta">${escapeHtml(ph.note||"")} ‚Ä¢ ${escapeHtml(new Date(ph.created_at).toLocaleString())}</div>
            </div>
          </div>
          <div class="row">
            <button class="btn" data-id="${ph.id}" data-act="view">Xem</button>
            <button class="btn bad" data-id="${ph.id}" data-act="del">X√≥a</button>
          </div>
        `;
        el.addEventListener("click",(e)=>{
          const b=e.target.closest("button"); if(!b) return;
          const id=b.dataset.id; const act=b.dataset.act;
          const item = state.photos.find(x=>x.id===id);
          if(!item) return;
          if(act==="del"){
            if(!confirm("X√≥a ·∫£nh n√†y?")) return;
            state.photos = state.photos.filter(x=>x.id!==id);
            toast("ƒê√£ x√≥a");
            renderPhotos(); updateStats(); save();
          }else{
            showModal("Xem ·∫£nh", `
              <div class="muted small">${escapeHtml(item.title||"·∫¢nh")} ${item.person_id?("‚Ä¢ "+escapeHtml(state.people.find(x=>x.id===item.person_id)?.full_name||"")):""}</div>
              <div class="sep"></div>
              <div style="border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden;background:rgba(0,0,0,.22)">
                <img src="${item.data}" style="width:100%;height:auto;display:block" />
              </div>
              <div class="sep"></div>
              <div class="muted small">${escapeHtml(item.note||"")}</div>
            `);
          }
        });
        box.appendChild(el);
      });
    }

    async function openAddPhoto(){
      if(!state.people.length) return toast("Th√™m ng∆∞·ªùi tr∆∞·ªõc ƒë·ªÉ g·∫Øn ·∫£nh (ho·∫∑c ƒë·ªÉ tr·ªëng)");
      const options = [`<option value="">(kh√¥ng g·∫Øn ng∆∞·ªùi)</option>`].concat(
        state.people.map(p=>`<option value="${p.id}">${escapeHtml(p.full_name||"(kh√¥ng t√™n)")}</option>`)
      ).join("");
      showModal("Th√™m ·∫£nh", `
        <div class="grid">
          <div class="field">
            <label>Ch·ªçn ·∫£nh</label>
            <input id="phFile" type="file" accept="image/*" />
          </div>
          <div class="field">
            <label>Ti√™u ƒë·ªÅ</label>
            <input id="phTitle" placeholder="V√≠ d·ª•: ·∫¢nh t·ª´ ƒë∆∞·ªùng / ·∫£nh m·ªô t·ªï..." />
          </div>
          <div class="field">
            <label>G·∫Øn v·ªõi ng∆∞·ªùi</label>
            <select id="phPerson">${options}</select>
          </div>
          <div class="field">
            <label>Ghi ch√∫</label>
            <input id="phNote" placeholder="NƒÉm ch·ª•p, ƒë·ªãa ƒëi·ªÉm..." />
          </div>
          <div class="row">
            <button class="btn good" id="btnSavePhoto">L∆∞u ·∫£nh</button>
          </div>
          <div class="muted small">·∫¢nh s·∫Ω n√©n (1024px) ƒë·ªÉ nh·∫π m√°y.</div>
        </div>
      `);
      $("#btnSavePhoto").addEventListener("click", async ()=>{
        const f = $("#phFile").files?.[0];
        if(!f) return toast("Ch∆∞a ch·ªçn ·∫£nh");
        const data = await compressToDataUrl(f, 1024, 0.82);
        addPhoto({
          title: ($("#phTitle").value||"").trim(),
          person_id: $("#phPerson").value || null,
          note: ($("#phNote").value||"").trim(),
          data
        });
        toast("ƒê√£ l∆∞u ·∫£nh");
        closeModal();
        renderPhotos(); updateStats(); save();
        goTab("photos");
      });
    }

    // ====== tree ======
    function buildTree(rootId){
      if(!rootId) return toast("Ch∆∞a c√≥ g·ªëc");
      const children = {};
      state.people.forEach(p=>children[p.id]=[]);
      // parent: A->B ; child: B->A
      state.relations.forEach(r=>{
        if(r.type==="parent") children[r.a]?.push(r.b);
        if(r.type==="child") children[r.b]?.push(r.a);
      });

      // levels BFS
      const levels = [];
      const seen = new Set();
      let q=[rootId]; seen.add(rootId);
      for(let depth=0; depth<9 && q.length; depth++){
        levels.push(q.slice());
        const next=[];
        q.forEach(id=>{
          (children[id]||[]).forEach(cid=>{
            if(!seen.has(cid)){ seen.add(cid); next.push(cid); }
          });
        });
        q=next;
      }

      const mode = state.settings.treeMode || "compact";
      const nodeW = mode==="wide" ? 220 : 170;
      const nodeH = 56;
      const gapX = mode==="wide" ? 34 : 26;
      const gapY = 46;
      const pad  = 20;

      const maxCols = Math.max(...levels.map(l=>l.length));
      const svgW = pad*2 + maxCols*(nodeW+gapX);
      const svgH = pad*2 + levels.length*(nodeH+gapY);
      const pos = {};

      levels.forEach((lvl,i)=>{
        const rowW = lvl.length*(nodeW+gapX) - gapX;
        const startX = pad + (svgW - pad*2 - rowW)/2;
        lvl.forEach((id,j)=>{
          pos[id] = { x: startX + j*(nodeW+gapX), y: pad + i*(nodeH+gapY) };
        });
      });

      const lines = [];
      state.relations.forEach(r=>{
        let parent=null, child=null;
        if(r.type==="parent"){ parent=r.a; child=r.b; }
        if(r.type==="child"){ parent=r.b; child=r.a; }
        if(parent && child && pos[parent] && pos[child]){
          const p1=pos[parent], p2=pos[child];
          lines.push(`<line x1="${p1.x+nodeW/2}" y1="${p1.y+nodeH}" x2="${p2.x+nodeW/2}" y2="${p2.y}" stroke="rgba(255,255,255,.22)" stroke-width="2"/>`);
        }
      });

      const nodes = Object.keys(pos).map(id=>{
        const p = state.people.find(x=>x.id===id);
        const {x,y}=pos[id];
        const name = escapeHtml(p.full_name||"(kh√¥ng t√™n)");
        const role = p.display_role ? ` ‚Ä¢ ${escapeHtml(p.display_role)}` : "";
        const gender = escapeHtml(p.gender||"");
        return `
          <g style="cursor:pointer" data-id="${id}">
            <rect x="${x}" y="${y}" rx="16" ry="16" width="${nodeW}" height="${nodeH}" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.16)"/>
            <text x="${x+12}" y="${y+24}" fill="white" font-size="13" font-weight="900">${name}</text>
            <text x="${x+12}" y="${y+44}" fill="rgba(255,255,255,.72)" font-size="11">${gender}${role}</text>
          </g>`;
      }).join("");

      $("#treeBox").innerHTML = `
        <div class="muted small" style="margin-bottom:10px">Ch·∫°m v√†o node ƒë·ªÉ xem th√¥ng tin.</div>
        <svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}">
          ${lines.join("")}
          ${nodes}
        </svg>
      `;

      // click node open view
      $("#treeBox").querySelector("svg").addEventListener("click",(e)=>{
        const g = e.target.closest("g[data-id]");
        if(!g) return;
        const id = g.getAttribute("data-id");
        const person = state.people.find(x=>x.id===id);
        if(person) openPerson(person, false);
      });
    }

    function countBranches(){
      // naive: count unique "display_role" prefixes or parent roots
      // We'll compute number of top-level roots (no parent)
      const hasParent = new Set();
      state.relations.forEach(r=>{
        if(r.type==="parent") hasParent.add(r.b);
        if(r.type==="child") hasParent.add(r.a);
      });
      const roots = state.people.filter(p=> !hasParent.has(p.id));
      return roots.length || 0;
    }

    // ====== modal ======
    function showModal(title, html){
      $("#mTitle").textContent = title;
      $("#mBody").innerHTML = html;
      show("#modal", true);
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
    }
    function closeModal(){ show("#modal", false); $("#mBody").innerHTML = ""; }
    $("#mClose").addEventListener("click", closeModal);

    // ====== export/import/reset ======
    function exportJson(){
      const pack = {
        ...state,
        exported_at: nowISO(),
        app: "Gia ph·∫£ h·ªç B√πi ‚Ä¢ PWA(Local)",
        author: "B√πi H√†o"
      };
      const blob = new Blob([JSON.stringify(pack, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `giapha_ho_bui_local.json`;
      a.click();
      toast("ƒê√£ export");
    }

    function importJson(){
      showModal("Import JSON", `
        <div class="muted small">Ch·ªçn file JSON export tr∆∞·ªõc ƒë√≥. Import s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu local hi·ªán t·∫°i.</div>
        <input type="file" id="jsonFile" accept="application/json" />
        <div class="row" style="margin-top:10px">
          <button class="btn warn" id="btnDoImport">Import (ghi ƒë√®)</button>
        </div>
      `);
      $("#btnDoImport").addEventListener("click", async ()=>{
        const f = $("#jsonFile").files?.[0];
        if(!f) return toast("Ch∆∞a ch·ªçn file");
        try{
          const txt = await f.text();
          const data = JSON.parse(txt);
          // minimal validation
          if(!data || typeof data!=="object" || !Array.isArray(data.people)) return toast("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng");
          state = {
            family: data.family || state.family,
            people: data.people || [],
            relations: data.relations || [],
            events: data.events || [],
            notes: data.notes || state.notes,
            photos: data.photos || [],
            settings: data.settings || state.settings
          };
          toast("Import OK");
          closeModal();
          refreshHeader();
          goTab("dashboard");
        }catch(e){
          toast("L·ªói import");
        }
      });
    }

    function resetAll(){
      if(!confirm("Reset to√†n b·ªô d·ªØ li·ªáu local?")) return;
      localStorage.removeItem(KEY);
      state = {
        family: { name:"", address:"", desc:"", created_at: nowISO(), updated_at: nowISO() },
        people: [],
        relations: [],
        events: [],
        notes: { phaky:{title:"", content:"", updated_at:null}, tuduong:{title:"", content:"", updated_at:null} },
        photos: [],
        settings: { treeMode:"compact", eventSort:"desc" }
      };
      toast("ƒê√£ reset");
      refreshHeader();
      goTab("dashboard");
    }

    // ====== QR share ======
    // Minimal QR generator (alphanumeric / URL) using a tiny implementation (not perfect but works well for URLs).
    // For reliability, we encode as "Q" with simple QR-Like grid via an online API fallback if canvas fails.
    function openQR(){
      const link = location.href;
      // render QR using public API (simple, stable) without extra libs:
      // (If you want zero external requests, tell me; m√¨nh s·∫Ω nh√∫ng QR thu·∫ßn JS m·∫°nh h∆°n.)
      const img = `https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${encodeURIComponent(link)}`;
      showModal("M√£ QR v√†o app", `
        <div class="muted small">Qu√©t l√† m·ªü ƒë√∫ng link app n√†y:</div>
        <div class="sep"></div>
        <div class="qrBox">
          <img src="${img}" alt="QR" style="width:260px;height:260px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:#fff">
          <div class="sep"></div>
          <div class="mono small" style="word-break:break-all;opacity:.85">${escapeHtml(link)}</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCopyLink">Copy link</button>
          </div>
        </div>
      `);
      $("#btnCopyLink").addEventListener("click", ()=>{
        navigator.clipboard?.writeText(link).then(()=>toast("ƒê√£ copy link")).catch(()=>toast("Kh√¥ng copy ƒë∆∞·ª£c"));
      });
    }

    // ====== image compress to dataURL ======
    async function compressToDataUrl(file, maxSize=1024, quality=0.82){
      const img = await new Promise((res, rej)=>{
        const i = new Image();
        i.onload=()=>res(i); i.onerror=rej;
        i.src = URL.createObjectURL(file);
      });
      const w=img.width, h=img.height;
      const scale = Math.min(1, maxSize / Math.max(w,h));
      const nw=Math.round(w*scale), nh=Math.round(h*scale);
      const canvas=document.createElement("canvas");
      canvas.width=nw; canvas.height=nh;
      const ctx=canvas.getContext("2d");
      ctx.drawImage(img,0,0,nw,nh);
      return canvas.toDataURL("image/jpeg", quality);
    }

    // ====== wires ======
    $("#btnAddPersonQuick").addEventListener("click", ()=> openPerson({}, true));
    $("#btnAddPerson").addEventListener("click", ()=> openPerson({}, true));

    $("#btnAddRelQuick").addEventListener("click", ()=> { goTab("relations"); openRelationEditor(null); });
    $("#btnAddRelation").addEventListener("click", ()=> openRelationEditor(null));
    $("#btnRelCheck").addEventListener("click", checkRelations);

    $("#btnAddEventQuick").addEventListener("click", ()=> { goTab("events"); openEvent(null); });
    $("#btnAddEvent").addEventListener("click", ()=> openEvent(null));

    $("#btnAddPhotoQuick").addEventListener("click", openAddPhoto);
    $("#btnAddPhoto").addEventListener("click", openAddPhoto);
    $("#btnClearPhotos").addEventListener("click", ()=>{
      if(!confirm("X√≥a to√†n b·ªô ·∫£nh local?")) return;
      state.photos = [];
      toast("ƒê√£ x√≥a ·∫£nh");
      renderPhotos(); updateStats(); save();
    });

    $("#btnBuildTree").addEventListener("click", ()=> buildTree($("#rootSelect").value));
    $("#btnTreeMode").addEventListener("click", ()=>{
      state.settings.treeMode = (state.settings.treeMode==="compact") ? "wide" : "compact";
      $("#btnTreeMode").textContent = "Ch·∫ø ƒë·ªô: " + (state.settings.treeMode==="compact" ? "G·ªçn" : "R·ªông");
      toast("ƒê√£ ƒë·ªïi ch·∫ø ƒë·ªô c√¢y");
      save();
    });

    $("#btnSortEvents").addEventListener("click", ()=>{
      state.settings.eventSort = (state.settings.eventSort==="desc") ? "asc" : "desc";
      $("#btnSortEvents").textContent = "S·∫Øp x·∫øp: " + (state.settings.eventSort==="desc" ? "M·ªõi ‚Üí C≈©" : "C≈© ‚Üí M·ªõi");
      renderEvents(); save();
    });

    $("#btnNotePhaky").addEventListener("click", ()=> openNote("phaky"));
    $("#btnNoteTuduong").addEventListener("click", ()=> openNote("tuduong"));
    $("#btnSaveNote").addEventListener("click", saveNote);
    $("#btnPrintNote").addEventListener("click", printNote);
    $("#btnOpenPhaky").addEventListener("click", ()=> openNote("phaky"));
    $("#btnOpenTuduong").addEventListener("click", ()=> openNote("tuduong"));

    $("#btnSearch").addEventListener("click", ()=>{
      const key = ($("#q").value||"").trim().toLowerCase();
      if(!key) return toast("Nh·∫≠p t·ª´ kh√≥a");
      $("#q2").value = $("#q").value;
      goTab("people");
      doSearch(key);
    });
    $("#btnSearch2").addEventListener("click", ()=>{
      const key = ($("#q2").value||"").trim().toLowerCase();
      if(!key) return renderPeople(state.people);
      doSearch(key);
    });

    function doSearch(key){
      const arr = state.people.filter(p=>{
        return (p.full_name||"").toLowerCase().includes(key)
          || String(p.birth_year||"").includes(key)
          || (p.hometown_province||"").toLowerCase().includes(key)
          || (p.current_address||"").toLowerCase().includes(key)
          || (p.display_role||"").toLowerCase().includes(key);
      });
      renderPeople(arr);
      toast(`T√¨m th·∫•y ${arr.length}`);
    }

    $("#btnExport").addEventListener("click", exportJson);
    $("#btnImport").addEventListener("click", importJson);
    $("#btnReset").addEventListener("click", resetAll);

    $("#btnQR").addEventListener("click", openQR);
    $("#btnOpenQR2").addEventListener("click", openQR);

    // ====== start ======
    refreshHeader();
    // default note open label
    $("#noteKind").textContent = "Ph·∫£ k√Ω";
    $("#btnTreeMode").textContent = "Ch·∫ø ƒë·ªô: " + (state.settings.treeMode==="compact" ? "G·ªçn" : "R·ªông");
    $("#btnSortEvents").textContent = "S·∫Øp x·∫øp: " + (state.settings.eventSort==="desc" ? "M·ªõi ‚Üí C≈©" : "C≈© ‚Üí M·ªõi");
  </script>
</body>
</html>
