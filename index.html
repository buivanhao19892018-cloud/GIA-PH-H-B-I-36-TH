<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Gia ph·∫£ h·ªç B√πi ‚Ä¢ PWA ‚Ä¢ B√πi H√†o</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#07101d; --panel:#0b1730; --panel2:#0a1427;
      --text:#e8f0ff; --muted:#a8b7d6; --line:rgba(255,255,255,.10);
      --accent:#4f8cff; --ok:#32d583; --warn:#fdb022; --bad:#f97066;
      --r:18px; --shadow: 0 14px 36px rgba(0,0,0,.42);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(79,140,255,.22), transparent 60%),
        radial-gradient(1000px 600px at 100% 10%, rgba(50,213,131,.12), transparent 55%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      padding:12px;
      background: rgba(7,16,29,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .left{display:flex; align-items:center; gap:10px; min-width:0;}
    .hamb{
      width:42px; height:42px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text); cursor:pointer;
      display:grid; place-items:center;
    }
    .brand{display:flex; flex-direction:column; min-width:0;}
    .brand .t{font-weight:1000; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .brand .s{color:var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .btn{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text); cursor:pointer; font-size:13px;
    }
    .btn.primary{background: rgba(50,213,131,.15); border-color: rgba(50,213,131,.26);}
    .btn.warn{background: rgba(253,176,34,.14); border-color: rgba(253,176,34,.24);}
    .btn.bad{background: rgba(249,112,102,.12); border-color: rgba(249,112,102,.24); color:#ffe8e6;}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 12px 110px;}
    .page-title{display:flex;gap:10px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin:10px 2px 12px}
    .page-title h2{margin:0;font-size:18px;font-weight:1000}
    .page-title .hint{color:var(--muted);font-size:13px;line-height:1.4;margin-top:4px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:999px;
      background: rgba(18,38,75,.72);
      border:1px solid rgba(255,255,255,.10);
    }
    .chip.ok{color:#d9ffef;border-color:rgba(50,213,131,.24);background: rgba(50,213,131,.12)}
    .chip.warn{color:#fff1d6;border-color:rgba(253,176,34,.26);background: rgba(253,176,34,.12)}
    .chip.bad{color:#ffe8e6;border-color:rgba(249,112,102,.24);background: rgba(249,112,102,.10)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid.two{grid-template-columns:1.15fr .85fr}}
    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(11,23,48,.58);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;
    }
    .card .hd .h{font-weight:1000;font-size:14px}
    .card .hd .s{color:var(--muted);font-size:12px;margin-top:4px}
    .card .bd{padding:14px}
    .notice{
      padding:12px 12px;border-radius:16px;
      border:1px solid rgba(79,140,255,.22);
      background: rgba(79,140,255,.10);
      color:#dfe9ff; line-height:1.6; font-size:13px;
    }
    .notice.danger{border-color:rgba(249,112,102,.22); background: rgba(249,112,102,.10); color:#ffe8e6;}
    .muted{color:var(--muted)}
    .sep{height:1px;background: rgba(255,255,255,.08);margin:12px 0}

    /* Drawer */
    .backdrop{
      position:fixed;inset:0;z-index:80;
      background: rgba(0,0,0,.55);
      opacity:0;pointer-events:none;transition:.18s ease;
    }
    .backdrop.show{opacity:1;pointer-events:auto}
    .drawer{
      position:fixed;top:0;left:0;bottom:0;z-index:90;
      width:min(360px,92vw);
      transform: translateX(-102%); transition:.2s ease;
      padding:14px;
      background: linear-gradient(180deg, rgba(11,23,48,.95), rgba(7,16,29,.92));
      border-right:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: 20px 0 60px rgba(0,0,0,.45);
    }
    .drawer.show{transform: translateX(0)}
    .brandbox{
      display:flex; gap:12px; align-items:center;
      padding:14px 12px;border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(10,20,39,.55);
    }
    .logo{
      width:46px;height:46px;border-radius:16px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(79,140,255,.45), rgba(18,38,75,.9));
      border:1px solid rgba(255,255,255,.10);
      font-weight:1000;
    }
    .iconbtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text); cursor:pointer;
      display:grid;place-items:center;
    }
    .search{
      margin-top:12px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,20,39,.55);
      display:flex;gap:10px;align-items:center;
    }
    .search input{width:100%;border:0;outline:none;background:transparent;color:var(--text);font-size:13px}
    .mtitle{color:var(--muted);font-size:11px;letter-spacing:.12em;text-transform:uppercase;margin:12px 6px 6px}
    .menu{margin-top:12px;display:flex;flex-direction:column;gap:8px}
    .item{
      display:flex;gap:10px;align-items:center;
      padding:11px 12px;border-radius:16px;
      border:1px solid transparent;background:transparent;
      cursor:pointer;user-select:none;
    }
    .item:hover{background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.06)}
    .item.active{background: rgba(79,140,255,.20); border-color: rgba(79,140,255,.28)}
    .ico{
      width:30px;height:30px;border-radius:12px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-size:14px; flex:0 0 auto;
    }
    .badge{
      margin-left:auto;
      font-size:11px;color:var(--muted);
      padding:3px 8px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .foot{
      position:absolute;left:14px;right:14px;bottom:14px;
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:12px;
      color:var(--muted);font-size:12px;line-height:1.5;
    }

    /* Lists */
    .list{display:flex;flex-direction:column;gap:10px}
    .row{
      display:flex;gap:12px;align-items:center;
      padding:10px 12px;border:1px solid rgba(255,255,255,.08);
      border-radius:16px;background: rgba(10,20,39,.55);
    }
    .avatar{
      width:42px;height:42px;border-radius:16px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-weight:1000; flex:0 0 auto;
    }
    .meta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .meta .name{font-weight:1000;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{margin-left:auto;display:flex;gap:8px;flex:0 0 auto}

    /* Forms */
    .form{display:grid;gap:10px}
    .fgrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.fgrid.two{grid-template-columns:1fr 1fr}.fgrid.three{grid-template-columns:1fr 1fr 1fr}}
    .frow{display:grid;gap:8px}
    .frow label{font-size:12px;color:var(--muted)}
    .frow input,.frow select,.frow textarea{
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,20,39,.55);
      color:var(--text); outline:none;
    }
    .frow textarea{min-height:90px;resize:vertical}

    /* Tree */
    .treeWrap{
      height:560px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(circle at 20% 20%, rgba(79,140,255,.12), transparent 55%),
        radial-gradient(circle at 80% 40%, rgba(50,213,131,.09), transparent 55%),
        rgba(10,20,39,.42);
      overflow:hidden;
      position:relative;
      touch-action:none;
    }
    .treeHud{
      position:absolute;left:12px;top:12px;z-index:2;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .tiny{
      padding:8px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,16,29,.55);
      backdrop-filter: blur(8px);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
    }
    .tiny.muted{color:var(--muted)}
    svg{display:block; width:100%; height:100%;}
    .node{
      cursor:pointer;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .node rect{
      fill: rgba(11,23,48,.92);
      stroke: rgba(255,255,255,.14);
      stroke-width:1;
      rx:14; ry:14;
    }
    .node .title{font-weight:900; font-size:12px; fill: #e8f0ff}
    .node .sub{font-size:10.5px; fill: #a8b7d6}
    .edge{
      stroke: rgba(255,255,255,.20);
      stroke-width: 2;
      fill: none;
    }
    .edge.spouse{stroke: rgba(79,140,255,.35); stroke-width: 2.5}
    .edge.parent{stroke: rgba(255,255,255,.22)}
    .hintLine{
      position:absolute; right:12px; top:12px; z-index:2;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,16,29,.55);
      backdrop-filter: blur(8px);
      color:var(--muted);
      font-size:12px;
      max-width: 60%;
    }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0; z-index:120;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.55);
      padding:12px;
    }
    .modalWrap.show{display:flex}
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,23,48,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhd{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .modal .mhd .ttl{font-weight:1000}
    .modal .mbd{padding:14px}
    .modal .mft{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }

    /* Bottom quick nav */
    .bottomnav{
      position:fixed;left:0;right:0;bottom:0;z-index:40;
      padding:10px 10px 14px;
      background: rgba(7,16,29,.72);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .bottomnav .bar{
      max-width:1200px;margin:0 auto;
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
    }
    .bitem{
      padding:10px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      cursor:pointer;
      display:flex;gap:8px;align-items:center;justify-content:center;
      font-size:12px;
    }
    .bitem.active{
      color:var(--text);
      border-color: rgba(79,140,255,.28);
      background: rgba(79,140,255,.16);
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="left">
      <button class="hamb" id="openDrawer" aria-label="M·ªü menu">‚ò∞</button>
      <div class="brand">
        <div class="t" id="appTitle">Gia ph·∫£ h·ªç B√πi</div>
        <div class="s" id="appSub">PWA ‚Ä¢ 1 file ‚Ä¢ T√°c gi·∫£: B√πi H√†o</div>
      </div>
    </div>
    <div class="right">
      <div class="pill" id="kpiMini">üë• 0 ‚Ä¢ üîó 0 ‚Ä¢ üìÖ 0</div>
      <button class="btn primary" id="quickAdd">+ Th√™m ng∆∞·ªùi</button>
      <button class="btn warn" id="quickExport">Export</button>
    </div>
  </div>
</header>

<div class="backdrop" id="backdrop"></div>

<aside class="drawer" id="drawer">
  <div class="brandbox">
    <div class="logo">B</div>
    <div style="min-width:0">
      <div style="font-weight:1000;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Gia ph·∫£ h·ªç B√πi</div>
      <div style="color:var(--muted);font-size:12px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">T√°c gi·∫£: B√πi H√†o</div>
    </div>
    <button class="iconbtn" id="closeDrawer" aria-label="ƒê√≥ng">‚úï</button>
  </div>

  <div class="search" title="T√¨m nhanh (l·ªçc danh s√°ch)">
    üîé <input id="qSearch" placeholder="T√¨m t√™n, nƒÉm sinh, qu√™ qu√°n, ƒë·ªùi, nh√°nh‚Ä¶" />
  </div>

  <div class="menu" id="menu">
    <div class="mtitle">T·ªïng quan</div>
    <div class="item active" data-page="dashboard"><div class="ico">üè†</div> B·∫£ng ƒëi·ªÅu khi·ªÉn <span class="badge">Home</span></div>
    <div class="item" data-page="tree"><div class="ico">üå≥</div> C√¢y gia ph·∫£ <span class="badge">SVG</span></div>
    <div class="item" data-page="members"><div class="ico">üë•</div> Th√†nh vi√™n <span class="badge">List</span></div>

    <div class="mtitle">Nh·∫≠p li·ªáu</div>
    <div class="item" data-page="add-person"><div class="ico">‚ûï</div> Th√™m ng∆∞·ªùi</div>
    <div class="item" data-page="add-relation"><div class="ico">üîó</div> Th√™m quan h·ªá</div>
    <div class="item" data-page="events"><div class="ico">üìÖ</div> S·ª± ki·ªán / M·ªëc</div>

    <div class="mtitle">Tra c·ª©u</div>
    <div class="item" data-page="kin"><div class="ico">üß≠</div> T√¨m h·ªç h√†ng</div>
    <div class="item" data-page="reports"><div class="ico">üßæ</div> B√°o c√°o ƒë·ªùi / chi h·ªç</div>

    <div class="mtitle">Sao l∆∞u & chia s·∫ª</div>
    <div class="item" data-page="backup"><div class="ico">üíæ</div> Import / Export</div>
    <div class="item" data-page="print"><div class="ico">üñ®Ô∏è</div> In / Xu·∫•t PDF</div>

    <div class="mtitle">C√†i ƒë·∫∑t</div>
    <div class="item" data-page="settings"><div class="ico">‚öôÔ∏è</div> C√†i ƒë·∫∑t</div>
    <div class="item" data-page="about"><div class="ico">‚ÑπÔ∏è</div> Gi·ªõi thi·ªáu</div>
  </div>

  <div class="foot">
    <div><b>M·∫πo:</b> Mobile b·∫•m menu ‚Üí n·ªôi dung ƒë·ªïi ngay.</div>
    <div style="margin-top:6px;">¬© <b>B√πi H√†o</b> ‚Ä¢ Gia ph·∫£ h·ªç B√πi</div>
  </div>
</aside>

<main class="wrap">
  <div class="page-title">
    <div>
      <h2 id="pageTitle">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
      <div class="hint" id="pageHint">T·ªïng quan h·ªá th·ªëng, th·ªëng k√™ nhanh, ng∆∞·ªùi m·ªõi th√™m.</div>
    </div>
    <div class="chips" id="pageChips"></div>
  </div>
  <div id="pageBody"></div>
</main>

<div class="bottomnav">
  <div class="bar" id="bottomBar">
    <div class="bitem active" data-page="dashboard">üè† Home</div>
    <div class="bitem" data-page="tree">üå≥ C√¢y</div>
    <div class="bitem" data-page="members">üë• DS</div>
    <div class="bitem" data-page="backup">üíæ Sao l∆∞u</div>
  </div>
</div>

<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="mhd">
      <div class="ttl" id="modalTitle">H·ªì s∆°</div>
      <button class="iconbtn" id="modalClose" aria-label="ƒê√≥ng">‚úï</button>
    </div>
    <div class="mbd" id="modalBody"></div>
    <div class="mft" id="modalFoot"></div>
  </div>
</div>

<script>
/* =========================
   B1: DATA + STORAGE (REAL)
   ========================= */
const LS_KEY = "bui_giapha_full_v1";
const now = () => Date.now();
const todayISO = () => new Date().toISOString().slice(0,10);
const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+Date.now()));
const esc = (s="") => (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
const initials2 = (name="")=>{
  const parts = (name||"").trim().split(/\s+/).filter(Boolean);
  const last = parts.slice(-1)[0]||"";
  const first = parts[0]||"";
  return (first[0]||"").toUpperCase() + (last[0]||"").toUpperCase();
};

function loadDB(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

function seedIfEmpty(){
  let db = loadDB();
  if(db && db.persons && db.relationships && db.events) return db;

  // Seed demo minimal (H·ªç B√πi) ‚Äî H√†o c√≥ th·ªÉ x√≥a/reset sau
  const pHao = { id: uid(), full_name:"B√πi H√†o", gender:"M", alive:true, dob:"", dod:"",
    birthplace:"Thanh H√≥a", hometown:"Thanh H√≥a", branch:"H·ªç B√πi", generation:0, notes:"T√°c gi·∫£ / qu·∫£n tr·ªã", created_at: now() };
  const pA = { id: uid(), full_name:"B√πi VƒÉn B√¨nh", gender:"M", alive:true, dob:"", dod:"",
    birthplace:"Th·∫°ch C·∫©m", hometown:"Thanh H√≥a", branch:"H·ªç B√πi", generation:1, notes:"(demo)", created_at: now() };
  const pB = { id: uid(), full_name:"B√πi Th·ªã Lan", gender:"F", alive:true, dob:"", dod:"",
    birthplace:"Kim T√¢n", hometown:"Thanh H√≥a", branch:"H·ªç B√πi", generation:1, notes:"(demo)", created_at: now() };
  const pC = { id: uid(), full_name:"B√πi VƒÉn Nam", gender:"M", alive:true, dob:"", dod:"",
    birthplace:"Thanh H√≥a", hometown:"Thanh H√≥a", branch:"Chi 1", generation:2, notes:"(demo con)", created_at: now() };

  db = {
    meta: { family_name:"Gia ph·∫£ h·ªç B√πi", author:"B√πi H√†o", created: now(), version:"4.0-web-pwa" },
    persons: [pHao,pA,pB,pC],
    relationships: [
      { id: uid(), type:"SPOUSE_OF", a:pA.id, b:pB.id, start_date:"", end_date:"", note:"(demo)", created_at: now() },
      { id: uid(), type:"PARENT_OF", a:pA.id, b:pC.id, start_date:"", end_date:"", note:"", created_at: now() },
      { id: uid(), type:"PARENT_OF", a:pB.id, b:pC.id, start_date:"", end_date:"", note:"", created_at: now() },
    ],
    events: [
      { id: uid(), title:"Kh·ªüi t·∫°o gia ph·∫£", type:"OTHER", date: todayISO(), person_id:pHao.id, note:"B·∫Øt ƒë·∫ßu nh·∫≠p li·ªáu.", created_at: now() }
    ],
    settings: { allow_delete:true }
  };
  saveDB(db);
  return db;
}

let DB = seedIfEmpty();

const getPerson = (id)=> DB.persons.find(p=>p.id===id);
const parentsOf = (childId)=> DB.relationships.filter(r=>r.type==="PARENT_OF" && r.b===childId).map(r=>getPerson(r.a)).filter(Boolean);
const childrenOf = (parentId)=> DB.relationships.filter(r=>r.type==="PARENT_OF" && r.a===parentId).map(r=>getPerson(r.b)).filter(Boolean);
const spousesOf = (id)=> DB.relationships
  .filter(r=>r.type==="SPOUSE_OF" && (r.a===id || r.b===id))
  .map(r=>getPerson(r.a===id? r.b : r.a)).filter(Boolean);
const relsOf = (id)=> DB.relationships.filter(r=>r.a===id || r.b===id);

function refreshKPI(){
  const persons = DB.persons.length, rels = DB.relationships.length, evs = DB.events.length;
  document.getElementById("kpiMini").textContent = `üë• ${persons} ‚Ä¢ üîó ${rels} ‚Ä¢ üìÖ ${evs}`;
  document.getElementById("appTitle").textContent = DB.meta?.family_name || "Gia ph·∫£ h·ªç B√πi";
  document.getElementById("appSub").textContent = `PWA ‚Ä¢ 1 file ‚Ä¢ T√°c gi·∫£: ${DB.meta?.author || "B√πi H√†o"}`;
}

function updatePerson(id, patch){
  const idx = DB.persons.findIndex(p=>p.id===id);
  if(idx<0) return;
  DB.persons[idx] = { ...DB.persons[idx], ...patch };
  saveDB(DB); refreshKPI();
}
function addPerson(p){
  DB.persons.unshift(p);
  saveDB(DB); refreshKPI();
}
function deletePerson(id){
  DB.persons = DB.persons.filter(p=>p.id!==id);
  DB.relationships = DB.relationships.filter(r=>r.a!==id && r.b!==id);
  DB.events = DB.events.filter(e=>e.person_id!==id);
  saveDB(DB); refreshKPI();
}

function isAncestor(ancestorId, targetId){
  // DFS ancestor -> children; if reaches target => cycle
  const seen = new Set();
  const stack = [ancestorId];
  while(stack.length){
    const cur = stack.pop();
    if(cur===targetId) return true;
    if(seen.has(cur)) continue;
    seen.add(cur);
    const kids = DB.relationships.filter(r=>r.type==="PARENT_OF" && r.a===cur).map(r=>r.b);
    kids.forEach(k=>{ if(!seen.has(k)) stack.push(k); });
  }
  return false;
}

function addRelationship(r){
  if(r.a===r.b) return {ok:false,msg:"Kh√¥ng th·ªÉ li√™n k·∫øt 1 ng∆∞·ªùi v·ªõi ch√≠nh h·ªç."};
  if(r.type==="PARENT_OF"){
    if(isAncestor(r.b, r.a)) return {ok:false,msg:"L·ªói v√≤ng l·∫∑p: con kh√¥ng th·ªÉ l√† t·ªï ti√™n c·ªßa cha/m·∫π."};
  }else if(r.type==="SPOUSE_OF"){
    // prevent dup spouse
    const dup = DB.relationships.some(x => x.type==="SPOUSE_OF" && (
      (x.a===r.a && x.b===r.b) || (x.a===r.b && x.b===r.a)
    ));
    if(dup) return {ok:false,msg:"Quan h·ªá v·ª£/ch·ªìng ƒë√£ t·ªìn t·∫°i."};
  }
  DB.relationships.unshift(r);
  saveDB(DB); refreshKPI();
  return {ok:true};
}
function deleteRelationship(id){
  DB.relationships = DB.relationships.filter(r=>r.id!==id);
  saveDB(DB); refreshKPI();
}

function addEvent(e){ DB.events.unshift(e); saveDB(DB); refreshKPI(); }
function deleteEvent(id){ DB.events = DB.events.filter(e=>e.id!==id); saveDB(DB); refreshKPI(); }

/* =========================
   B3: KINSHIP BFS (PRO)
   ========================= */
function computeKinship(aId, bId){
  if(aId===bId) return { ok:true, text:"C√πng m·ªôt ng∆∞·ªùi", path:[aId], steps:[] };

  const adj = new Map();
  const addEdge = (u,v,label)=>{
    if(!adj.has(u)) adj.set(u, []);
    adj.get(u).push({to:v,label});
  };
  DB.relationships.forEach(r=>{
    if(r.type==="PARENT_OF"){
      addEdge(r.a, r.b, "cha/m·∫π ‚Üí con");
      addEdge(r.b, r.a, "con ‚Üí cha/m·∫π");
    }else if(r.type==="SPOUSE_OF"){
      addEdge(r.a, r.b, "v·ª£/ch·ªìng");
      addEdge(r.b, r.a, "v·ª£/ch·ªìng");
    }else{
      addEdge(r.a, r.b, r.type);
      addEdge(r.b, r.a, r.type);
    }
  });

  const q=[aId];
  const prev=new Map();
  prev.set(aId,null);

  while(q.length){
    const u=q.shift();
    for(const e of (adj.get(u)||[])){
      if(prev.has(e.to)) continue;
      prev.set(e.to,{p:u,label:e.label});
      if(e.to===bId){
        // reconstruct
        const nodes=[]; const labels=[];
        let cur=bId;
        while(cur!==null){
          nodes.push(cur);
          const pr=prev.get(cur);
          if(pr && pr.label) labels.push(pr.label);
          cur = pr ? pr.p : null;
        }
        nodes.reverse(); labels.reverse();
        return {ok:true, text: guessKinTitle(labels), path:nodes, steps:labels};
      }
      q.push(e.to);
    }
  }
  return {ok:false, text:"Ch∆∞a t√¨m th·∫•y ƒë∆∞·ªùng li√™n k·∫øt. H√£y th√™m quan h·ªá cha/m·∫π ho·∫∑c h√¥n nh√¢n tr∆∞·ªõc.", path:[], steps:[]};
}

function guessKinTitle(labels){
  // heuristic ƒë∆°n gi·∫£n (ƒë·ªß d√πng), H√†o mu·ªën chi ti·∫øt h∆°n m√¨nh n√¢ng c·∫•p ti·∫øp
  if(labels.length===1){
    if(labels[0]==="v·ª£/ch·ªìng") return "Quan h·ªá: V·ª£/Ch·ªìng";
    if(labels[0]==="cha/m·∫π ‚Üí con") return "Quan h·ªá: Cha/M·∫π ‚Üí Con";
    if(labels[0]==="con ‚Üí cha/m·∫π") return "Quan h·ªá: Con ‚Üí Cha/M·∫π";
  }
  if(labels.length===2){
    if(labels[0]==="con ‚Üí cha/m·∫π" && labels[1]==="cha/m·∫π ‚Üí con") return "Quan h·ªá: Anh/Ch·ªã/Em (c√πng cha/m·∫π)";
    if(labels[0]==="con ‚Üí cha/m·∫π" && labels[1]==="con ‚Üí cha/m·∫π") return "Quan h·ªá: Ch√°u ‚Üî √îng/B√†";
    if(labels[0]==="cha/m·∫π ‚Üí con" && labels[1]==="cha/m·∫π ‚Üí con") return "Quan h·ªá: √îng/B√† ‚Üî Ch√°u";
  }
  return "Quan h·ªá: ƒê∆∞·ªùng li√™n k·∫øt h·ªç h√†ng";
}

/* =========================
   UI SHELL
   ========================= */
const drawer = document.getElementById("drawer");
const backdrop = document.getElementById("backdrop");
const openDrawerBtn = document.getElementById("openDrawer");
const closeDrawerBtn = document.getElementById("closeDrawer");
const menu = document.getElementById("menu");
const bottomBar = document.getElementById("bottomBar");
const pageTitle = document.getElementById("pageTitle");
const pageHint = document.getElementById("pageHint");
const pageChips = document.getElementById("pageChips");
const pageBody = document.getElementById("pageBody");
const qSearch = document.getElementById("qSearch");

function openDrawer(){ drawer.classList.add("show"); backdrop.classList.add("show"); }
function closeDrawer(){ drawer.classList.remove("show"); backdrop.classList.remove("show"); }
openDrawerBtn.onclick=openDrawer; closeDrawerBtn.onclick=closeDrawer; backdrop.onclick=closeDrawer;

function setActiveNav(page){
  [...menu.querySelectorAll(".item")].forEach(x=>x.classList.toggle("active", x.dataset.page===page));
  [...bottomBar.querySelectorAll(".bitem")].forEach(x=>x.classList.toggle("active", x.dataset.page===page));
}

function chip(text, kind=""){ return `<span class="chip ${kind}">${esc(text)}</span>`; }

function personRowHTML(p){
  const g = p.gender==="M"?"Nam":p.gender==="F"?"N·ªØ":"Kh√°c";
  const sub = `${g} ‚Ä¢ ƒê·ªùi ${p.generation??0} ‚Ä¢ Nh√°nh: ${p.branch||"H·ªç B√πi"} ‚Ä¢ Qu√™: ${p.hometown||"-"}`;
  return `
    <div class="row" data-person="${p.id}">
      <div class="avatar">${esc(initials2(p.full_name))}</div>
      <div class="meta">
        <div class="name">${esc(p.full_name)}</div>
        <div class="sub">${esc(sub)}</div>
      </div>
      <div class="actions">
        <button class="iconbtn" data-open="${p.id}" title="M·ªü h·ªì s∆°">üëÅÔ∏è</button>
        <button class="iconbtn" data-edit="${p.id}" title="S·ª≠a">‚úèÔ∏è</button>
      </div>
    </div>
  `;
}
function relRowHTML(r){
  const A=getPerson(r.a), B=getPerson(r.b);
  const typeLabel = r.type==="PARENT_OF" ? "Cha/M·∫π ‚Üí Con" : r.type==="SPOUSE_OF" ? "V·ª£/Ch·ªìng" : r.type;
  const line = `${A?A.full_name:"?"} ‚Äî ${typeLabel} ‚Äî ${B?B.full_name:"?"}`;
  const note = [r.start_date||"", r.end_date?("‚Üí "+r.end_date):"", r.note?("‚Ä¢ "+r.note):""].filter(Boolean).join(" ");
  return `
    <div class="row">
      <div class="avatar">üîó</div>
      <div class="meta">
        <div class="name">${esc(line)}</div>
        <div class="sub">${esc(note || "‚Äî")}</div>
      </div>
      <div class="actions">
        <button class="iconbtn" data-delrel="${r.id}" title="Xo√° quan h·ªá">üóëÔ∏è</button>
      </div>
    </div>
  `;
}
function eventRowHTML(e){
  const p = e.person_id ? getPerson(e.person_id) : null;
  const who = p ? `‚Ä¢ ${p.full_name}` : "‚Ä¢ S·ª± ki·ªán chung";
  return `
    <div class="row">
      <div class="avatar">üìÖ</div>
      <div class="meta">
        <div class="name">${esc(e.title)} <span class="muted">(${esc(e.type)})</span></div>
        <div class="sub">${esc(e.date||"-")} ${esc(who)}${e.note?(" ‚Ä¢ "+esc(e.note)):""}</div>
      </div>
      <div class="actions">
        ${p ? `<button class="iconbtn" data-openperson="${p.id}" title="M·ªü ng∆∞·ªùi">üë§</button>` : ``}
        <button class="iconbtn" data-delev="${e.id}" title="Xo√° s·ª± ki·ªán">üóëÔ∏è</button>
      </div>
    </div>
  `;
}

function bindPersonRowClicks(container){
  container.querySelectorAll("[data-open]").forEach(btn=> btn.onclick=()=>openPersonModal(btn.getAttribute("data-open")) );
  container.querySelectorAll("[data-edit]").forEach(btn=> btn.onclick=()=>page_add_person(btn.getAttribute("data-edit")) );
  container.querySelectorAll("[data-person]").forEach(row=>{
    row.onclick=(e)=>{ if(e.target.closest("button")) return; openPersonModal(row.getAttribute("data-person")); };
  });
}

/* =========================
   MODAL (VIEW/EDIT)
   ========================= */
const modalWrap=document.getElementById("modalWrap");
document.getElementById("modalClose").onclick=()=>modalWrap.classList.remove("show");
modalWrap.addEventListener("click",(e)=>{ if(e.target===modalWrap) modalWrap.classList.remove("show"); });

function showConfirm(title, text, onYes){
  modalWrap.classList.add("show");
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = `<div class="notice danger"><b>${esc(title)}</b><div style="margin-top:6px">${esc(text)}</div></div>`;
  const foot = document.getElementById("modalFoot");
  foot.innerHTML = `<button class="btn" id="cNo">Hu·ª∑</button><button class="btn bad" id="cYes">ƒê·ªìng √Ω</button>`;
  document.getElementById("cNo").onclick = ()=>modalWrap.classList.remove("show");
  document.getElementById("cYes").onclick = ()=>{ modalWrap.classList.remove("show"); onYes && onYes(); };
}

function openPersonModal(id){
  const p=getPerson(id);
  if(!p){ toast("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi."); return; }

  const parents=parentsOf(id);
  const kids=childrenOf(id);
  const spouses=spousesOf(id);
  const rels=relsOf(id).slice(0,20);
  const evs=DB.events.filter(e=>e.person_id===id).slice(0,20);

  document.getElementById("modalTitle").textContent = p.full_name;

  document.getElementById("modalBody").innerHTML = `
    <div class="chips">
      ${chip(p.gender==="M"?"Nam":p.gender==="F"?"N·ªØ":"Kh√°c")}
      ${chip(`ƒê·ªùi ${p.generation??0}`)}
      ${chip(p.alive?"C√≤n s·ªëng":"ƒê√£ m·∫•t", p.alive?"ok":"warn")}
      ${chip(p.branch||"H·ªç B√πi")}
    </div>
    <div class="sep"></div>
    <div class="notice">
      <b>Qu√™ qu√°n:</b> ${esc(p.hometown||"-")} ‚Ä¢ <b>N∆°i sinh:</b> ${esc(p.birthplace||"-")}<br/>
      <b>Ng√†y sinh:</b> ${esc(p.dob||"-")} ‚Ä¢ <b>Ng√†y m·∫•t:</b> ${esc(p.dod||"-")}<br/>
      ${p.notes ? `<div style="margin-top:8px;"><b>Ghi ch√∫:</b> ${esc(p.notes)}</div>` : ``}
    </div>

    <div class="sep"></div>
    <div class="notice">
      <b>Cha/M·∫π:</b> ${parents.length? parents.map(x=>esc(x.full_name)).join(", "):"‚Äî"}<br/>
      <b>V·ª£/Ch·ªìng:</b> ${spouses.length? spouses.map(x=>esc(x.full_name)).join(", "):"‚Äî"}<br/>
      <b>Con:</b> ${kids.length? kids.map(x=>esc(x.full_name)).join(", "):"‚Äî"}
    </div>

    <div class="sep"></div>
    <div class="card" style="box-shadow:none;background:rgba(10,20,39,.35);border-color:rgba(255,255,255,.08)">
      <div class="hd"><div><div class="h">Quan h·ªá (chi ti·∫øt)</div><div class="s">T·ªëi ƒëa 20</div></div></div>
      <div class="bd"><div class="list">
        ${rels.length? rels.map(r=>relRowHTML(r)).join("") : `<div class="notice">Ch∆∞a c√≥ quan h·ªá.</div>`}
      </div></div>
    </div>

    <div class="sep"></div>
    <div class="card" style="box-shadow:none;background:rgba(10,20,39,.35);border-color:rgba(255,255,255,.08)">
      <div class="hd"><div><div class="h">S·ª± ki·ªán g·∫Øn v·ªõi ng∆∞·ªùi</div><div class="s">T·ªëi ƒëa 20</div></div></div>
      <div class="bd"><div class="list">
        ${evs.length? evs.map(e=>eventRowHTML(e)).join("") : `<div class="notice">Ch∆∞a c√≥ s·ª± ki·ªán.</div>`}
      </div></div>
    </div>
  `;

  const foot=document.getElementById("modalFoot");
  foot.innerHTML = `
    <button class="btn" id="mEdit">‚úèÔ∏è S·ª≠a</button>
    <button class="btn" id="mRel">üîó Th√™m quan h·ªá</button>
    <button class="btn" id="mEv">üìÖ Th√™m s·ª± ki·ªán</button>
    ${DB.settings.allow_delete? `<button class="btn bad" id="mDel">üóëÔ∏è Xo√°</button>`:""}
  `;

  // bind delete rel/event inside modal
  document.getElementById("modalBody").querySelectorAll("[data-delrel]").forEach(btn=>{
    btn.onclick=()=>{
      if(!DB.settings.allow_delete) return toast("ƒêang t·∫Øt quy·ªÅn xo√°.");
      const rid=btn.getAttribute("data-delrel");
      showConfirm("Xo√° quan h·ªá?","B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° quan h·ªá n√†y?",()=>{
        deleteRelationship(rid); toast("ƒê√£ xo√°."); openPersonModal(id);
      });
    };
  });
  document.getElementById("modalBody").querySelectorAll("[data-delev]").forEach(btn=>{
    btn.onclick=()=>{
      if(!DB.settings.allow_delete) return toast("ƒêang t·∫Øt quy·ªÅn xo√°.");
      const eid=btn.getAttribute("data-delev");
      showConfirm("Xo√° s·ª± ki·ªán?","B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° s·ª± ki·ªán n√†y?",()=>{
        deleteEvent(eid); toast("ƒê√£ xo√°."); openPersonModal(id);
      });
    };
  });
  document.getElementById("modalBody").querySelectorAll("[data-openperson]").forEach(btn=>{
    btn.onclick=()=>{ const pid=btn.getAttribute("data-openperson"); if(pid) openPersonModal(pid); };
  });

  document.getElementById("mEdit").onclick=()=>{ modalWrap.classList.remove("show"); page_add_person(id); };
  document.getElementById("mRel").onclick=()=>{ modalWrap.classList.remove("show"); go("add-relation"); };
  document.getElementById("mEv").onclick=()=>{ modalWrap.classList.remove("show"); go("events"); };
  const del=document.getElementById("mDel");
  if(del){
    del.onclick=()=>{
      showConfirm("Xo√° ng∆∞·ªùi?","Xo√° s·∫Ω m·∫•t h·ªì s∆° + quan h·ªá + s·ª± ki·ªán li√™n quan.",()=>{
        deletePerson(id); toast("ƒê√£ xo√°."); modalWrap.classList.remove("show"); go("members");
      });
    };
  }

  modalWrap.classList.add("show");
}

/* =========================
   TOAST
   ========================= */
let toastTimer=null;
function toast(msg){
  clearTimeout(toastTimer);
  let el=document.getElementById("toast");
  if(!el){
    el=document.createElement("div");
    el.id="toast";
    el.style.position="fixed";
    el.style.left="12px"; el.style.right="12px"; el.style.bottom="88px";
    el.style.zIndex="200";
    el.style.padding="12px 14px";
    el.style.borderRadius="16px";
    el.style.border="1px solid rgba(255,255,255,.12)";
    el.style.background="rgba(11,23,48,.92)";
    el.style.backdropFilter="blur(10px)";
    el.style.boxShadow="0 16px 40px rgba(0,0,0,.5)";
    el.style.color="var(--text)";
    el.style.fontSize="13px";
    el.style.opacity="0";
    el.style.transform="translateY(8px)";
    el.style.transition=".18s ease";
    document.body.appendChild(el);
  }
  el.textContent=msg;
  requestAnimationFrame(()=>{ el.style.opacity="1"; el.style.transform="translateY(0)"; });
  toastTimer=setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(8px)"; }, 1800);
}

/* =========================
   B2: TREE SVG + ZOOM/PAN
   ========================= */
function buildGraph(){
  const persons = DB.persons.map(p=>({ ...p }));
  const idSet = new Set(persons.map(p=>p.id));

  const parentsMap = new Map(); // child -> parents[]
  const childrenMap = new Map(); // parent -> children[]
  const spouseMap = new Map(); // id -> spouse ids
  persons.forEach(p=>{
    parentsMap.set(p.id, []);
    childrenMap.set(p.id, []);
    spouseMap.set(p.id, []);
  });

  DB.relationships.forEach(r=>{
    if(!idSet.has(r.a) || !idSet.has(r.b)) return;
    if(r.type==="PARENT_OF"){
      parentsMap.get(r.b).push(r.a);
      childrenMap.get(r.a).push(r.b);
    }else if(r.type==="SPOUSE_OF"){
      spouseMap.get(r.a).push(r.b);
      spouseMap.get(r.b).push(r.a);
    }
  });

  return { persons, parentsMap, childrenMap, spouseMap };
}

function computeLevels(graph){
  // If generation field exists, use it as base; else compute by parent chain.
  const level = new Map();
  graph.persons.forEach(p=>{
    const g = Number.isFinite(p.generation) ? (p.generation??0) : 0;
    level.set(p.id, g);
  });

  // Relax based on parent->child (child = parent+1)
  for(let iter=0; iter<10; iter++){
    let changed=false;
    graph.persons.forEach(p=>{
      const parents = graph.parentsMap.get(p.id)||[];
      if(parents.length){
        const maxParent = Math.max(...parents.map(pid => level.get(pid) ?? 0));
        const want = maxParent + 1;
        if((level.get(p.id) ?? 0) < want){
          level.set(p.id, want);
          changed=true;
        }
      }
    });
    if(!changed) break;
  }
  return level;
}

function layoutTree(graph){
  const level = computeLevels(graph);
  const groups = new Map(); // level -> ids
  graph.persons.forEach(p=>{
    const lv = level.get(p.id) ?? 0;
    if(!groups.has(lv)) groups.set(lv, []);
    groups.get(lv).push(p.id);
  });

  // sort within level by name
  for(const [lv,arr] of groups.entries()){
    arr.sort((a,b)=> (getPerson(a)?.full_name||"").localeCompare(getPerson(b)?.full_name||"","vi"));
  }

  const levels = [...groups.keys()].sort((a,b)=>a-b);
  const nodeW = 190, nodeH = 60, gapX = 26, gapY = 90;

  // place nodes in rows
  const pos = new Map(); // id -> {x,y}
  let maxW=0;

  levels.forEach((lv, idx)=>{
    const ids = groups.get(lv);
    // keep spouses closer: simple pass to bubble pairs adjacent
    const used = new Set();
    const ordered = [];
    ids.forEach(id=>{
      if(used.has(id)) return;
      const spouses = (graph.spouseMap.get(id)||[]).filter(s=>ids.includes(s));
      if(spouses.length){
        // pick first spouse not used
        const sp = spouses.find(s=>!used.has(s));
        if(sp){
          ordered.push(id, sp);
          used.add(id); used.add(sp);
          return;
        }
      }
      ordered.push(id);
      used.add(id);
    });

    const rowW = ordered.length * nodeW + Math.max(0, ordered.length-1)*gapX;
    maxW = Math.max(maxW, rowW);
    let startX = 0; // we'll center later using viewbox offset, but store relative
    const y = idx * (nodeH + gapY);

    ordered.forEach((id, j)=>{
      const x = startX + j*(nodeW+gapX);
      pos.set(id, {x,y});
    });
  });

  const totalH = levels.length * (nodeH + gapY) + 80;
  const totalW = maxW + 80;

  return { pos, nodeW, nodeH, totalW, totalH, levels, level };
}

function renderTree(container){
  const graph = buildGraph();
  const { pos, nodeW, nodeH, totalW, totalH } = layoutTree(graph);

  // edges
  const edges = [];
  // spouse edges: draw between centers of spouse nodes if spouse is on same row
  DB.relationships.forEach(r=>{
    if(r.type==="SPOUSE_OF"){
      const a=pos.get(r.a), b=pos.get(r.b);
      if(!a || !b) return;
      // draw only once
      if(r.a > r.b) return;
      const ax=a.x+nodeW/2, ay=a.y+nodeH/2;
      const bx=b.x+nodeW/2, by=b.y+nodeH/2;
      edges.push({type:"spouse", x1:ax, y1:ay, x2:bx, y2:by});
    }
    if(r.type==="PARENT_OF"){
      const pa=pos.get(r.a), ch=pos.get(r.b);
      if(!pa || !ch) return;
      const x1=pa.x+nodeW/2, y1=pa.y+nodeH;
      const x2=ch.x+nodeW/2, y2=ch.y;
      // elbow path
      const midY = (y1 + y2)/2;
      edges.push({type:"parent", d:`M ${x1} ${y1} L ${x1} ${midY} L ${x2} ${midY} L ${x2} ${y2}`});
    }
  });

  // center content
  const vb = `0 0 ${Math.max(800,totalW)} ${Math.max(600,totalH)}`;

  container.innerHTML = `
    <div class="treeWrap" id="treeWrap">
      <div class="treeHud">
        <button class="tiny" id="zIn">Ôºã</button>
        <button class="tiny" id="zOut">Ôºç</button>
        <button class="tiny muted" id="zReset">Reset</button>
        <button class="tiny" id="treeHint">H∆∞·ªõng d·∫´n</button>
      </div>
      <div class="hintLine" id="hintLine">Ch·∫°m & k√©o ƒë·ªÉ pan ‚Ä¢ Ch·ª•m 2 ng√≥n ƒë·ªÉ zoom (ho·∫∑c +/‚àí) ‚Ä¢ Ch·∫°m v√†o node ƒë·ªÉ m·ªü h·ªì s∆°</div>
      <svg id="treeSvg" viewBox="${vb}" aria-label="C√¢y gia ph·∫£ SVG">
        <g id="viewport">
          ${edges.map(e=>{
            if(e.type==="spouse"){
              return `<line class="edge spouse" x1="${e.x1}" y1="${e.y1}" x2="${e.x2}" y2="${e.y2}"></line>`;
            }else{
              return `<path class="edge parent" d="${e.d}"></path>`;
            }
          }).join("")}

          ${DB.persons.map(p=>{
            const p0=pos.get(p.id); if(!p0) return "";
            const x=p0.x+40, y=p0.y+40; // margin
            const g = p.gender==="M"?"Nam":p.gender==="F"?"N·ªØ":"Kh√°c";
            const sub = `${g} ‚Ä¢ ƒê·ªùi ${p.generation??0} ‚Ä¢ ${p.branch||"H·ªç B√πi"}`;
            return `
              <g class="node" data-id="${p.id}" transform="translate(${x},${y})">
                <rect width="${nodeW}" height="${nodeH}"></rect>
                <text class="title" x="12" y="24">${esc(p.full_name).slice(0,24)}</text>
                <text class="sub" x="12" y="44">${esc(sub).slice(0,32)}</text>
              </g>
            `;
          }).join("")}
        </g>
      </svg>
    </div>
  `;

  // Bind node click
  container.querySelectorAll(".node").forEach(n=>{
    n.addEventListener("click", (e)=>{
      e.stopPropagation();
      const id=n.getAttribute("data-id");
      if(id) openPersonModal(id);
    });
  });

  // Zoom/pan (pointer)
  const wrap = container.querySelector("#treeWrap");
  const svg = container.querySelector("#treeSvg");
  const vp = container.querySelector("#viewport");
  const hintLine = container.querySelector("#hintLine");
  const btnHint = container.querySelector("#treeHint");

  let state = { scale: 1, tx: 0, ty: 0 };
  const apply = ()=>{
    vp.setAttribute("transform", `translate(${state.tx} ${state.ty}) scale(${state.scale})`);
  };
  const clampScale = (s)=> Math.max(0.35, Math.min(2.6, s));

  function reset(){
    state.scale=1; state.tx=0; state.ty=0; apply();
  }
  container.querySelector("#zIn").onclick=()=>{ state.scale=clampScale(state.scale*1.15); apply(); };
  container.querySelector("#zOut").onclick=()=>{ state.scale=clampScale(state.scale/1.15); apply(); };
  container.querySelector("#zReset").onclick=reset;

  btnHint.onclick=()=>{
    hintLine.style.display = (hintLine.style.display==="none") ? "block" : "none";
  };

  // Pan with one pointer
  let panning=false;
  let lastX=0,lastY=0;
  wrap.addEventListener("pointerdown",(e)=>{
    // only pan if not clicking a node
    if(e.target.closest(".node")) return;
    panning=true;
    wrap.setPointerCapture(e.pointerId);
    lastX=e.clientX; lastY=e.clientY;
  });
  wrap.addEventListener("pointermove",(e)=>{
    if(!panning) return;
    const dx = e.clientX-lastX;
    const dy = e.clientY-lastY;
    lastX=e.clientX; lastY=e.clientY;
    state.tx += dx;
    state.ty += dy;
    apply();
  });
  wrap.addEventListener("pointerup",(e)=>{
    panning=false;
    try{ wrap.releasePointerCapture(e.pointerId); }catch(_){}
  });

  // pinch zoom (touch)
  let touches=new Map();
  wrap.addEventListener("touchstart",(e)=>{
    for(const t of e.changedTouches) touches.set(t.identifier,{x:t.clientX,y:t.clientY});
  }, {passive:true});
  wrap.addEventListener("touchmove",(e)=>{
    if(e.touches.length===2){
      e.preventDefault();
      const t1=e.touches[0], t2=e.touches[1];
      const p1=touches.get(t1.identifier), p2=touches.get(t2.identifier);
      if(!p1||!p2){ touches.set(t1.identifier,{x:t1.clientX,y:t1.clientY}); touches.set(t2.identifier,{x:t2.clientX,y:t2.clientY}); return; }
      const d0=Math.hypot(p1.x-p2.x,p1.y-p2.y);
      const d1=Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY);
      if(d0>0){
        const factor=d1/d0;
        state.scale = clampScale(state.scale*factor);
        apply();
      }
      touches.set(t1.identifier,{x:t1.clientX,y:t1.clientY});
      touches.set(t2.identifier,{x:t2.clientX,y:t2.clientY});
    }else{
      for(const t of e.changedTouches) touches.set(t.identifier,{x:t.clientX,y:t.clientY});
    }
  }, {passive:false});
  wrap.addEventListener("touchend",(e)=>{
    for(const t of e.changedTouches) touches.delete(t.identifier);
  }, {passive:true});

  apply();
}

/* =========================
   PAGES
   ========================= */
function page_dashboard(){
  pageTitle.textContent="B·∫£ng ƒëi·ªÅu khi·ªÉn";
  pageHint.textContent="B1 ch·∫°y th·∫≠t (CRUD + l∆∞u) ‚Ä¢ B2 c√¢y SVG zoom/pan ‚Ä¢ B3 t√¨m h·ªç h√†ng + b√°o c√°o + in/PDF.";
  const total=DB.persons.length;
  const rels=DB.relationships.length;
  const evs=DB.events.length;
  const missingParents = DB.persons.filter(p=>parentsOf(p.id).length===0).length;

  pageChips.innerHTML = [
    chip(`Th√†nh vi√™n: ${total}`),
    chip(`Quan h·ªá: ${rels}`),
    chip(`S·ª± ki·ªán: ${evs}`),
    chip(`Thi·∫øu cha/m·∫π: ${missingParents}`, missingParents? "warn":"ok"),
    chip(`T√°c gi·∫£: ${DB.meta?.author||"B√πi H√†o"}`)
  ].join("");

  const recent = DB.persons.slice(0,8);
  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Th√†nh vi√™n g·∫ßn ƒë√¢y</div><div class="s">Ch·∫°m ƒë·ªÉ m·ªü h·ªì s∆° ‚Ä¢ S·ª≠a ‚Ä¢ N·ªëi quan h·ªá</div></div></div>
        <div class="bd">
          <div class="list" id="recentList">
            ${recent.map(personRowHTML).join("")}
          </div>
          <div class="sep"></div>
          <div class="notice">
            <b>Quy tr√¨nh chu·∫©n:</b> Th√™m ng∆∞·ªùi ‚Üí Th√™m quan h·ªá (cha/m·∫π‚Äìcon, v·ª£/ch·ªìng) ‚Üí Xem c√¢y gia ph·∫£.
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">L·ªëi t·∫Øt</div><div class="s">ƒêi nhanh t·ªõi ch·ª©c nƒÉng ch√≠nh</div></div></div>
        <div class="bd">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn primary" onclick="go('add-person')">+ Th√™m ng∆∞·ªùi</button>
            <button class="btn" onclick="go('add-relation')">üîó Th√™m quan h·ªá</button>
            <button class="btn" onclick="go('tree')">üå≥ Xem c√¢y</button>
            <button class="btn warn" onclick="exportJSON()">Export</button>
          </div>
          <div class="sep"></div>
          <div class="notice">
            <b>B3 PRO:</b> V√†o ‚ÄúT√¨m h·ªç h√†ng‚Äù ƒë·ªÉ d√≤ quan h·ªá gi·ªØa 2 ng∆∞·ªùi (BFS).
          </div>
        </div>
      </aside>
    </div>
  `;
  bindPersonRowClicks(document.getElementById("recentList"));
}

function page_members(){
  pageTitle.textContent="Th√†nh vi√™n";
  pageHint.textContent="Danh s√°ch + l·ªçc theo t·ª´ kho√° (t√™n, qu√™, ƒë·ªùi, nh√°nh‚Ä¶).";
  const q=(qSearch.value||"").trim().toLowerCase();
  const list = DB.persons
    .filter(p=>{
      if(!q) return true;
      const blob = `${p.full_name} ${p.birthplace||""} ${p.hometown||""} ${p.branch||""} ${p.generation??""}`.toLowerCase();
      return blob.includes(q);
    })
    .slice(0,300);

  pageChips.innerHTML = [
    chip(`Hi·ªÉn th·ªã: ${list.length}/${DB.persons.length}`),
    chip(q? `ƒêang l·ªçc: ${q}` : "Kh√¥ng l·ªçc", q?"ok":"")
  ].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Danh s√°ch</div><div class="s">B·∫•m ng∆∞·ªùi ‚Üí h·ªì s∆° ‚Ä¢ s·ª≠a ‚Ä¢ xo√°</div></div></div>
        <div class="bd">
          <div class="list" id="memList">
            ${list.map(personRowHTML).join("") || `<div class="notice">Kh√¥ng c√≥ k·∫øt qu·∫£.</div>`}
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">G·ª£i √Ω</div><div class="s">Nh·∫≠p ƒë√∫ng ƒë·ªÉ c√¢y ƒë·∫πp</div></div></div>
        <div class="bd">
          <div class="notice">
            <b>ƒê·ªùi (generation)</b> ·∫£nh h∆∞·ªüng m·∫°nh t·ªõi vi·ªác v·∫Ω c√¢y. N·∫øu ch∆∞a r√µ ƒë·ªùi, c·ª© ƒë·ªÉ 0 r·ªìi ch·ªânh sau.
          </div>
          <div class="sep"></div>
          <button class="btn primary" onclick="go('add-person')">+ Th√™m ng∆∞·ªùi</button>
        </div>
      </aside>
    </div>
  `;
  bindPersonRowClicks(document.getElementById("memList"));
}

function page_add_person(editId=null){
  const isEdit=!!editId;
  const p=isEdit? getPerson(editId): null;

  pageTitle.textContent = isEdit? "S·ª≠a ng∆∞·ªùi" : "Th√™m ng∆∞·ªùi";
  pageHint.textContent = "B1 ch·∫°y th·∫≠t: l∆∞u LocalStorage ‚Ä¢ c√≥ xo√°/s·ª≠a ‚Ä¢ d√πng ngay.";
  pageChips.innerHTML = [
    chip("B·∫Øt bu·ªôc: H·ªç t√™n + gi·ªõi t√≠nh", "warn"),
    chip("Khuy√™n: ƒê·ªùi + Nh√°nh", "")
  ].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">${isEdit?"C·∫≠p nh·∫≠t h·ªì s∆°":"T·∫°o h·ªì s∆° m·ªõi"}</div><div class="s">D·ªØ li·ªáu l∆∞u t·∫°i m√°y</div></div></div>
        <div class="bd">
          <form class="form" id="personForm">
            <div class="fgrid two">
              <div class="frow"><label>H·ªç t√™n *</label>
                <input name="full_name" required value="${esc(p?.full_name||"")}" placeholder="V√≠ d·ª•: B√πi VƒÉn A"/>
              </div>
              <div class="frow"><label>Gi·ªõi t√≠nh *</label>
                <select name="gender" required>
                  <option value="" ${!p?.gender?"selected":""}>-- Ch·ªçn --</option>
                  <option value="M" ${p?.gender==="M"?"selected":""}>Nam</option>
                  <option value="F" ${p?.gender==="F"?"selected":""}>N·ªØ</option>
                  <option value="O" ${p?.gender==="O"?"selected":""}>Kh√°c</option>
                </select>
              </div>
            </div>

            <div class="fgrid three">
              <div class="frow"><label>Ng√†y sinh</label><input type="date" name="dob" value="${esc(p?.dob||"")}"></div>
              <div class="frow"><label>ƒêang s·ªëng?</label>
                <select name="alive">
                  <option value="true" ${(p?.alive ?? true)?"selected":""}>C√≤n s·ªëng</option>
                  <option value="false" ${(p && !p.alive)?"selected":""}>ƒê√£ m·∫•t</option>
                </select>
              </div>
              <div class="frow"><label>Ng√†y m·∫•t</label><input type="date" name="dod" value="${esc(p?.dod||"")}"></div>
            </div>

            <div class="fgrid two">
              <div class="frow"><label>N∆°i sinh</label><input name="birthplace" value="${esc(p?.birthplace||"")}" placeholder="V√≠ d·ª•: Th·∫°ch C·∫©m"></div>
              <div class="frow"><label>Qu√™ qu√°n</label><input name="hometown" value="${esc(p?.hometown||"")}" placeholder="V√≠ d·ª•: Thanh H√≥a"></div>
            </div>

            <div class="fgrid two">
              <div class="frow"><label>Nh√°nh / Chi</label><input name="branch" value="${esc(p?.branch||"H·ªç B√πi")}" placeholder="V√≠ d·ª•: Chi 1 / Nh√°nh A"></div>
              <div class="frow"><label>ƒê·ªùi (s·ªë)</label><input type="number" name="generation" min="0" step="1" value="${esc(p?.generation ?? 0)}"></div>
            </div>

            <div class="frow"><label>Ghi ch√∫</label><textarea name="notes" placeholder="Bi·ªát danh, ngh·ªÅ nghi·ªáp, m·ªô ph·∫ßn...">${esc(p?.notes||"")}</textarea></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" type="submit">${isEdit?"L∆∞u thay ƒë·ªïi":"Th√™m ng∆∞·ªùi"}</button>
              <button class="btn" type="button" onclick="go('members')">Danh s√°ch</button>
              ${isEdit? `<button class="btn bad" type="button" id="btnDeletePerson">Xo√° ng∆∞·ªùi</button>`:""}
            </div>
          </form>

          <div class="sep"></div>
          <div class="notice"><b>Tip:</b> Th√™m ng∆∞·ªùi xong ‚Üí qua ‚ÄúTh√™m quan h·ªá‚Äù ƒë·ªÉ n·ªëi cha/m·∫π‚Äìcon v√† v·ª£/ch·ªìng.</div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">G·ª£i √Ω nh·∫≠p</div><div class="s">ƒê·ªÉ c√¢y v·∫Ω ƒë√∫ng</div></div></div>
        <div class="bd">
          <div class="notice">
            <b>ƒê·ªùi</b> n√™n tƒÉng d·∫ßn theo th·∫ø h·ªá. N·∫øu ch∆∞a ch·∫Øc, ƒë·ªÉ 0 r·ªìi ch·ªânh l·∫°i sau.
          </div>
          <div class="sep"></div>
          <button class="btn" onclick="go('tree')">üå≥ Xem c√¢y (ƒë·ªÉ ki·ªÉm tra)</button>
        </div>
      </aside>
    </div>
  `;

  const form=document.getElementById("personForm");
  form.onsubmit=(ev)=>{
    ev.preventDefault();
    const fd=new FormData(form);
    const full_name=(fd.get("full_name")+"").trim();
    const gender=(fd.get("gender")+"").trim();
    if(!full_name||!gender) return toast("Thi·∫øu H·ªç t√™n ho·∫∑c Gi·ªõi t√≠nh.");
    const alive=(fd.get("alive")+"")==="true";
    const obj={
      full_name, gender,
      dob:(fd.get("dob")+"").trim(),
      alive,
      dod: alive ? "" : (fd.get("dod")+"").trim(),
      birthplace:(fd.get("birthplace")+"").trim(),
      hometown:(fd.get("hometown")+"").trim(),
      branch:((fd.get("branch")+"").trim()||"H·ªç B√πi"),
      generation: Number(fd.get("generation")||0),
      notes:(fd.get("notes")+"").trim()
    };
    if(isEdit){
      updatePerson(editId, obj);
      toast("ƒê√£ l∆∞u ‚úÖ");
      go("members");
    }else{
      addPerson({ id: uid(), ...obj, created_at: now() });
      toast("ƒê√£ th√™m ‚úÖ");
      go("members");
    }
  };

  if(isEdit){
    document.getElementById("btnDeletePerson").onclick=()=>{
      if(!DB.settings.allow_delete) return toast("ƒêang t·∫Øt quy·ªÅn xo√° trong C√†i ƒë·∫∑t.");
      showConfirm("Xo√° ng∆∞·ªùi?","Xo√° s·∫Ω m·∫•t h·ªì s∆° + quan h·ªá + s·ª± ki·ªán li√™n quan.",()=>{
        deletePerson(editId); toast("ƒê√£ xo√°."); go("members");
      });
    };
  }
}

function page_add_relation(){
  pageTitle.textContent="Th√™m quan h·ªá";
  pageHint.textContent="B1 ch·∫°y th·∫≠t: n·ªëi cha/m·∫π‚Äìcon v√† v·ª£/ch·ªìng (ch·ªëng v√≤ng l·∫∑p c∆° b·∫£n).";
  pageChips.innerHTML = [chip("PARENT_OF: A l√† cha/m·∫π, B l√† con"), chip("SPOUSE_OF: v·ª£/ch·ªìng")].join("");

  const options = DB.persons.slice().sort((a,b)=>a.full_name.localeCompare(b.full_name,"vi"))
    .map(p=>`<option value="${p.id}">${esc(p.full_name)} ‚Ä¢ ƒê·ªùi ${p.generation??0}</option>`).join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">T·∫°o quan h·ªá</div><div class="s">Ch·ªçn A, B, lo·∫°i quan h·ªá</div></div></div>
        <div class="bd">
          <form class="form" id="relForm">
            <div class="fgrid two">
              <div class="frow"><label>Ng∆∞·ªùi A</label>
                <select name="a" required><option value="">-- Ch·ªçn --</option>${options}</select>
              </div>
              <div class="frow"><label>Ng∆∞·ªùi B</label>
                <select name="b" required><option value="">-- Ch·ªçn --</option>${options}</select>
              </div>
            </div>

            <div class="fgrid two">
              <div class="frow"><label>Lo·∫°i quan h·ªá</label>
                <select name="type" required>
                  <option value="PARENT_OF">PARENT_OF (A l√† cha/m·∫π c·ªßa B)</option>
                  <option value="SPOUSE_OF">SPOUSE_OF (A l√† v·ª£/ch·ªìng c·ªßa B)</option>
                </select>
              </div>
              <div class="frow"><label>Ghi ch√∫</label><input name="note" placeholder="V√≠ d·ª•: k·∫øt h√¥n nƒÉm..., con nu√¥i..."></div>
            </div>

            <div class="fgrid two">
              <div class="frow"><label>Ng√†y b·∫Øt ƒë·∫ßu (tu·ª≥ ch·ªçn)</label><input type="date" name="start_date"></div>
              <div class="frow"><label>Ng√†y k·∫øt th√∫c (tu·ª≥ ch·ªçn)</label><input type="date" name="end_date"></div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" type="submit">L∆∞u quan h·ªá</button>
              <button class="btn" type="button" onclick="go('tree')">üå≥ Xem c√¢y</button>
            </div>
          </form>

          <div class="sep"></div>
          <div class="notice"><b>Tip:</b> T·∫°o quan h·ªá xong, qua ‚ÄúC√¢y gia ph·∫£‚Äù ƒë·ªÉ ki·ªÉm tra ƒë∆∞·ªùng n·ªëi.</div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">Quan h·ªá g·∫ßn ƒë√¢y</div><div class="s">T·ªëi ƒëa 12</div></div></div>
        <div class="bd">
          <div class="list" id="relList">
            ${DB.relationships.slice(0,12).map(relRowHTML).join("") || `<div class="notice">Ch∆∞a c√≥ quan h·ªá.</div>`}
          </div>
        </div>
      </aside>
    </div>
  `;

  document.getElementById("relForm").onsubmit=(ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const a=fd.get("a")+""; const b=fd.get("b")+""; const type=fd.get("type")+"";
    if(!a||!b) return toast("Ch·ªçn ƒë·ªß A v√† B.");
    const res = addRelationship({
      id: uid(), type, a, b,
      start_date:(fd.get("start_date")+"").trim(),
      end_date:(fd.get("end_date")+"").trim(),
      note:(fd.get("note")+"").trim(),
      created_at: now()
    });
    if(!res.ok) return toast(res.msg || "Kh√¥ng t·∫°o ƒë∆∞·ª£c quan h·ªá.");
    toast("ƒê√£ l∆∞u quan h·ªá ‚úÖ");
    go("add-relation");
  };

  pageBody.querySelectorAll("[data-delrel]").forEach(btn=>{
    btn.onclick=()=>{
      if(!DB.settings.allow_delete) return toast("ƒêang t·∫Øt quy·ªÅn xo√° trong C√†i ƒë·∫∑t.");
      const id=btn.getAttribute("data-delrel");
      showConfirm("Xo√° quan h·ªá?","B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° quan h·ªá n√†y?",()=>{
        deleteRelationship(id); toast("ƒê√£ xo√°."); go("add-relation");
      });
    };
  });
}

function page_events(){
  pageTitle.textContent="S·ª± ki·ªán / M·ªëc";
  pageHint.textContent="B1 ch·∫°y th·∫≠t: th√™m s·ª± ki·ªán g·∫Øn theo ng∆∞·ªùi (c∆∞·ªõi/gi·ªó/di c∆∞...).";
  pageChips.innerHTML = [chip("L∆∞u offline", "ok"), chip("Export/Import", "")].join("");

  const options = DB.persons.slice().sort((a,b)=>a.full_name.localeCompare(b.full_name,"vi"))
    .map(p=>`<option value="${p.id}">${esc(p.full_name)}</option>`).join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Th√™m s·ª± ki·ªán</div><div class="s">Ch·ªçn ng∆∞·ªùi (n·∫øu c·∫ßn)</div></div></div>
        <div class="bd">
          <form class="form" id="evForm">
            <div class="fgrid two">
              <div class="frow"><label>Ti√™u ƒë·ªÅ *</label><input name="title" required placeholder="V√≠ d·ª•: L·ªÖ c∆∞·ªõi / Ng√†y gi·ªó / An t√°ng..."></div>
              <div class="frow"><label>Lo·∫°i</label>
                <select name="type">
                  <option value="WEDDING">WEDDING</option>
                  <option value="DEATH">DEATH</option>
                  <option value="ANNIVERSARY">ANNIVERSARY</option>
                  <option value="MOVE">MOVE</option>
                  <option value="OTHER" selected>OTHER</option>
                </select>
              </div>
            </div>
            <div class="fgrid two">
              <div class="frow"><label>Ng√†y</label><input type="date" name="date" value="${todayISO()}"></div>
              <div class="frow"><label>G·∫Øn v·ªõi ng∆∞·ªùi</label>
                <select name="person_id"><option value="">-- S·ª± ki·ªán chung --</option>${options}</select>
              </div>
            </div>
            <div class="frow"><label>Ghi ch√∫</label><textarea name="note" placeholder="Ghi ch√∫ chi ti·∫øt..."></textarea></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" type="submit">L∆∞u s·ª± ki·ªán</button>
              <button class="btn" type="button" onclick="go('events')">L√†m m·ªõi</button>
            </div>
          </form>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">Danh s√°ch s·ª± ki·ªán</div><div class="s">T·ªëi ƒëa 30</div></div></div>
        <div class="bd">
          <div class="list" id="evList">
            ${DB.events.slice(0,30).map(eventRowHTML).join("") || `<div class="notice">Ch∆∞a c√≥ s·ª± ki·ªán.</div>`}
          </div>
        </div>
      </aside>
    </div>
  `;

  document.getElementById("evForm").onsubmit=(ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const title=(fd.get("title")+"").trim();
    if(!title) return toast("Thi·∫øu ti√™u ƒë·ªÅ.");
    addEvent({
      id: uid(),
      title,
      type:(fd.get("type")+"").trim(),
      date:(fd.get("date")+"").trim(),
      person_id:(fd.get("person_id")+"").trim()||"",
      note:(fd.get("note")+"").trim(),
      created_at: now()
    });
    toast("ƒê√£ l∆∞u s·ª± ki·ªán ‚úÖ");
    go("events");
  };

  pageBody.querySelectorAll("[data-delev]").forEach(btn=>{
    btn.onclick=()=>{
      if(!DB.settings.allow_delete) return toast("ƒêang t·∫Øt quy·ªÅn xo√° trong C√†i ƒë·∫∑t.");
      const id=btn.getAttribute("data-delev");
      showConfirm("Xo√° s·ª± ki·ªán?","B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° s·ª± ki·ªán n√†y?",()=>{
        deleteEvent(id); toast("ƒê√£ xo√°."); go("events");
      });
    };
  });

  pageBody.querySelectorAll("[data-openperson]").forEach(btn=>{
    btn.onclick=()=>{ const pid=btn.getAttribute("data-openperson"); if(pid) openPersonModal(pid); };
  });
}

function page_tree(){
  pageTitle.textContent="C√¢y gia ph·∫£";
  pageHint.textContent="B2: SVG node + ƒë∆∞·ªùng n·ªëi + zoom/pan. Click node ƒë·ªÉ m·ªü h·ªì s∆°.";
  pageChips.innerHTML = [chip("Zoom/Pan m∆∞·ª£t", "ok"), chip("Click m·ªü h·ªì s∆°", "ok"), chip("Layout theo ƒë·ªùi", "")].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">C√¢y gia ph·∫£ (SVG)</div><div class="s">D·ª±a tr√™n PARENT_OF + SPOUSE_OF</div></div></div>
        <div class="bd" id="treeContainer"></div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">G·ª£i √Ω ƒë·ªÉ c√¢y ƒë·∫πp</div><div class="s">Nh·∫≠p ƒë√∫ng ƒë·ªùi & quan h·ªá</div></div></div>
        <div class="bd">
          <div class="notice">
            1) Th√™m quan h·ªá <b>cha/m·∫π‚Äìcon</b> ƒë·ªß 2 b√™n (n·∫øu c√≥).<br/>
            2) ƒê·ªùi (generation) n√™n nh·∫•t qu√°n.<br/>
            3) V·ª£/ch·ªìng c√πng ƒë·ªùi ƒë·ªÉ ƒë∆∞·ªùng n·ªëi ngang ƒë·∫πp.
          </div>
          <div class="sep"></div>
          <button class="btn" onclick="go('add-relation')">üîó Th√™m quan h·ªá</button>
          <button class="btn primary" onclick="go('add-person')">‚ûï Th√™m ng∆∞·ªùi</button>
        </div>
      </aside>
    </div>
  `;
  renderTree(document.getElementById("treeContainer"));
}

function page_kin(){
  pageTitle.textContent="T√¨m h·ªç h√†ng";
  pageHint.textContent="B3 PRO: ch·ªçn 2 ng∆∞·ªùi ‚Üí t√¨m ƒë∆∞·ªùng li√™n k·∫øt ng·∫Øn nh·∫•t (BFS).";
  pageChips.innerHTML = [chip("BFS ƒë∆∞·ªùng ng·∫Øn", "ok")].join("");

  const options = DB.persons.slice().sort((a,b)=>a.full_name.localeCompare(b.full_name,"vi"))
    .map(p=>`<option value="${p.id}">${esc(p.full_name)}</option>`).join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Ch·ªçn 2 ng∆∞·ªùi</div><div class="s">C·∫ßn quan h·ªá PARENT_OF ho·∫∑c SPOUSE_OF</div></div></div>
        <div class="bd">
          <div class="form">
            <div class="fgrid two">
              <div class="frow"><label>Ng∆∞·ªùi A</label><select id="kinA"><option value="">-- Ch·ªçn --</option>${options}</select></div>
              <div class="frow"><label>Ng∆∞·ªùi B</label><select id="kinB"><option value="">-- Ch·ªçn --</option>${options}</select></div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnFindKin">T√¨m quan h·ªá</button>
              <button class="btn" id="btnSwap">ƒê·ªïi A/B</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="notice" id="kinResult">Ch·ªçn A v√† B r·ªìi b·∫•m ‚ÄúT√¨m quan h·ªá‚Äù.</div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">Khi ch∆∞a t√¨m th·∫•y</div><div class="s">C√°ch x·ª≠ l√Ω</div></div></div>
        <div class="bd">
          <div class="notice">
            N·∫øu b√°o ‚Äúch∆∞a t√¨m th·∫•y‚Äù, h√£y v√†o <b>Th√™m quan h·ªá</b> ƒë·ªÉ n·ªëi cha/m·∫π‚Äìcon ho·∫∑c v·ª£/ch·ªìng.
          </div>
          <div class="sep"></div>
          <button class="btn" onclick="go('add-relation')">ƒêi t·ªõi Th√™m quan h·ªá</button>
        </div>
      </aside>
    </div>
  `;

  const kinA=document.getElementById("kinA");
  const kinB=document.getElementById("kinB");
  document.getElementById("btnSwap").onclick=(e)=>{ e.preventDefault(); const t=kinA.value; kinA.value=kinB.value; kinB.value=t; };
  document.getElementById("btnFindKin").onclick=(e)=>{
    e.preventDefault();
    const a=kinA.value, b=kinB.value;
    const box=document.getElementById("kinResult");
    if(!a||!b){ box.className="notice danger"; box.textContent="Ch·ªçn ƒë·ªß A v√† B."; return; }
    const res=computeKinship(a,b);
    if(!res.ok){ box.className="notice danger"; box.textContent=res.text; return; }
    const names=res.path.map(id=>getPerson(id)?.full_name || "(?)");
    box.className="notice";
    box.innerHTML = `
      <div style="font-weight:1000;margin-bottom:6px;">${esc(res.text)}</div>
      <div class="muted" style="margin-bottom:8px;">ƒê∆∞·ªùng ƒëi:</div>
      <div>${names.map(esc).join(" ‚Üí ")}</div>
      ${res.steps?.length ? `<div class="muted" style="margin-top:10px;">B∆∞·ªõc:</div><div>${res.steps.map(esc).join(" ‚Ä¢ ")}</div>` : ``}
    `;
  };
}

function page_reports(){
  pageTitle.textContent="B√°o c√°o ƒë·ªùi / chi h·ªç";
  pageHint.textContent="B3 PRO: th·ªëng k√™ theo ƒë·ªùi v√† nh√°nh/chi.";
  const byGen=new Map();
  const byBranch=new Map();
  DB.persons.forEach(p=>{
    const g = p.generation ?? 0;
    byGen.set(g, (byGen.get(g)||0)+1);
    const br=(p.branch||"H·ªç B√πi").trim() || "H·ªç B√πi";
    byBranch.set(br, (byBranch.get(br)||0)+1);
  });
  const genRows=[...byGen.entries()].sort((a,b)=>a[0]-b[0]);
  const brRows=[...byBranch.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);

  pageChips.innerHTML = [chip(`S·ªë ƒë·ªùi: ${genRows.length}`), chip(`S·ªë nh√°nh: ${brRows.length}`)].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Theo ƒë·ªùi</div><div class="s">S·ªë l∆∞·ª£ng theo ƒë·ªùi</div></div></div>
        <div class="bd">
          <div class="list">
            ${genRows.map(([g,n])=>`
              <div class="row">
                <div class="avatar">ƒê${g}</div>
                <div class="meta"><div class="name">ƒê·ªùi ${g}</div><div class="sub">${n} ng∆∞·ªùi</div></div>
                <div class="actions"><button class="btn" onclick="filterKeyword('${String(g)}')">L·ªçc</button></div>
              </div>
            `).join("") || `<div class="notice">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`}
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">Theo nh√°nh/chi</div><div class="s">Top 20</div></div></div>
        <div class="bd">
          <div class="list">
            ${brRows.map(([br,n])=>`
              <div class="row">
                <div class="avatar">üè∑Ô∏è</div>
                <div class="meta"><div class="name">${esc(br)}</div><div class="sub">${n} ng∆∞·ªùi</div></div>
                <div class="actions"><button class="btn" onclick="filterKeyword('${escAttr(br)}')">L·ªçc</button></div>
              </div>
            `).join("") || `<div class="notice">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`}
          </div>
          <div class="sep"></div>
          <div class="notice"><b>M·∫πo:</b> Nh·∫≠p ‚Äúnh√°nh/chi‚Äù r√µ r√†ng ƒë·ªÉ b√°o c√°o chu·∫©n.</div>
        </div>
      </aside>
    </div>
  `;
}

function page_backup(){
  pageTitle.textContent="Import / Export";
  pageHint.textContent="B1 ch·∫°y th·∫≠t: sao l∆∞u JSON (ƒë·ªÉ g·ª≠i cho ng∆∞·ªùi th√¢n / l∆∞u d√†i h·∫°n).";
  pageChips.innerHTML = [chip("Export JSON", "ok"), chip("Import JSON", "ok")].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Export</div><div class="s">T·∫£i file JSON v·ªÅ m√°y</div></div></div>
        <div class="bd">
          <button class="btn warn" id="btnExport">‚¨áÔ∏è Export JSON</button>
          <div class="sep"></div>
          <div class="notice">Export xong, H√†o c√≥ th·ªÉ l∆∞u ho·∫∑c g·ª≠i file ƒë·ªÉ d√πng tr√™n thi·∫øt b·ªã kh√°c.</div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">Import / Reset</div><div class="s">Kh√¥i ph·ª•c d·ªØ li·ªáu</div></div></div>
        <div class="bd">
          <input type="file" id="importFile" accept="application/json" class="btn" style="width:100%;text-align:left"/>
          <div class="sep"></div>
          <button class="btn bad" id="btnReset">Reset d·ªØ li·ªáu (xo√° s·∫°ch)</button>
          <div class="sep"></div>
          <div class="notice danger"><b>C·∫©n th·∫≠n:</b> Reset s·∫Ω xo√° to√†n b·ªô d·ªØ li·ªáu ƒëang l∆∞u tr√™n m√°y.</div>
        </div>
      </aside>
    </div>
  `;

  document.getElementById("btnExport").onclick=exportJSON;
  document.getElementById("importFile").onchange=importJSON;
  document.getElementById("btnReset").onclick=()=>{
    showConfirm("Reset d·ªØ li·ªáu?","Xo√° to√†n b·ªô gia ph·∫£ ƒëang l∆∞u tr√™n m√°y?",()=>{
      localStorage.removeItem(LS_KEY);
      DB = seedIfEmpty();
      refreshKPI();
      toast("ƒê√£ reset.");
      go("dashboard");
    });
  };
}

function page_print(){
  pageTitle.textContent="In / Xu·∫•t PDF";
  pageHint.textContent="B3 PRO: d√πng t√≠nh nƒÉng In c·ªßa tr√¨nh duy·ªát ƒë·ªÉ l∆∞u PDF.";
  pageChips.innerHTML = [chip("Chrome ‚ãÆ ‚Üí In ‚Üí L∆∞u PDF", "ok")].join("");

  const sample = DB.persons.slice().sort((a,b)=>a.full_name.localeCompare(b.full_name,"vi")).slice(0,60);

  pageBody.innerHTML = `
    <div class="card">
      <div class="hd">
        <div><div class="h">B·∫£n in danh s√°ch (preview)</div><div class="s">D√πng In c·ªßa tr√¨nh duy·ªát ƒë·ªÉ l∆∞u PDF</div></div>
        <div class="chips">${chip(`T√°c gi·∫£: ${DB.meta?.author||"B√πi H√†o"}`)}${chip("H·ªç: B√πi")}</div>
      </div>
      <div class="bd" id="printArea">
        <div class="notice"><b>C√°ch xu·∫•t PDF:</b> Chrome ‚Üí Menu ‚ãÆ ‚Üí <b>In</b> ‚Üí ch·ªçn <b>L∆∞u d∆∞·ªõi d·∫°ng PDF</b>.</div>
        <div class="sep"></div>
        <div class="list">
          ${sample.map(p=>`
            <div class="row">
              <div class="avatar">${esc(initials2(p.full_name))}</div>
              <div class="meta">
                <div class="name">${esc(p.full_name)}</div>
                <div class="sub">Gi·ªõi t√≠nh: ${p.gender==="M"?"Nam":p.gender==="F"?"N·ªØ":"Kh√°c"} ‚Ä¢ ƒê·ªùi: ${esc(p.generation??0)} ‚Ä¢ Nh√°nh: ${esc(p.branch||"H·ªç B√πi")} ‚Ä¢ Qu√™: ${esc(p.hometown||"-")}</div>
              </div>
            </div>
          `).join("")}
        </div>
        <div class="sep"></div>
        <div class="muted">¬© ${esc(DB.meta?.author||"B√πi H√†o")} ‚Ä¢ ${esc(DB.meta?.family_name||"Gia ph·∫£ h·ªç B√πi")}</div>
      </div>
      <div class="bd" style="padding-top:0">
        <button class="btn primary" onclick="window.print()">üñ®Ô∏è In / Save as PDF</button>
      </div>
    </div>
  `;
}

function page_settings(){
  pageTitle.textContent="C√†i ƒë·∫∑t";
  pageHint.textContent="ƒê·ªïi t√™n gia ph·∫£, t√°c gi·∫£, b·∫≠t/t·∫Øt quy·ªÅn xo√°.";
  pageChips.innerHTML = [chip("L∆∞u t·∫°i m√°y", "ok")].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Th√¥ng tin</div><div class="s">T√™n gia ph·∫£ & t√°c gi·∫£</div></div></div>
        <div class="bd">
          <div class="form">
            <div class="frow"><label>T√™n gia ph·∫£</label>
              <input id="metaFamily" value="${esc(DB.meta?.family_name||"Gia ph·∫£ h·ªç B√πi")}">
            </div>
            <div class="frow"><label>T√°c gi·∫£</label>
              <input id="metaAuthor" value="${esc(DB.meta?.author||"B√πi H√†o")}">
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnSaveMeta">L∆∞u</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">Quy·ªÅn</div><div class="s">B·∫£o v·ªá kh·ªèi xo√° nh·∫ßm</div></div></div>
        <div class="bd">
          <div class="frow"><label>Cho ph√©p xo√° d·ªØ li·ªáu?</label>
            <select id="setAllowDelete">
              <option value="true" ${DB.settings.allow_delete?"selected":""}>Cho ph√©p</option>
              <option value="false" ${!DB.settings.allow_delete?"selected":""}>Kh√¥ng cho ph√©p</option>
            </select>
          </div>
          <div class="sep"></div>
          <div class="notice"><b>G·ª£i √Ω:</b> Khi g·ª≠i file cho ng∆∞·ªùi kh√°c d√πng, n√™n t·∫Øt quy·ªÅn xo√°.</div>
        </div>
      </aside>
    </div>
  `;

  document.getElementById("btnSaveMeta").onclick=(e)=>{
    e.preventDefault();
    DB.meta.family_name=(document.getElementById("metaFamily").value||"").trim() || "Gia ph·∫£ h·ªç B√πi";
    DB.meta.author=(document.getElementById("metaAuthor").value||"").trim() || "B√πi H√†o";
    saveDB(DB); refreshKPI();
    toast("ƒê√£ l∆∞u ‚úÖ");
  };
  document.getElementById("setAllowDelete").onchange=(e)=>{
    DB.settings.allow_delete=(e.target.value==="true");
    saveDB(DB);
    toast("ƒê√£ c·∫≠p nh·∫≠t quy·ªÅn xo√°.");
  };
}

function page_about(){
  pageTitle.textContent="Gi·ªõi thi·ªáu";
  pageHint.textContent="B·∫£n web/PWA 1 file ‚Äì ƒë·ªß B1+B2+B3 ‚Äì d√†nh cho Gia ph·∫£ h·ªç B√πi.";
  pageChips.innerHTML = [chip("B1+B2+B3", "ok"), chip(`T√°c gi·∫£: ${DB.meta?.author||"B√πi H√†o"}`)].join("");

  pageBody.innerHTML = `
    <div class="grid two">
      <section class="card">
        <div class="hd"><div><div class="h">Gia ph·∫£ h·ªç B√πi</div><div class="s">Phi√™n b·∫£n: ${esc(DB.meta?.version||"full")}</div></div></div>
        <div class="bd">
          <div class="notice">
            <b>ƒê√£ c√≥:</b> Th√™m ng∆∞·ªùi, th√™m quan h·ªá, s·ª± ki·ªán, c√¢y SVG zoom/pan, t√¨m h·ªç h√†ng, b√°o c√°o, import/export, in PDF.
          </div>
          <div class="sep"></div>
          <div class="muted" style="line-height:1.8">
            <b>C√†i nh∆∞ app:</b> Chrome Android ‚Üí Menu ‚ãÆ ‚Üí <b>Th√™m v√†o m√†n h√¨nh ch√≠nh</b>.
          </div>
          <div class="sep"></div>
          <div class="muted">¬© <b>${esc(DB.meta?.author||"B√πi H√†o")}</b> ‚Ä¢ ${esc(DB.meta?.family_name||"Gia ph·∫£ h·ªç B√πi")}</div>
        </div>
      </section>

      <aside class="card">
        <div class="hd"><div><div class="h">N√¢ng c·∫•p ti·∫øp (n·∫øu mu·ªën gi·ªëng Giapha 4.0 h∆°n)</div><div class="s">M√¨nh l√†m ti·∫øp ngay</div></div></div>
        <div class="bd">
          <div class="notice">
            1) C√¢y: gom ‚Äúc·∫∑p v·ª£ ch·ªìng‚Äù th√†nh 1 c·ª•m, n·ªëi con theo c·ª•m.<br/>
            2) L·ªãch gi·ªó (√¢m l·ªãch), nh·∫Øc l·ªãch.<br/>
            3) ƒê·ªìng b·ªô cloud (Firebase/Supabase) nhi·ªÅu ng∆∞·ªùi c√πng s·ª≠a.
          </div>
        </div>
      </aside>
    </div>
  `;
}

/* =========================
   EXPORT / IMPORT
   ========================= */
function exportJSON(){
  const data = JSON.stringify(DB, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,10);
  a.download = `gia-pha-ho-bui_${ts}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  toast("ƒê√£ export JSON ‚¨áÔ∏è");
}
function importJSON(ev){
  const file = ev.target.files?.[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      if(!obj || !obj.persons || !obj.relationships || !obj.events){
        toast("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.");
        return;
      }
      DB=obj; saveDB(DB); refreshKPI();
      toast("ƒê√£ import ‚úÖ");
      go("dashboard");
    }catch(e){ toast("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c JSON."); }
  };
  reader.readAsText(file);
}

/* =========================
   HELPERS
   ========================= */
function escAttr(s=""){ return (s+"").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
window.filterKeyword = (kw)=>{
  qSearch.value = kw;
  go("members");
  toast(`ƒêang l·ªçc: ${kw}`);
};

/* =========================
   ROUTER
   ========================= */
const PAGES = {
  dashboard:{render:page_dashboard},
  tree:{render:page_tree},
  members:{render:page_members},
  "add-person":{render:()=>page_add_person(null)},
  "add-relation":{render:page_add_relation},
  events:{render:page_events},
  kin:{render:page_kin},
  reports:{render:page_reports},
  backup:{render:page_backup},
  print:{render:page_print},
  settings:{render:page_settings},
  about:{render:page_about},
};

function go(page){
  if(!PAGES[page]) page="dashboard";
  setActiveNav(page);
  closeDrawer();
  PAGES[page].render();
  history.replaceState(null,"","#"+page);
  window.scrollTo({top:0,behavior:"smooth"});
}

menu.addEventListener("click",(e)=>{
  const it=e.target.closest(".item");
  if(!it) return;
  go(it.dataset.page);
});
bottomBar.addEventListener("click",(e)=>{
  const it=e.target.closest(".bitem");
  if(!it) return;
  go(it.dataset.page);
});

/* Quick buttons */
document.getElementById("quickAdd").onclick=()=>go("add-person");
document.getElementById("quickExport").onclick=exportJSON;

/* Search typing refresh members page if active */
qSearch.addEventListener("input", ()=>{
  const cur=(location.hash||"#dashboard").slice(1);
  if(cur==="members") page_members();
});

/* =========================
   BOOT
   ========================= */
refreshKPI();
const initial=(location.hash||"#dashboard").slice(1);
go(PAGES[initial]? initial : "dashboard");
</script>
</body>
</html>
