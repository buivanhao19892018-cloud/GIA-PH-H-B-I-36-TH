<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Gia ph·∫£ h·ªç B√πi ‚Ä¢ CLOUD PWA</title>
  <meta name="theme-color" content="#7f1d1d" />
  <style>
    :root{
      --bg:#070a14;
      --card: rgba(255,255,255,.06);
      --card2: rgba(0,0,0,.22);
      --text:#eaf0ff;
      --muted:#a7b2d6;
      --line:rgba(255,255,255,.10);
      --brand:#7f1d1d;
      --brand2:#b91c1c;
      --good:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 0%, rgba(185,28,28,.22), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, #070a14, #06081a 60%, #05061a);
    }
    a{color:inherit}
    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 92px}
    .topbar{
      position:sticky; top:0; z-index:5;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:24px;
      background:linear-gradient(135deg, rgba(127,29,29,.95), rgba(10,14,28,.60));
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .logo{
      width:46px; height:46px; border-radius:16px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.28), transparent 58%), rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.16);
      display:grid; place-items:center; font-weight:900; letter-spacing:.5px;
      flex:0 0 auto;
    }
    .titleBox{min-width:0}
    .title{font-weight:900; font-size:16px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .sub{font-size:12px; color:rgba(255,255,255,.82)}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      font-size:12px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px; border-radius:14px;
      font-weight:800; cursor:pointer;
      transition: transform .05s ease;
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{background:linear-gradient(135deg, var(--brand2), var(--brand))}
    .btn.good{background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.92)); border-color:rgba(255,255,255,.10)}
    .btn.warn{background:linear-gradient(135deg, rgba(245,158,11,.95), rgba(217,119,6,.95))}
    .btn.ghost{background:rgba(0,0,0,.18)}
    .btn.icon{
      padding:10px 12px; border-radius:14px;
      display:flex; align-items:center; gap:8px;
    }
    .bell{
      position:relative;
    }
    .badge{
      position:absolute; top:-6px; right:-6px;
      min-width:18px; height:18px; padding:0 5px;
      border-radius:999px;
      background:#ef4444;
      border:1px solid rgba(255,255,255,.25);
      font-size:11px; font-weight:900;
      display:grid; place-items:center;
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.20);
    }
    .card .hd h3{margin:0; font-size:14px}
    .card .bd{padding:12px}
    .grid{display:grid; gap:10px}
    @media(min-width:900px){
      .grid.two{grid-template-columns:1fr 1fr}
      .grid.three{grid-template-columns:1.2fr .8fr .8fr}
      .grid.kpi{grid-template-columns:repeat(4, 1fr)}
    }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22); color:var(--text);
      outline:none;
    }
    .field textarea{min-height:96px; resize:vertical}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .kpiCard{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.20);
      padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .kpiVal{font-weight:950; font-size:18px}
    .kpiLab{font-size:12px; color:var(--muted)}
    .kpiIco{
      width:38px; height:38px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:grid; place-items:center;
    }

    .tabs{
      position:fixed; left:0; right:0; bottom:0; z-index:6;
      background:rgba(7,10,20,.84);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      display:flex; gap:10px; justify-content:center;
    }
    .tab{
      width:min(170px, 22vw);
      text-align:center;
      padding:11px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      cursor:pointer; font-weight:900;
      user-select:none;
    }
    .tab.on{background:linear-gradient(135deg, rgba(185,28,28,.92), rgba(127,29,29,.92))}
    .hide{display:none !important}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      padding:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .left{display:flex; align-items:center; gap:10px; min-width:0}
    .avatar{
      width:44px; height:44px; border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden; flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:900; color:rgba(255,255,255,.75);
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .name{font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta{font-size:12px; color:var(--muted)}
    .toast{
      position:fixed; top:14px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px; border-radius:14px;
      z-index:99; max-width:92vw;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0; z-index:50;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px 12px calc(14px + env(safe-area-inset-bottom));
    }
    .backdrop.on{display:flex}
    .modal{
      width:min(820px, 100%);
      border-radius:24px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .mh{
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
    }
    .modal .mh h3{margin:0; font-size:14px}
    .modal .mb{padding:12px; max-height:min(70vh, 640px); overflow:auto}
    .small{font-size:12px}
    .hint{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:18px;
      padding:10px;
      background:rgba(0,0,0,.16);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">BU</div>
        <div class="titleBox">
          <div class="title" id="appTitle">Gia ph·∫£ h·ªç B√πi ‚Ä¢ CLOUD PWA</div>
          <div class="sub">T√°c gi·∫£: <b>B√πi H√†o</b> ‚Ä¢ Supabase + GitHub Pages ‚Ä¢ Push (Edge Function)</div>
        </div>
      </div>

      <div class="right">
        <span class="pill" id="pillState">Ch∆∞a k·∫øt n·ªëi Cloud</span>

        <button class="btn icon ghost bell" id="btnBell" title="Th√¥ng b√°o">
          üîî <span style="font-weight:900">Th√¥ng b√°o</span>
          <span class="badge hide" id="bellBadge">0</span>
        </button>

        <button class="btn icon" id="btnEnablePush">üì£ B·∫≠t th√¥ng b√°o</button>
        <button class="btn primary icon" id="btnCreateEventTop">Ôºã T·∫°o s·ª± ki·ªán</button>
      </div>
    </div>

    <!-- SETUP -->
    <section class="card" id="secSetup">
      <div class="hd">
        <h3>Thi·∫øt l·∫≠p Cloud (b·∫Øt bu·ªôc)</h3>
        <span class="muted small">D√°n URL + ANON KEY c·ªßa Supabase</span>
      </div>
      <div class="bd grid two">
        <div class="field">
          <label>SUPABASE_URL</label>
          <input id="cfgUrl" placeholder="https://xxxxx.supabase.co" />
        </div>
        <div class="field">
          <label>SUPABASE_ANON_KEY</label>
          <input id="cfgKey" placeholder="eyJhbGciOi..." />
        </div>
        <div class="field">
          <label>M√£ gia ph·∫£ (family_code)</label>
          <input id="cfgFamilyCode" placeholder="VD: BUI-THACHCAM-001" />
        </div>
        <div class="row" style="align-items:flex-end">
          <button class="btn good" id="btnSaveCfg">L∆∞u & K·∫øt n·ªëi</button>
          <button class="btn" id="btnClearCfg">X√≥a c·∫•u h√¨nh</button>
        </div>

        <div class="hint small muted" style="grid-column:1/-1">
          ‚úÖ App n√†y ch·∫°y ki·ªÉu ‚Äúc·∫£ h·ªç d√πng chung 1 m√£ gia ph·∫£‚Äù.  
          - Ai m·ªü app ‚Üí nh·∫≠p m√£ ‚Üí v√†o ƒë∆∞·ª£c.  
          - Khi t·∫°o s·ª± ki·ªán ‚Üí app t·∫°o ‚Äúth√¥ng b√°o‚Äù v√† **Edge Function** s·∫Ω g·ª≠i push t·ªõi t·∫•t c·∫£ m√°y ƒë√£ b·∫•m ‚ÄúB·∫≠t th√¥ng b√°o‚Äù.  
          <br><br>
          ‚ö†Ô∏è Push b·∫Øt bu·ªôc c√≥: file <b>sw.js</b> + Edge Function <b>send-push</b> (m√¨nh ƒë∆∞a ·ªü d∆∞·ªõi).
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section class="card hide" id="secApp">
      <div class="hd">
        <h3>T·ªïng quan</h3>
        <div class="row">
          <span class="pill" id="pillFamily">family: -</span>
          <button class="btn" id="btnRefresh">T·∫£i l·∫°i</button>
        </div>
      </div>

      <div class="bd grid kpi" id="kpiGrid">
        <div class="kpiCard"><div><div class="kpiVal" id="kpiPeople">0</div><div class="kpiLab">Th√†nh vi√™n</div></div><div class="kpiIco">üë§</div></div>
        <div class="kpiCard"><div><div class="kpiVal" id="kpiEvents">0</div><div class="kpiLab">S·ª± ki·ªán</div></div><div class="kpiIco">üìÖ</div></div>
        <div class="kpiCard"><div><div class="kpiVal" id="kpiNoti">0</div><div class="kpiLab">Th√¥ng b√°o</div></div><div class="kpiIco">üîî</div></div>
        <div class="kpiCard"><div><div class="kpiVal" id="kpiPush">0</div><div class="kpiLab">M√°y ƒë√£ b·∫≠t push</div></div><div class="kpiIco">üì£</div></div>
      </div>

      <div class="bd grid two" style="padding-top:0">
        <div class="card" style="margin:0">
          <div class="hd"><h3>Thao t√°c nhanh</h3></div>
          <div class="bd row">
            <button class="btn primary" id="btnAddPerson">Ôºã Th√™m ng∆∞·ªùi</button>
            <button class="btn" id="btnOpenPeople">Danh s√°ch</button>
            <button class="btn warn" id="btnOpenNoti">M·ªü th√¥ng b√°o</button>
          </div>
          <div class="bd" style="padding-top:0">
            <div class="muted small">G·ª£i √Ω: t·∫°o ‚ÄúC·ª• t·ªï‚Äù tr∆∞·ªõc ‚Üí th√™m con/ch√°u ‚Üí t·∫°o s·ª± ki·ªán (gi·ªó, c∆∞·ªõi, h·ªçp h·ªç‚Ä¶)</div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <div class="hd"><h3>S·ª± ki·ªán g·∫ßn ƒë√¢y</h3></div>
          <div class="bd">
            <div class="list" id="recentEvents"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PEOPLE -->
    <section class="card hide" id="secPeople">
      <div class="hd">
        <h3>Th√†nh vi√™n</h3>
        <div class="row">
          <input id="q" style="min-width:220px" placeholder="T√¨m t√™n, qu√™ qu√°n, nƒÉm sinh..." />
          <button class="btn" id="btnSearch">T√¨m</button>
          <button class="btn primary" id="btnAddPerson2">Ôºã Th√™m</button>
          <button class="btn" id="btnBackHome1">V·ªÅ Home</button>
        </div>
      </div>
      <div class="bd">
        <div class="list" id="peopleList"></div>
      </div>
    </section>

    <!-- EVENTS -->
    <section class="card hide" id="secEvents">
      <div class="hd">
        <h3>S·ª± ki·ªán</h3>
        <div class="row">
          <button class="btn primary" id="btnCreateEvent">Ôºã T·∫°o s·ª± ki·ªán</button>
          <button class="btn" id="btnBackHome2">V·ªÅ Home</button>
        </div>
      </div>
      <div class="bd">
        <div class="list" id="eventList"></div>
      </div>
    </section>
  </div>

  <!-- Bottom tabs -->
  <div class="tabs hide" id="tabs">
    <div class="tab on" data-tab="home">Home</div>
    <div class="tab" data-tab="people">Th√†nh vi√™n</div>
    <div class="tab" data-tab="events">S·ª± ki·ªán</div>
  </div>

  <!-- Toast -->
  <div class="toast hide" id="toast"></div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="mh">
        <h3 id="mTitle">Modal</h3>
        <div class="row">
          <button class="btn" id="mClose">ƒê√≥ng</button>
        </div>
      </div>
      <div class="mb" id="mBody"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // =========================
    // 0) Tiny helpers
    // =========================
    const $ = s => document.querySelector(s);
    const esc = (s)=> (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    const toast = (msg)=>{
      const t=$("#toast"); t.textContent=msg; t.classList.remove("hide");
      setTimeout(()=>t.classList.add("hide"), 2200);
    };
    const show = (id, on=true)=> $(id).classList.toggle("hide", !on);
    const openModal = (title, html)=>{ $("#mTitle").textContent=title; $("#mBody").innerHTML=html; $("#backdrop").classList.add("on"); };
    const closeModal = ()=>{ $("#backdrop").classList.remove("on"); $("#mBody").innerHTML=""; };
    $("#mClose").addEventListener("click", closeModal);
    $("#backdrop").addEventListener("click", (e)=>{ if(e.target.id==="backdrop") closeModal(); });

    // =========================
    // 1) Config (saved in localStorage)
    // =========================
    const LSKEY="BUI_GIAPHA_CLOUD_CFG_V1";
    let CFG = JSON.parse(localStorage.getItem(LSKEY) || "null");
    $("#cfgUrl").value = CFG?.url || "";
    $("#cfgKey").value = CFG?.key || "";
    $("#cfgFamilyCode").value = CFG?.familyCode || "";

    let sb = null;
    let family = null;
    let familyId = null;

    // Caches
    let people=[], events=[], notis=[], pushSubs=[];
    let unreadNoti = 0;

    // Realtime channel holder
    let chNoti = null;

    // PWA push
    const SW_PATH = "./sw.js"; // <-- H√†o ph·∫£i t·∫°o file sw.js (m√¨nh ƒë∆∞a d∆∞·ªõi)
    const APP_PUBLIC_KEY_NAME = "WEB_PUSH_PUBLIC_KEY"; // public VAPID key do Edge Function tr·∫£ v·ªÅ

    // =========================
    // 2) Connect to Supabase
    // =========================
    async function connect(){
      try{
        if(!CFG?.url || !CFG?.key || !CFG?.familyCode){
          $("#pillState").textContent="Ch∆∞a k·∫øt n·ªëi Cloud";
          show("#secSetup", true);
          show("#secApp", false);
          show("#tabs", false);
          return;
        }
        sb = supabase.createClient(CFG.url, CFG.key);
        $("#pillState").textContent="ƒêang k·∫øt n·ªëi...";
        // Ensure family exists by code
        await ensureFamily(CFG.familyCode);
        await refreshAll();
        setupRealtime();
        $("#pillState").textContent="Cloud OK";
        show("#secSetup", false);
        show("#secApp", true);
        show("#tabs", true);
        $("#pillFamily").textContent = "family: " + CFG.familyCode;
        toast("K·∫øt n·ªëi Cloud OK");
      }catch(e){
        console.error(e);
        $("#pillState").textContent="L·ªói k·∫øt n·ªëi";
        toast("L·ªói Cloud. Ki·ªÉm tra URL/KEY/RLS");
      }
    }

    async function ensureFamily(code){
      // families: {id, family_code, name, address, created_at}
      const { data: exist, error: e1 } = await sb
        .from("families").select("*")
        .eq("family_code", code).maybeSingle();
      if(e1) throw e1;

      if(exist){
        family = exist; familyId = exist.id;
        $("#appTitle").textContent = (exist.name || "Gia ph·∫£ h·ªç B√πi") + " ‚Ä¢ CLOUD PWA";
        return;
      }
      // create new family (public by code)
      const { data: created, error: e2 } = await sb
        .from("families")
        .insert({ family_code: code, name: "Gia ph·∫£ h·ªç B√πi", address: "Thanh H√≥a", author: "B√πi H√†o" })
        .select().single();
      if(e2) throw e2;
      family = created; familyId = created.id;
      $("#appTitle").textContent = (created.name || "Gia ph·∫£ h·ªç B√πi") + " ‚Ä¢ CLOUD PWA";
    }

    // =========================
    // 3) Data load + render
    // =========================
    async function refreshAll(){
      await Promise.all([loadPeople(), loadEvents(), loadNotis(), loadPushSubs()]);
      renderHome();
      renderPeople(people);
      renderEvents(events);
      updateBell();
      updateKPI();
    }

    async function loadPeople(){
      const { data, error } = await sb.from("persons")
        .select("*").eq("family_id", familyId)
        .order("created_at", {ascending:false});
      if(error) throw error;
      people = data || [];
    }

    async function loadEvents(){
      const { data, error } = await sb.from("events")
        .select("*").eq("family_id", familyId)
        .order("created_at", {ascending:false});
      if(error) throw error;
      events = data || [];
    }

    async function loadNotis(){
      const { data, error } = await sb.from("notifications")
        .select("*").eq("family_id", familyId)
        .order("created_at", {ascending:false})
        .limit(50);
      if(error) throw error;
      notis = data || [];
      // unread: those not in local read set
      const read = JSON.parse(localStorage.getItem("BUI_NOTI_READ_"+familyId) || "[]");
      const readSet = new Set(read);
      unreadNoti = notis.filter(n=>!readSet.has(n.id)).length;
    }

    async function loadPushSubs(){
      const { data, error } = await sb.from("push_subscriptions")
        .select("*").eq("family_id", familyId);
      if(error) throw error;
      pushSubs = data || [];
    }

    function updateKPI(){
      $("#kpiPeople").textContent = people.length;
      $("#kpiEvents").textContent = events.length;
      $("#kpiNoti").textContent = notis.length;
      $("#kpiPush").textContent = pushSubs.length;
    }

    function updateBell(){
      const b = $("#bellBadge");
      if(unreadNoti>0){
        b.textContent = unreadNoti>99 ? "99+" : String(unreadNoti);
        b.classList.remove("hide");
      }else b.classList.add("hide");
    }

    function renderHome(){
      const box=$("#recentEvents");
      box.innerHTML = "";
      const take = events.slice(0,5);
      if(!take.length){
        box.innerHTML = `<div class="muted small">Ch∆∞a c√≥ s·ª± ki·ªán. B·∫•m ‚ÄúT·∫°o s·ª± ki·ªán‚Äù.</div>`;
        return;
      }
      take.forEach(ev=>{
        const a = ev.actor_name ? `üë§ ${esc(ev.actor_name)} ‚Ä¢ ` : "";
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="left">
            <div class="avatar">${ev.actor_avatar_url ? `<img src="${esc(ev.actor_avatar_url)}">` : "BU"}</div>
            <div style="min-width:0">
              <div class="name">${esc(ev.title)} <span class="pill">${esc(ev.event_type||"custom")}</span></div>
              <div class="meta">${a}${esc(ev.date_greg||"")} ${ev.date_lunar?("‚Ä¢ "+esc(ev.date_lunar)):""}</div>
            </div>
          </div>
          <button class="btn" data-id="${ev.id}">Xem</button>
        `;
        el.querySelector("button").addEventListener("click", ()=> openEvent(ev, true));
        box.appendChild(el);
      });
    }

    function renderPeople(arr){
      const box=$("#peopleList");
      box.innerHTML="";
      if(!arr.length){
        box.innerHTML=`<div class="muted small">Ch∆∞a c√≥ th√†nh vi√™n. B·∫•m ‚ÄúTh√™m ng∆∞·ªùi‚Äù.</div>`;
        return;
      }
      arr.forEach(p=>{
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML=`
          <div class="left">
            <div class="avatar">${p.avatar_url?`<img src="${esc(p.avatar_url)}">`:"BU"}</div>
            <div style="min-width:0">
              <div class="name">${esc(p.full_name)} ${p.display_role?`<span class="pill">${esc(p.display_role)}</span>`:""}</div>
              <div class="meta">${esc(p.gender||"")} ‚Ä¢ ${p.birth_year?("SN "+p.birth_year):""} ‚Ä¢ ${esc(p.hometown_province||"")}</div>
            </div>
          </div>
          <button class="btn warn">S·ª≠a</button>
        `;
        el.querySelector("button").addEventListener("click", ()=> openPerson(p));
        box.appendChild(el);
      });
    }

    function renderEvents(arr){
      const box=$("#eventList");
      box.innerHTML="";
      if(!arr.length){
        box.innerHTML=`<div class="muted small">Ch∆∞a c√≥ s·ª± ki·ªán. B·∫•m ‚ÄúT·∫°o s·ª± ki·ªán‚Äù.</div>`;
        return;
      }
      arr.forEach(ev=>{
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML=`
          <div class="left">
            <div class="avatar">${ev.actor_avatar_url?`<img src="${esc(ev.actor_avatar_url)}">`:"üìÖ"}</div>
            <div style="min-width:0">
              <div class="name">${esc(ev.title)} <span class="pill">${esc(ev.event_type||"custom")}</span></div>
              <div class="meta">T·∫°o b·ªüi ${esc(ev.actor_name||"·∫©n danh")} ‚Ä¢ ${esc(ev.date_greg||"")} ${ev.date_lunar?("‚Ä¢ "+esc(ev.date_lunar)):""}</div>
            </div>
          </div>
          <button class="btn">Xem</button>
        `;
        el.querySelector("button").addEventListener("click", ()=> openEvent(ev, true));
        box.appendChild(el);
      });
    }

    // =========================
    // 4) Realtime notifications (in-app bell)
    // =========================
    function setupRealtime(){
      try{
        if(chNoti) sb.removeChannel(chNoti);
        chNoti = sb.channel("noti_"+familyId);
        chNoti
          .on("postgres_changes",
            { event:"INSERT", schema:"public", table:"notifications", filter:`family_id=eq.${familyId}` },
            payload=>{
              const n = payload.new;
              // update UI instantly
              notis.unshift(n);
              const read = JSON.parse(localStorage.getItem("BUI_NOTI_READ_"+familyId) || "[]");
              const readSet = new Set(read);
              unreadNoti = notis.filter(x=>!readSet.has(x.id)).length;
              updateBell();
              updateKPI();
              toast(`üîî ${n.title || "C√≥ th√¥ng b√°o m·ªõi"}`);
              try{ navigator.vibrate?.(60); }catch(_){}
            }
          )
          .subscribe();
      }catch(e){
        console.warn("Realtime not available", e);
      }
    }

    // =========================
    // 5) Notifications Center
    // =========================
    function openNotiCenter(){
      const read = JSON.parse(localStorage.getItem("BUI_NOTI_READ_"+familyId) || "[]");
      const readSet = new Set(read);

      const rows = (notis || []).map(n=>{
        const isUnread = !readSet.has(n.id);
        return `
          <div class="item" data-id="${n.id}" style="${isUnread?'border-color: rgba(34,197,94,.35)':''}">
            <div class="left">
              <div class="avatar">${n.actor_avatar_url?`<img src="${esc(n.actor_avatar_url)}">`:"üîî"}</div>
              <div style="min-width:0">
                <div class="name">${esc(n.title || "Th√¥ng b√°o")}${isUnread?` <span class="pill" style="border-color:rgba(34,197,94,.35)">M·ªõi</span>`:""}</div>
                <div class="meta">${esc(n.body || "")}</div>
                <div class="meta">${new Date(n.created_at).toLocaleString()}</div>
              </div>
            </div>
            <button class="btn">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
          </div>
        `;
      }).join("");

      openModal("üîî Th√¥ng b√°o", `
        <div class="row" style="margin-bottom:10px">
          <button class="btn good" id="btnMarkAll">ƒê√£ ƒë·ªçc t·∫•t c·∫£</button>
          <button class="btn" id="btnReloadNoti">T·∫£i l·∫°i</button>
        </div>
        <div class="list" id="notiList">${rows || `<div class="muted small">Ch∆∞a c√≥ th√¥ng b√°o</div>`}</div>
      `);

      $("#btnReloadNoti").addEventListener("click", async ()=>{
        await loadNotis(); updateBell(); updateKPI(); openNotiCenter();
      });

      $("#btnMarkAll").addEventListener("click", ()=>{
        const ids = notis.map(x=>x.id);
        localStorage.setItem("BUI_NOTI_READ_"+familyId, JSON.stringify(ids));
        unreadNoti = 0; updateBell();
        toast("ƒê√£ ƒë·ªçc t·∫•t c·∫£");
        closeModal();
      });

      $("#notiList").addEventListener("click", (e)=>{
        const item = e.target.closest(".item");
        if(!item) return;
        const id = item.dataset.id;
        // mark read
        const cur = JSON.parse(localStorage.getItem("BUI_NOTI_READ_"+familyId) || "[]");
        if(!cur.includes(id)) cur.push(id);
        localStorage.setItem("BUI_NOTI_READ_"+familyId, JSON.stringify(cur));
        unreadNoti = Math.max(0, unreadNoti-1);
        updateBell();
        toast("ƒê√£ ƒë√°nh d·∫•u ƒë·ªçc");
        item.style.borderColor = "rgba(255,255,255,.12)";
        const pill = item.querySelector(".pill");
        if(pill) pill.remove();
      });
    }

    // =========================
    // 6) People (simple form)
    // =========================
    function openPerson(p){
      openModal("üë§ S·ª≠a th√†nh vi√™n", `
        <div class="grid two">
          <div class="field"><label>H·ªç v√† t√™n</label><input id="p_name" value="${esc(p.full_name||"")}"></div>
          <div class="field"><label>Vai v·∫ø</label><input id="p_role" value="${esc(p.display_role||"")}"></div>

          <div class="field"><label>Gi·ªõi t√≠nh</label>
            <select id="p_gender">
              ${["Nam","N·ªØ","Kh√°c"].map(x=>`<option ${p.gender===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field"><label>NƒÉm sinh</label><input id="p_birth" value="${esc(p.birth_year||"")}" placeholder="1989"></div>

          <div class="field"><label>Qu√™ qu√°n (t·ªânh)</label><input id="p_home" value="${esc(p.hometown_province||"")}"></div>
          <div class="field"><label>SƒêT</label><input id="p_phone" value="${esc(p.phone||"")}"></div>

          <div class="field" style="grid-column:1/-1"><label>Ti·ªÉu s·ª≠</label><textarea id="p_bio">${esc(p.bio||"")}</textarea></div>

          <div class="field" style="grid-column:1/-1">
            <label>·∫¢nh ƒë·∫°i di·ªán (URL)</label>
            <input id="p_avatar" value="${esc(p.avatar_url||"")}" placeholder="https://...jpg">
            <div class="muted small">B·∫£n v1 d√πng URL. B·∫£n n√¢ng cao m·ªõi upload Storage.</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnSaveP">L∆∞u</button>
        </div>
      `);

      $("#btnSaveP").addEventListener("click", async ()=>{
        const payload = {
          full_name: $("#p_name").value.trim(),
          display_role: $("#p_role").value.trim(),
          gender: $("#p_gender").value,
          birth_year: parseInt($("#p_birth").value,10) || null,
          hometown_province: $("#p_home").value.trim(),
          phone: $("#p_phone").value.trim(),
          bio: $("#p_bio").value,
          avatar_url: $("#p_avatar").value.trim(),
          updated_at: new Date().toISOString()
        };
        if(!payload.full_name) return toast("Thi·∫øu h·ªç t√™n");
        const { error } = await sb.from("persons").update(payload).eq("id", p.id);
        if(error) return toast("L·ªói l∆∞u: "+error.message);
        toast("ƒê√£ l∆∞u");
        closeModal();
        await refreshAll();
      });
    }

    async function openAddPerson(){
      openModal("Ôºã Th√™m ng∆∞·ªùi", `
        <div class="grid two">
          <div class="field"><label>H·ªç v√† t√™n*</label><input id="np_name" placeholder="B√πi VƒÉn ..."></div>
          <div class="field"><label>Vai v·∫ø</label><input id="np_role" placeholder="C·ª• t·ªï / √îng / B·ªë..."></div>
          <div class="field"><label>Gi·ªõi t√≠nh</label>
            <select id="np_gender"><option>Nam</option><option>N·ªØ</option><option>Kh√°c</option></select>
          </div>
          <div class="field"><label>NƒÉm sinh</label><input id="np_birth" placeholder="1989"></div>
          <div class="field"><label>Qu√™ qu√°n (t·ªânh)</label><input id="np_home" placeholder="Thanh H√≥a"></div>
          <div class="field"><label>·∫¢nh (URL)</label><input id="np_avatar" placeholder="https://...jpg"></div>
          <div class="field" style="grid-column:1/-1"><label>Ti·ªÉu s·ª≠</label><textarea id="np_bio" placeholder="..."></textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnCreateP">T·∫°o</button>
        </div>
      `);

      $("#btnCreateP").addEventListener("click", async ()=>{
        const payload = {
          family_id: familyId,
          full_name: $("#np_name").value.trim(),
          display_role: $("#np_role").value.trim(),
          gender: $("#np_gender").value,
          birth_year: parseInt($("#np_birth").value,10) || null,
          hometown_province: $("#np_home").value.trim(),
          bio: $("#np_bio").value,
          avatar_url: $("#np_avatar").value.trim()
        };
        if(!payload.full_name) return toast("Thi·∫øu h·ªç t√™n");
        const { error } = await sb.from("persons").insert(payload);
        if(error) return toast("L·ªói t·∫°o: "+error.message);
        toast("ƒê√£ t·∫°o");
        closeModal();
        await refreshAll();
      });
    }

    // =========================
    // 7) Events + Push to all (core idea of H√†o)
    // =========================
    function openEvent(ev, readonly=false){
      openModal("üìÖ Chi ti·∫øt s·ª± ki·ªán", `
        <div class="grid two">
          <div class="field"><label>Ti√™u ƒë·ªÅ</label><input id="ev_title" ${readonly?"disabled":""} value="${esc(ev.title||"")}"></div>
          <div class="field"><label>Lo·∫°i</label>
            <select id="ev_type" ${readonly?"disabled":""}>
              ${["gi·ªó","h·ªçp h·ªç","c∆∞·ªõi","tang","khao th·ªç","custom"].map(x=>`<option ${ev.event_type===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field"><label>Ng√†y d∆∞∆°ng (text)</label><input id="ev_greg" ${readonly?"disabled":""} value="${esc(ev.date_greg||"")}"></div>
          <div class="field"><label>Ng√†y √¢m (text)</label><input id="ev_lunar" ${readonly?"disabled":""} value="${esc(ev.date_lunar||"")}"></div>
          <div class="field" style="grid-column:1/-1"><label>Ghi ch√∫</label><textarea id="ev_note" ${readonly?"disabled":""}>${esc(ev.note||"")}</textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          ${readonly?``:`<button class="btn good" id="btnSaveEv">L∆∞u</button>`}
        </div>
      `);
      if(!readonly){
        $("#btnSaveEv").addEventListener("click", async ()=>{
          const payload = {
            title: $("#ev_title").value.trim(),
            event_type: $("#ev_type").value,
            date_greg: $("#ev_greg").value.trim(),
            date_lunar: $("#ev_lunar").value.trim(),
            note: $("#ev_note").value
          };
          if(!payload.title) return toast("Thi·∫øu ti√™u ƒë·ªÅ");
          const { error } = await sb.from("events").update(payload).eq("id", ev.id);
          if(error) return toast("L·ªói: "+error.message);
          toast("ƒê√£ l∆∞u"); closeModal(); await refreshAll();
        });
      }
    }

    function openCreateEvent(){
      // actor info (simple): ask name + avatar URL to show in push + in app.
      openModal("Ôºã T·∫°o s·ª± ki·ªán (s·∫Ω b·∫Øn chu√¥ng t·ªõi c·∫£ h·ªç)", `
        <div class="hint small muted" style="margin-bottom:10px">
          Khi b·∫•m ‚ÄúT·∫°o & B√°o c·∫£ h·ªç‚Äù:  
          1) L∆∞u s·ª± ki·ªán v√†o Cloud  
          2) T·∫°o 1 th√¥ng b√°o k√®m <b>t√™n + ·∫£nh ng∆∞·ªùi t·∫°o</b>  
          3) G·ªçi Edge Function ƒë·ªÉ g·ª≠i <b>Push Notification</b> t·ªõi t·∫•t c·∫£ m√°y ƒë√£ ‚ÄúB·∫≠t th√¥ng b√°o‚Äù
        </div>
        <div class="grid two">
          <div class="field"><label>T√™n ng∆∞·ªùi t·∫°o*</label><input id="ac_name" placeholder="B√πi H√†o"></div>
          <div class="field"><label>·∫¢nh ng∆∞·ªùi t·∫°o (URL)</label><input id="ac_avatar" placeholder="https://...jpg"></div>

          <div class="field"><label>Ti√™u ƒë·ªÅ s·ª± ki·ªán*</label><input id="ne_title" placeholder="V√≠ d·ª•: Gi·ªó c·ª• t·ªï / H·ªçp h·ªç / Nh√† c√≥ vi·ªác..."></div>
          <div class="field"><label>Lo·∫°i</label>
            <select id="ne_type">
              ${["gi·ªó","h·ªçp h·ªç","c∆∞·ªõi","tang","khao th·ªç","custom"].map(x=>`<option>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field"><label>Ng√†y d∆∞∆°ng (text)</label><input id="ne_greg" placeholder="2026-02-05 ho·∫∑c 05/02/2026"></div>
          <div class="field"><label>Ng√†y √¢m (text)</label><input id="ne_lunar" placeholder="10/10 Canh Ng·ªç..."></div>
          <div class="field" style="grid-column:1/-1"><label>N·ªôi dung / ghi ch√∫</label><textarea id="ne_note" placeholder="ƒê·ªãa ƒëi·ªÉm, gi·ªù, vi·ªác c·∫ßn chu·∫©n b·ªã..."></textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnCreateAndPush">T·∫°o & B√°o c·∫£ h·ªç üîî</button>
        </div>
      `);

      $("#btnCreateAndPush").addEventListener("click", async ()=>{
        const actor_name = $("#ac_name").value.trim();
        const actor_avatar_url = $("#ac_avatar").value.trim();
        const title = $("#ne_title").value.trim();
        const event_type = $("#ne_type").value;
        const date_greg = $("#ne_greg").value.trim();
        const date_lunar = $("#ne_lunar").value.trim();
        const note = $("#ne_note").value;

        if(!actor_name) return toast("Thi·∫øu t√™n ng∆∞·ªùi t·∫°o");
        if(!title) return toast("Thi·∫øu ti√™u ƒë·ªÅ s·ª± ki·ªán");

        try{
          // 1) insert event
          const { data: ev, error: e1 } = await sb.from("events")
            .insert({ family_id: familyId, title, event_type, date_greg, date_lunar, note, actor_name, actor_avatar_url })
            .select().single();
          if(e1) return toast("L·ªói t·∫°o s·ª± ki·ªán: "+e1.message);

          // 2) create notification record (for bell + realtime)
          const notiTitle = "Nh√† c√≥ vi·ªác: " + title;
          const notiBody = `${actor_name} v·ª´a t·∫°o s·ª± ki·ªán ‚Ä¢ ${date_greg||""} ${date_lunar?("("+date_lunar+")"):""}`;
          const { data: n, error: e2 } = await sb.from("notifications")
            .insert({
              family_id: familyId,
              type: "event_created",
              title: notiTitle,
              body: notiBody,
              actor_name,
              actor_avatar_url,
              payload: { event_id: ev.id, event_type }
            })
            .select().single();
          if(e2) return toast("L·ªói t·∫°o th√¥ng b√°o: "+e2.message);

          // 3) call Edge Function to send push to all (must exist)
          const { data: fx, error: e3 } = await sb.functions.invoke("send-push", {
            body: {
              family_id: familyId,
              title: notiTitle,
              body: notiBody,
              url: location.href, // click opens app
              icon: actor_avatar_url || null,
              tag: "family-event"
            }
          });
          if(e3){
            console.warn(e3);
            toast("ƒê√£ t·∫°o s·ª± ki·ªán (push ch∆∞a g·ª≠i). C·∫ßn c√†i Edge Function send-push");
          }else{
            toast("ƒê√£ t·∫°o + g·ª≠i th√¥ng b√°o t·ªõi c·∫£ h·ªç ‚úÖ");
          }

          closeModal();
          await refreshAll();
          goTab("home");

        }catch(err){
          console.error(err);
          toast("L·ªói t·∫°o s·ª± ki·ªán");
        }
      });
    }

    // =========================
    // 8) Push: enable + store subscription to Supabase
    // =========================
    async function enablePushFlow(){
      if(!sb || !familyId) return toast("Ch∆∞a k·∫øt n·ªëi Cloud");

      if(!("serviceWorker" in navigator) || !("PushManager" in window)){
        return toast("M√°y/Tr√¨nh duy·ªát ch∆∞a h·ªó tr·ª£ Push");
      }

      // 1) register service worker
      let reg = null;
      try{
        reg = await navigator.serviceWorker.register(SW_PATH, { scope: "./" });
      }catch(e){
        console.error(e);
        return toast("Thi·∫øu file sw.js ho·∫∑c ƒëƒÉng k√Ω SW l·ªói");
      }

      // 2) request permission
      const perm = await Notification.requestPermission();
      if(perm !== "granted") return toast("B·∫°n ch∆∞a cho ph√©p th√¥ng b√°o");

      // 3) get VAPID public key from Edge Function
      let publicKey = null;
      try{
        const { data, error } = await sb.functions.invoke("public-vapid-key", { body: {} });
        if(error) throw error;
        publicKey = data?.publicKey;
      }catch(e){
        console.warn(e);
        return toast("Thi·∫øu Edge Function public-vapid-key (tr·∫£ VAPID public key)");
      }
      if(!publicKey) return toast("Kh√¥ng c√≥ public key");

      // 4) subscribe
      let sub = await reg.pushManager.getSubscription();
      if(!sub){
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey)
        });
      }

      // 5) save subscription to DB (unique by endpoint)
      const payload = {
        family_id: familyId,
        endpoint: sub.endpoint,
        p256dh: arrayBufferToBase64(sub.getKey("p256dh")),
        auth: arrayBufferToBase64(sub.getKey("auth")),
        user_agent: navigator.userAgent,
        created_at: new Date().toISOString()
      };

      const { error: e1 } = await sb.from("push_subscriptions").upsert(payload, { onConflict: "endpoint" });
      if(e1) return toast("L·ªói l∆∞u subscription: "+e1.message);

      toast("ƒê√£ b·∫≠t th√¥ng b√°o ‚úÖ");
      await loadPushSubs(); updateKPI();
    }

    // =========================
    // 9) Tabs / nav
    // =========================
    function goTab(tab){
      $(".tab[data-tab='home']").classList.toggle("on", tab==="home");
      $(".tab[data-tab='people']").classList.toggle("on", tab==="people");
      $(".tab[data-tab='events']").classList.toggle("on", tab==="events");

      show("#secApp", tab==="home");
      show("#secPeople", tab==="people");
      show("#secEvents", tab==="events");
    }
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=> goTab(t.dataset.tab));
    });

    // =========================
    // 10) Wire buttons
    // =========================
    $("#btnSaveCfg").addEventListener("click", ()=>{
      const url = $("#cfgUrl").value.trim();
      const key = $("#cfgKey").value.trim();
      const familyCode = $("#cfgFamilyCode").value.trim();
      if(!url || !key || !familyCode) return toast("Thi·∫øu URL/KEY/M√£ gia ph·∫£");
      CFG = { url, key, familyCode };
      localStorage.setItem(LSKEY, JSON.stringify(CFG));
      toast("ƒê√£ l∆∞u c·∫•u h√¨nh");
      connect();
    });

    $("#btnClearCfg").addEventListener("click", ()=>{
      localStorage.removeItem(LSKEY);
      toast("ƒê√£ x√≥a c·∫•u h√¨nh");
      location.reload();
    });

    $("#btnRefresh").addEventListener("click", async ()=>{
      try{ await refreshAll(); toast("ƒê√£ t·∫£i l·∫°i"); }
      catch(e){ console.error(e); toast("L·ªói t·∫£i l·∫°i"); }
    });

    $("#btnOpenPeople").addEventListener("click", ()=> goTab("people"));
    $("#btnBackHome1").addEventListener("click", ()=> goTab("home"));
    $("#btnBackHome2").addEventListener("click", ()=> goTab("home"));

    $("#btnSearch").addEventListener("click", ()=>{
      const k = $("#q").value.trim().toLowerCase();
      if(!k) return renderPeople(people);
      const arr = people.filter(p=>{
        return (p.full_name||"").toLowerCase().includes(k)
          || String(p.birth_year||"").includes(k)
          || (p.hometown_province||"").toLowerCase().includes(k)
          || (p.phone||"").toLowerCase().includes(k);
      });
      renderPeople(arr);
    });

    $("#btnAddPerson").addEventListener("click", openAddPerson);
    $("#btnAddPerson2").addEventListener("click", openAddPerson);

    $("#btnCreateEvent").addEventListener("click", openCreateEvent);
    $("#btnCreateEventTop").addEventListener("click", openCreateEvent);

    $("#btnBell").addEventListener("click", ()=> openNotiCenter());
    $("#btnOpenNoti").addEventListener("click", ()=> openNotiCenter());

    $("#btnEnablePush").addEventListener("click", enablePushFlow);

    // =========================
    // 11) Init
    // =========================
    connect();

    // =========================
    // 12) Util for VAPID conversion
    // =========================
    function urlBase64ToUint8Array(base64String){
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i=0; i<rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }
    function arrayBufferToBase64(buffer){
      if(!buffer) return null;
      const bytes = new Uint8Array(buffer);
      let binary = "";
      for(let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }
  </script>
</body>
</html>
