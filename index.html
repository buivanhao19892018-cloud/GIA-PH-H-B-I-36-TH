<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Gia ph·∫£ h·ªç B√πi ‚Ä¢ CLOUD PWA</title>
  <meta name="theme-color" content="#7f1d1d" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0b1020; --card:#0f1730; --card2:#0b1329;
      --text:#e8f0ff; --muted:#a8b7d6; --line:rgba(255,255,255,.08);
      --brand:#7f1d1d; --brand2:#b91c1c; --good:#22c55e; --warn:#f59e0b;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --r:18px;
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:radial-gradient(1100px 700px at 20% 0%, rgba(185,28,28,.22), transparent 60%), var(--bg); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1000px; margin:0 auto; padding:14px 14px 90px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:linear-gradient(135deg, rgba(127,29,29,.95), rgba(15,23,48,.65));
      border:1px solid var(--line); border-radius:22px; padding:14px 14px;
      box-shadow:var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px; height:46px; border-radius:16px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%), rgba(0,0,0,.25);
      display:grid; place-items:center; border:1px solid rgba(255,255,255,.14);
      font-weight:800;
    }
    .title{font-weight:800; font-size:16px; line-height:1.1}
    .sub{color:rgba(255,255,255,.8); font-size:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px; border-radius:14px;
      font-weight:700; cursor:pointer;
    }
    .btn.primary{background:linear-gradient(135deg, var(--brand2), var(--brand)); border-color:rgba(255,255,255,.18)}
    .btn.good{background:linear-gradient(135deg, rgba(34,197,94,.9), rgba(22,163,74,.9))}
    .btn.warn{background:linear-gradient(135deg, rgba(245,158,11,.95), rgba(217,119,6,.95))}
    .btn.danger{background:linear-gradient(135deg, rgba(239,68,68,.95), rgba(185,28,28,.95))}
    .card{
      margin-top:14px;
      border:1px solid var(--line); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{display:flex; justify-content:space-between; align-items:center; padding:12px 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.18)}
    .card .hd h3{margin:0; font-size:14px}
    .card .bd{padding:12px}
    .grid{display:grid; gap:10px}
    @media(min-width:900px){ .grid.two{grid-template-columns:1fr 1fr} .grid.three{grid-template-columns:1.2fr .8fr .8fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22); color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .muted{color:var(--muted)}
    .pill{padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(0,0,0,.25); font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.12); border-radius:16px;
      background:rgba(0,0,0,.2); padding:10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .left{display:flex; gap:10px; align-items:center; min-width:0}
    .avatar{width:44px; height:44px; border-radius:14px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); overflow:hidden; flex:0 0 auto}
    .avatar img{width:100%; height:100%; object-fit:cover}
    .name{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:56vw}
    .meta{font-size:12px; color:var(--muted)}
    .tabs{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(11,16,32,.88);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      padding:10px 10px env(safe-area-inset-bottom);
      display:flex; gap:10px; justify-content:center;
    }
    .tab{width:min(160px, 22vw); text-align:center; padding:10px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); cursor:pointer; font-weight:800}
    .tab.on{background:linear-gradient(135deg, rgba(185,28,28,.92), rgba(127,29,29,.92))}
    .hide{display:none !important}
    .toast{position:fixed; top:12px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.75); border:1px solid rgba(255,255,255,.18); padding:10px 12px; border-radius:14px; z-index:99; max-width:92vw}
    .treeBox{border:1px dashed rgba(255,255,255,.16); border-radius:16px; padding:10px; overflow:auto; background:rgba(0,0,0,.18)}
    svg{max-width:100%}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">BU</div>
        <div>
          <div class="title">Gia ph·∫£ h·ªç B√πi ‚Ä¢ CLOUD PWA</div>
          <div class="sub">T√°c gi·∫£: <b>B√πi H√†o</b> ‚Ä¢ Supabase + GitHub Pages</div>
        </div>
      </div>
      <div class="row">
        <span class="pill" id="pillUser">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
        <button class="btn" id="btnLogout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <!-- AUTH -->
    <section class="card" id="secAuth">
      <div class="hd"><h3>1) ƒêƒÉng nh·∫≠p</h3><span class="muted small">Email OTP (kh√¥ng c·∫ßn m·∫≠t kh·∫©u)</span></div>
      <div class="bd grid two">
        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="vd: buihao@gmail.com" />
        </div>
        <div class="row" style="align-items:flex-end">
          <button class="btn primary" id="btnSendOtp">G·ª≠i m√£ OTP</button>
          <button class="btn" id="btnMagic">G·ª≠i link ƒëƒÉng nh·∫≠p</button>
        </div>
        <div class="field">
          <label>M√£ OTP (n·∫øu d√πng OTP)</label>
          <input id="otp" placeholder="6 s·ªë" />
        </div>
        <div class="row" style="align-items:flex-end">
          <button class="btn good" id="btnVerify">X√°c nh·∫≠n OTP</button>
        </div>
        <div class="muted small">
          * N·∫øu email ch∆∞a nh·∫≠n ƒë∆∞·ª£c: ki·ªÉm tra Spam/Qu·∫£ng c√°o.  
          * C√≥ th·ªÉ d√πng ‚Äúlink ƒëƒÉng nh·∫≠p‚Äù cho d·ªÖ.
        </div>
      </div>
    </section>

    <!-- FAMILY -->
    <section class="card hide" id="secFamily">
      <div class="hd">
        <h3>2) Gia ph·∫£</h3>
        <div class="row">
          <button class="btn" id="btnReload">T·∫£i l·∫°i</button>
          <button class="btn primary" id="btnNewFamily">T·∫°o gia ph·∫£ m·ªõi</button>
        </div>
      </div>
      <div class="bd grid two">
        <div>
          <div class="field">
            <label>Ch·ªçn gia ph·∫£</label>
            <select id="familySelect"></select>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn good" id="btnOpenFamily">M·ªü</button>
            <button class="btn warn" id="btnInvite">M·ªùi th√†nh vi√™n</button>
          </div>
          <div class="muted small" style="margin-top:10px">
            Quy·ªÅn: <b>Owner</b> c√≥ th·ªÉ m·ªùi/x√≥a/ƒë·ªïi quy·ªÅn. Editor ƒë∆∞·ª£c th√™m/s·ª≠a. Viewer ch·ªâ xem.
          </div>
        </div>

        <div class="card" style="margin:0">
          <div class="hd"><h3>T·∫°o gia ph·∫£ m·ªõi</h3></div>
          <div class="bd grid">
            <div class="field">
              <label>T√™n gia ph·∫£</label>
              <input id="famName" value="Gia ph·∫£ h·ªç B√πi" />
            </div>
            <div class="field">
              <label>ƒê·ªãa ch·ªâ / qu√™ qu√°n</label>
              <input id="famAddr" placeholder="Thanh H√≥a, ..." />
            </div>
            <button class="btn primary" id="btnCreateFamily">T·∫°o + l√†m Owner</button>
          </div>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="card hide" id="secApp">
      <div class="hd">
        <h3 id="hFamily">3) Qu·∫£n l√Ω</h3>
        <div class="row">
          <span class="pill" id="pillRole">role: -</span>
          <button class="btn" id="btnBackup">Export</button>
          <button class="btn" id="btnRestore">Import</button>
        </div>
      </div>
      <div class="bd">
        <!-- Screens -->
        <div id="screenDashboard">
          <div class="grid two">
            <div class="card" style="margin:0">
              <div class="hd"><h3>T·ªïng quan</h3></div>
              <div class="bd">
                <div class="row">
                  <span class="pill" id="statPeople">0 th√†nh vi√™n</span>
                  <span class="pill" id="statEvents">0 s·ª± ki·ªán</span>
                  <span class="pill" id="statPhotos">0 ·∫£nh</span>
                </div>
                <p class="muted small" style="margin-top:10px">
                  G·ª£i √Ω: nh·∫≠p ‚ÄúC·ª• t·ªï‚Äù tr∆∞·ªõc ‚Üí th√™m con/ch√°u ‚Üí t·∫°o quan h·ªá.  
                  ·∫¢nh l∆∞u Cloud trong Supabase Storage.
                </p>
              </div>
            </div>
            <div class="card" style="margin:0">
              <div class="hd"><h3>Thao t√°c nhanh</h3></div>
              <div class="bd row">
                <button class="btn primary" id="btnAddPersonQuick">+ Th√™m ng∆∞·ªùi</button>
                <button class="btn" id="btnAddRelationQuick">+ Th√™m quan h·ªá</button>
                <button class="btn" id="btnAddEventQuick">+ S·ª± ki·ªán</button>
              </div>
            </div>
          </div>
        </div>

        <div id="screenPeople" class="hide">
          <div class="row" style="margin-bottom:10px">
            <input id="q" style="flex:1; min-width:220px" placeholder="T√¨m t√™n, nƒÉm sinh, qu√™ qu√°n..." />
            <button class="btn" id="btnSearch">T√¨m</button>
            <button class="btn primary" id="btnAddPerson">+ Th√™m</button>
          </div>
          <div class="list" id="peopleList"></div>
        </div>

        <div id="screenTree" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn" id="btnBuildTree">V·∫Ω c√¢y</button>
            <select id="rootSelect" style="flex:1; min-width:220px"></select>
          </div>
          <div class="treeBox" id="treeBox">
            <div class="muted small">Ch·ªçn ‚Äúg·ªëc‚Äù r·ªìi b·∫•m V·∫Ω c√¢y (demo). B·∫£n n√¢ng cao s·∫Ω zoom/pan + layout ƒë·∫πp h∆°n.</div>
          </div>
        </div>

        <div id="screenEvents" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" id="btnAddEvent">+ Th√™m s·ª± ki·ªán</button>
            <button class="btn" id="btnRefreshEvents">T·∫£i l·∫°i</button>
          </div>
          <div class="list" id="eventList"></div>
        </div>

        <div id="screenNotes" class="hide">
          <div class="row" style="margin-bottom:10px">
            <button class="btn" data-kind="phaky" id="btnOpenPhaky">Ph·∫£ k√Ω</button>
            <button class="btn" data-kind="tuduong" id="btnOpenTuduong">T·ª´ ƒë∆∞·ªùng</button>
            <span class="pill" id="noteKind">-</span>
          </div>
          <div class="grid">
            <div class="field">
              <label>Ti√™u ƒë·ªÅ</label>
              <input id="noteTitle" />
            </div>
            <div class="field">
              <label>N·ªôi dung</label>
              <textarea id="noteContent" placeholder="Vi·∫øt l·ªãch s·ª≠ d√≤ng h·ªç / quy ∆∞·ªõc t·ª´ ƒë∆∞·ªùng..."></textarea>
            </div>
            <div class="row">
              <button class="btn good" id="btnSaveNote">L∆∞u</button>
            </div>
          </div>
        </div>

        <!-- MODALS (simple) -->
        <div class="card hide" id="modal" style="margin-top:14px">
          <div class="hd">
            <h3 id="mTitle">Modal</h3>
            <button class="btn" id="mClose">ƒê√≥ng</button>
          </div>
          <div class="bd" id="mBody"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="tabs hide" id="tabs">
    <div class="tab on" data-tab="dashboard">Gia ph·∫£</div>
    <div class="tab" data-tab="tree">C√¢y</div>
    <div class="tab" data-tab="people">Th√†nh vi√™n</div>
    <div class="tab" data-tab="events">S·ª± ki·ªán</div>
    <div class="tab" data-tab="notes">Ph·∫£ k√Ω</div>
  </div>

  <div class="toast hide" id="toast"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG (H√ÄO THAY 2 D√íNG N√ÄY) ======
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== STATE ======
    let user = null;
    let familyId = null;
    let family = null;
    let role = null;
    let cachePeople = [];
    let cacheRelations = [];
    let cacheEvents = [];
    let cacheMedia = [];
    let currentNoteKind = "phaky";
    let currentNoteId = null;

    // ====== UI HELPERS ======
    const $ = s => document.querySelector(s);
    const toast = (msg) => {
      const t = $("#toast"); t.textContent = msg; t.classList.remove("hide");
      setTimeout(()=>t.classList.add("hide"), 2200);
    };
    const show = (id, on=true) => $(id).classList.toggle("hide", !on);

    // ====== AUTH ======
    async function refreshSession(){
      const { data } = await sb.auth.getSession();
      user = data.session?.user || null;
      $("#pillUser").textContent = user ? (user.email || user.id) : "Ch∆∞a ƒëƒÉng nh·∫≠p";
      show("#secAuth", !user);
      show("#secFamily", !!user);
      show("#btnLogout", !!user);
      if(user) await loadFamilies();
    }

    async function sendOtp(email){
      const { error } = await sb.auth.signInWithOtp({ email, options: { shouldCreateUser: true } });
      if(error) return toast("L·ªói g·ª≠i OTP: " + error.message);
      toast("ƒê√£ g·ª≠i OTP v·ªÅ email");
    }
    async function sendMagic(email){
      const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } });
      if(error) return toast("L·ªói: " + error.message);
      toast("ƒê√£ g·ª≠i link ƒëƒÉng nh·∫≠p");
    }
    async function verifyOtp(email, token){
      // Supabase v2: verifyOtp
      const { error } = await sb.auth.verifyOtp({ email, token, type: "email" });
      if(error) return toast("Sai OTP: " + error.message);
      toast("ƒêƒÉng nh·∫≠p OK");
      await refreshSession();
    }

    // ====== FAMILIES ======
    async function loadFamilies(){
      const { data, error } = await sb
        .from("memberships")
        .select("family_id, role, families(name,address)")
        .eq("user_id", user.id)
        .order("created_at", { ascending:false });
      if(error){ toast("L·ªói t·∫£i gia ph·∫£: " + error.message); return; }

      const sel = $("#familySelect");
      sel.innerHTML = "";
      data.forEach((m, idx)=>{
        const opt = document.createElement("option");
        opt.value = m.family_id;
        opt.textContent = `${m.families?.name || "Gia ph·∫£"} ‚Ä¢ ${m.role}`;
        opt.dataset.role = m.role;
        opt.dataset.name = m.families?.name || "";
        opt.dataset.addr = m.families?.address || "";
        sel.appendChild(opt);
      });
      if(data.length===0){
        sel.innerHTML = `<option value="">(Ch∆∞a c√≥ gia ph·∫£) - b·∫•m T·∫°o m·ªõi</option>`;
      }
      toast("T·∫£i danh s√°ch OK");
    }

    async function createFamily(name, address){
      if(!name.trim()) return toast("Nh·∫≠p t√™n gia ph·∫£");
      // create family
      const { data: fam, error: e1 } = await sb.from("families")
        .insert({ name, address, created_by: user.id })
        .select().single();
      if(e1) return toast("L·ªói t·∫°o gia ph·∫£: " + e1.message);
      // add membership owner
      const { error: e2 } = await sb.from("memberships")
        .insert({ family_id: fam.id, user_id: user.id, role: "owner" });
      if(e2) return toast("L·ªói set owner: " + e2.message);
      toast("ƒê√£ t·∫°o gia ph·∫£");
      await loadFamilies();
      $("#familySelect").value = fam.id;
    }

    async function openFamily(fid){
      if(!fid) return toast("Ch∆∞a ch·ªçn gia ph·∫£");
      familyId = fid;
      // get role
      const { data: mem, error: e0 } = await sb.from("memberships")
        .select("role, families(name,address)")
        .eq("family_id", familyId).eq("user_id", user.id).single();
      if(e0) return toast("Kh√¥ng c√≥ quy·ªÅn: " + e0.message);
      role = mem.role; family = { id: familyId, name: mem.families?.name, address: mem.families?.address };
      $("#pillRole").textContent = "role: " + role;
      $("#hFamily").textContent = `3) ${family.name || "Gia ph·∫£"} ‚Ä¢ ${family.address || ""}`;

      show("#secApp", true);
      show("#tabs", true);
      await preloadAll();
      goTab("dashboard");
    }

    // ====== DATA ======
    async function preloadAll(){
      await Promise.all([loadPeople(), loadRelations(), loadEvents(), loadMedia()]);
      updateStats();
      fillRootSelect();
    }

    async function loadPeople(){
      const { data, error } = await sb.from("persons")
        .select("*")
        .eq("family_id", familyId)
        .order("created_at", {ascending:false});
      if(error){ toast("L·ªói people: "+error.message); return; }
      cachePeople = data || [];
      renderPeople(cachePeople);
      fillRootSelect();
    }

    async function loadRelations(){
      const { data, error } = await sb.from("relations")
        .select("*")
        .eq("family_id", familyId);
      if(error){ toast("L·ªói relations: "+error.message); return; }
      cacheRelations = data || [];
    }

    async function loadEvents(){
      const { data, error } = await sb.from("events")
        .select("*")
        .eq("family_id", familyId)
        .order("created_at", {ascending:false});
      if(error){ toast("L·ªói events: "+error.message); return; }
      cacheEvents = data || [];
      renderEvents(cacheEvents);
    }

    async function loadMedia(){
      const { data, error } = await sb.from("media")
        .select("*")
        .eq("family_id", familyId)
        .order("created_at", {ascending:false});
      if(error){ toast("L·ªói media: "+error.message); return; }
      cacheMedia = data || [];
    }

    function updateStats(){
      $("#statPeople").textContent = `${cachePeople.length} th√†nh vi√™n`;
      $("#statEvents").textContent = `${cacheEvents.length} s·ª± ki·ªán`;
      $("#statPhotos").textContent = `${cacheMedia.length} ·∫£nh`;
    }

    // ====== PEOPLE UI ======
    function renderPeople(arr){
      const box = $("#peopleList");
      box.innerHTML = "";
      arr.forEach(p=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div class="avatar">${p.avatar_url ? `<img src="${p.avatar_url}">` : ""}</div>
            <div style="min-width:0">
              <div class="name">${escapeHtml(p.full_name)} ${p.display_role?`<span class="pill">${escapeHtml(p.display_role)}</span>`:""}</div>
              <div class="meta">${escapeHtml(p.gender||"")} ‚Ä¢ ${fmtY(p.birth_year)} ‚Ä¢ ${escapeHtml(p.hometown_province||"")}</div>
            </div>
          </div>
          <div class="row">
            <button class="btn" data-id="${p.id}" data-act="view">Xem</button>
            ${canWrite()?`<button class="btn warn" data-id="${p.id}" data-act="edit">S·ª≠a</button>`:""}
          </div>
        `;
        el.addEventListener("click", (e)=>{
          const b = e.target.closest("button");
          if(!b) return;
          const id = b.dataset.id;
          const act = b.dataset.act;
          const person = cachePeople.find(x=>x.id===id);
          if(act==="view") openPerson(person, false);
          if(act==="edit") openPerson(person, true);
        });
        box.appendChild(el);
      });
    }

    function fillRootSelect(){
      const sel = $("#rootSelect");
      const sel2 = $("#rootSelect"); // same
      if(!sel) return;
      sel.innerHTML = "";
      cachePeople.slice().reverse().forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.full_name;
        sel.appendChild(opt);
      });
    }

    function canWrite(){ return ["owner","editor"].includes(role); }

    function openPerson(p, editable){
      showModal(editable ? "S·ª≠a th√†nh vi√™n" : "Th√¥ng tin th√†nh vi√™n", personForm(p, editable));
      wirePersonForm(p, editable);
    }

    function personForm(p={}, editable=true){
      const dis = editable && canWrite() ? "" : "disabled";
      return `
        <div class="grid two">
          <div class="field">
            <label>·∫¢nh ƒë·∫°i di·ªán</label>
            <div class="row">
              <div class="avatar" style="width:72px;height:72px;border-radius:18px">${p.avatar_url?`<img src="${p.avatar_url}">`:""}</div>
              ${editable && canWrite() ? `<input ${dis} type="file" id="avatarFile" accept="image/*" />` : `<span class="muted small">Ch·ªâ xem</span>`}
            </div>
            <div class="muted small">·∫¢nh s·∫Ω ƒë∆∞·ª£c n√©n v√† upload l√™n Cloud.</div>
          </div>
          <div class="field">
            <label>Vai v·∫ø (C·ª• t·ªï...)</label>
            <input ${dis} id="display_role" value="${val(p.display_role)}" />
          </div>

          <div class="field">
            <label>H·ªç v√† t√™n*</label>
            <input ${dis} id="full_name" value="${val(p.full_name)}" />
          </div>
          <div class="field">
            <label>T√™n kh√°c</label>
            <input ${dis} id="other_name" value="${val(p.other_name)}" />
          </div>

          <div class="field">
            <label>Gi·ªõi t√≠nh</label>
            <select ${dis} id="gender">
              ${opt(p.gender, ["Nam","N·ªØ","Kh√°c"])}
            </select>
          </div>
          <div class="field">
            <label>T√¨nh tr·∫°ng h√¥n nh√¢n</label>
            <input ${dis} id="marital_status" value="${val(p.marital_status)}" placeholder="ƒê·ªôc th√¢n, 1 v·ª£..." />
          </div>

          <div class="field">
            <label>Ng√†y sinh (d/m/y)</label>
            <div class="row" style="width:100%">
              <input ${dis} id="birth_day" style="flex:1" value="${val(p.birth_day)}" placeholder="dd">
              <input ${dis} id="birth_month" style="flex:1" value="${val(p.birth_month)}" placeholder="mm">
              <input ${dis} id="birth_year" style="flex:1" value="${val(p.birth_year)}" placeholder="yyyy">
            </div>
          </div>

          <div class="field">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input ${dis} id="phone" value="${val(p.phone)}" />
          </div>

          <div class="field">
            <label>Tr√¨nh ƒë·ªô</label>
            <input ${dis} id="education" value="${val(p.education)}" />
          </div>
          <div class="field">
            <label>Ngh·ªÅ nghi·ªáp</label>
            <input ${dis} id="job" value="${val(p.job)}" />
          </div>

          <div class="field">
            <label>Nguy√™n qu√°n (T·ªânh / Huy·ªán / X√£)</label>
            <div class="row" style="width:100%">
              <input ${dis} id="hp" style="flex:1" value="${val(p.hometown_province)}" placeholder="T·ªânh">
              <input ${dis} id="hd" style="flex:1" value="${val(p.hometown_district)}" placeholder="Huy·ªán">
              <input ${dis} id="hw" style="flex:1" value="${val(p.hometown_ward)}" placeholder="X√£/Ph∆∞·ªùng">
            </div>
          </div>

          <div class="field">
            <label>ƒê·ªãa ch·ªâ hi·ªán t·∫°i</label>
            <input ${dis} id="current_address" value="${val(p.current_address)}" />
          </div>

          <div class="field">
            <label>Link Google Map</label>
            <input ${dis} id="map_link" value="${val(p.map_link)}" placeholder="https://maps.google.com/..." />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Ti·ªÉu s·ª≠</label>
            <textarea ${dis} id="bio">${val(p.bio)}</textarea>
          </div>

          <div class="field">
            <label>Ng√†y gi·ªó (√Çm l·ªãch) (d/m/y)</label>
            <div class="row" style="width:100%">
              <input ${dis} id="death_lunar_day" style="flex:1" value="${val(p.death_lunar_day)}" placeholder="dd">
              <input ${dis} id="death_lunar_month" style="flex:1" value="${val(p.death_lunar_month)}" placeholder="mm">
              <input ${dis} id="death_lunar_year" style="flex:1" value="${val(p.death_lunar_year)}" placeholder="yyyy">
            </div>
          </div>

          <div class="field">
            <label>Ng√†y gi·ªó t√™n √¢m l·ªãch</label>
            <input ${dis} id="death_lunar_text" value="${val(p.death_lunar_text)}" placeholder="Gi·ªù Tu·∫•t th√°ng Ch·∫°p..." />
          </div>

          <div class="field">
            <label>Th·ªù c√∫ng t·∫°i</label>
            <input ${dis} id="worship_place" value="${val(p.worship_place)}" placeholder="T·ª´ ƒë∆∞·ªùng ch√≠nh..." />
          </div>

          <div class="field">
            <label>Ng∆∞·ªùi ph·ª• tr√°ch</label>
            <input ${dis} id="caretaker_name" value="${val(p.caretaker_name)}" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>M·ªô t√°ng</label>
            <input ${dis} id="tomb_address" value="${val(p.tomb_address)}" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          ${editable && canWrite() ? `<button class="btn good" id="btnSavePerson">${p.id?"L∆∞u":"T·∫°o"}</button>` : ``}
          ${canWrite() ? `<button class="btn" id="btnOpenRel">Quan h·ªá</button>` : `<span class="muted small">Quan h·ªá: ch·ªâ xem</span>`}
          ${p.id && canWrite() ? `<button class="btn danger" id="btnDelPerson">X√≥a</button>` : ``}
        </div>
      `;
    }

    async function wirePersonForm(p={}, editable=true){
      const isNew = !p.id;
      const getVal = () => ({
        family_id: familyId,
        display_role: $("#display_role").value.trim(),
        full_name: $("#full_name").value.trim(),
        other_name: $("#other_name").value.trim(),
        gender: $("#gender").value,
        birth_day: toInt($("#birth_day").value),
        birth_month: toInt($("#birth_month").value),
        birth_year: toInt($("#birth_year").value),
        marital_status: $("#marital_status").value.trim(),
        phone: $("#phone").value.trim(),
        education: $("#education").value.trim(),
        job: $("#job").value.trim(),
        hometown_province: $("#hp").value.trim(),
        hometown_district: $("#hd").value.trim(),
        hometown_ward: $("#hw").value.trim(),
        current_address: $("#current_address").value.trim(),
        map_link: $("#map_link").value.trim(),
        bio: $("#bio").value,
        death_lunar_day: toInt($("#death_lunar_day").value),
        death_lunar_month: toInt($("#death_lunar_month").value),
        death_lunar_year: toInt($("#death_lunar_year").value),
        death_lunar_text: $("#death_lunar_text").value.trim(),
        worship_place: $("#worship_place").value.trim(),
        caretaker_name: $("#caretaker_name").value.trim(),
        tomb_address: $("#tomb_address").value.trim(),
        updated_at: new Date().toISOString()
      });

      $("#btnOpenRel")?.addEventListener("click", ()=> openRelationEditor(p));
      $("#btnDelPerson")?.addEventListener("click", async ()=>{
        if(!confirm("X√≥a th√†nh vi√™n n√†y?")) return;
        const { error } = await sb.from("persons").delete().eq("id", p.id);
        if(error) return toast("L·ªói x√≥a: "+error.message);
        toast("ƒê√£ x√≥a");
        closeModal(); await preloadAll();
      });

      $("#btnSavePerson")?.addEventListener("click", async ()=>{
        const payload = getVal();
        if(!payload.full_name) return toast("Thi·∫øu h·ªç t√™n");
        let saved = null;

        if(isNew){
          const { data, error } = await sb.from("persons").insert(payload).select().single();
          if(error) return toast("L·ªói t·∫°o: "+error.message);
          saved = data; toast("ƒê√£ t·∫°o");
        }else{
          const { data, error } = await sb.from("persons").update(payload).eq("id", p.id).select().single();
          if(error) return toast("L·ªói l∆∞u: "+error.message);
          saved = data; toast("ƒê√£ l∆∞u");
        }

        // avatar upload if file chosen
        const f = $("#avatarFile")?.files?.[0];
        if(f && saved?.id){
          const url = await uploadAvatar(saved.id, f);
          if(url){
            await sb.from("persons").update({ avatar_url: url, updated_at: new Date().toISOString() }).eq("id", saved.id);
            toast("ƒê√£ upload avatar");
          }
        }
        closeModal(); await preloadAll();
      });
    }

    async function uploadAvatar(personId, file){
      try{
        // compress -> jpg 0.82, 512px
        const blob = await compressImage(file, 512, 0.82);
        const path = `families/${familyId}/avatars/${personId}.jpg`;
        const { error } = await sb.storage.from("giapha").upload(path, blob, { upsert: true, contentType: "image/jpeg" });
        if(error){ toast("L·ªói upload ·∫£nh: "+error.message); return null; }
        const { data } = sb.storage.from("giapha").getPublicUrl(path);
        // NOTE: bucket private => publicUrl may not work. If private, use signedUrl:
        // const { data: s } = await sb.storage.from("giapha").createSignedUrl(path, 60*60*24*7);
        // return s?.signedUrl;
        return data.publicUrl || null;
      }catch(e){
        toast("L·ªói n√©n ·∫£nh"); return null;
      }
    }

    // ====== RELATIONS ======
    function openRelationEditor(p){
      if(!p?.id) return toast("H√£y t·∫°o ng∆∞·ªùi tr∆∞·ªõc");
      const options = cachePeople.map(x=>`<option value="${x.id}">${escapeHtml(x.full_name)}</option>`).join("");
      const html = `
        <div class="muted small">T·∫°o quan h·ªá cho: <b>${escapeHtml(p.full_name)}</b></div>
        <div class="grid two" style="margin-top:10px">
          <div class="field">
            <label>Ch·ªçn ng∆∞·ªùi li√™n quan</label>
            <select id="relB">${options}</select>
          </div>
          <div class="field">
            <label>Lo·∫°i quan h·ªá</label>
            <select id="relType">
              <option value="parent">A l√† CHA/M·∫∏ c·ªßa B</option>
              <option value="child">A l√† CON c·ªßa B</option>
              <option value="spouse">V·ª£/Ch·ªìng</option>
              <option value="sibling">Anh/Ch·ªã/Em</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnSaveRel">L∆∞u quan h·ªá</button>
          <button class="btn" id="btnViewRel">Xem danh s√°ch quan h·ªá</button>
        </div>
      `;
      showModal("Quan h·ªá", html);
      $("#btnSaveRel").addEventListener("click", async ()=>{
        const b = $("#relB").value;
        const type = $("#relType").value;
        if(b===p.id) return toast("Kh√¥ng th·ªÉ t·ª± li√™n quan");
        const payload = { family_id: familyId, a: p.id, b, type };
        const { error } = await sb.from("relations").insert(payload);
        if(error) return toast("L·ªói quan h·ªá: "+error.message);
        toast("ƒê√£ l∆∞u quan h·ªá");
        await loadRelations();
      });
      $("#btnViewRel").addEventListener("click", ()=>{
        const rels = cacheRelations
          .filter(r=>r.a===p.id || r.b===p.id)
          .map(r=>{
            const A = cachePeople.find(x=>x.id===r.a)?.full_name || "?";
            const B = cachePeople.find(x=>x.id===r.b)?.full_name || "?";
            return `<div class="item"><div class="left"><div><b>${escapeHtml(A)}</b> ‚Äî <span class="pill">${escapeHtml(r.type)}</span> ‚Äî <b>${escapeHtml(B)}</b></div></div></div>`;
          }).join("");
        $("#mBody").insertAdjacentHTML("beforeend", `<div style="margin-top:10px" class="list">${rels || `<div class="muted small">Ch∆∞a c√≥ quan h·ªá</div>`}</div>`);
      });
    }

    // ====== EVENTS ======
    function renderEvents(arr){
      const box = $("#eventList");
      box.innerHTML = "";
      arr.forEach(ev=>{
        const p = ev.person_id ? cachePeople.find(x=>x.id===ev.person_id) : null;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="left">
            <div style="min-width:0">
              <div class="name">${escapeHtml(ev.title)} <span class="pill">${escapeHtml(ev.event_type)}</span></div>
              <div class="meta">${p ? ("üë§ "+escapeHtml(p.full_name)+" ‚Ä¢ ") : ""}${escapeHtml(ev.date_greg||"")} ${ev.date_lunar?("‚Ä¢ "+escapeHtml(ev.date_lunar)):""}</div>
            </div>
          </div>
          ${canWrite()?`<button class="btn warn" data-id="${ev.id}">S·ª≠a</button>`:""}
        `;
        el.querySelector("button")?.addEventListener("click", ()=> openEvent(ev));
        box.appendChild(el);
      });
    }

    function openEvent(ev=null){
      const options = [`<option value="">(kh√¥ng g·∫Øn ng∆∞·ªùi)</option>`].concat(
        cachePeople.map(p=>`<option value="${p.id}" ${ev?.person_id===p.id?"selected":""}>${escapeHtml(p.full_name)}</option>`)
      ).join("");
      const html = `
        <div class="grid two">
          <div class="field"><label>Ti√™u ƒë·ªÅ</label><input id="evTitle" value="${val(ev?.title)}"></div>
          <div class="field"><label>Lo·∫°i</label>
            <select id="evType">
              ${opt(ev?.event_type, ["gi·ªó","birth","death","anniversary","custom"])}
            </select>
          </div>
          <div class="field"><label>G·∫Øn v·ªõi ng∆∞·ªùi</label><select id="evPerson">${options}</select></div>
          <div class="field"><label>Ng√†y d∆∞∆°ng (text)</label><input id="evGreg" value="${val(ev?.date_greg)}" placeholder="2026-02-05"></div>
          <div class="field" style="grid-column:1/-1"><label>Ng√†y √¢m (text)</label><input id="evLunar" value="${val(ev?.date_lunar)}" placeholder="10/10 Canh Ng·ªç..."></div>
          <div class="field" style="grid-column:1/-1"><label>Ghi ch√∫</label><textarea id="evNote">${val(ev?.note)}</textarea></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn good" id="btnSaveEv">${ev?.id?"L∆∞u":"T·∫°o"}</button>
          ${ev?.id?`<button class="btn danger" id="btnDelEv">X√≥a</button>`:""}
        </div>
      `;
      showModal(ev?.id ? "S·ª≠a s·ª± ki·ªán" : "Th√™m s·ª± ki·ªán", html);
      $("#btnSaveEv").addEventListener("click", async ()=>{
        const payload = {
          family_id: familyId,
          person_id: $("#evPerson").value || null,
          title: $("#evTitle").value.trim(),
          event_type: $("#evType").value,
          date_greg: $("#evGreg").value.trim(),
          date_lunar: $("#evLunar").value.trim(),
          note: $("#evNote").value
        };
        if(!payload.title) return toast("Thi·∫øu ti√™u ƒë·ªÅ");
        if(ev?.id){
          const { error } = await sb.from("events").update(payload).eq("id", ev.id);
          if(error) return toast("L·ªói: "+error.message);
          toast("ƒê√£ l∆∞u"); closeModal(); await loadEvents(); updateStats();
        }else{
          const { error } = await sb.from("events").insert(payload);
          if(error) return toast("L·ªói: "+error.message);
          toast("ƒê√£ t·∫°o"); closeModal(); await loadEvents(); updateStats();
        }
      });
      $("#btnDelEv")?.addEventListener("click", async ()=>{
        if(!confirm("X√≥a s·ª± ki·ªán?")) return;
        const { error } = await sb.from("events").delete().eq("id", ev.id);
        if(error) return toast("L·ªói: "+error.message);
        toast("ƒê√£ x√≥a"); closeModal(); await loadEvents(); updateStats();
      });
    }

    // ====== NOTES ======
    async function openNote(kind){
      currentNoteKind = kind;
      $("#noteKind").textContent = kind === "phaky" ? "Ph·∫£ k√Ω" : "T·ª´ ƒë∆∞·ªùng";
      const { data, error } = await sb.from("notes")
        .select("*")
        .eq("family_id", familyId)
        .eq("kind", kind)
        .maybeSingle();
      if(error) return toast("L·ªói note: "+error.message);

      if(!data){
        currentNoteId = null;
        $("#noteTitle").value = "";
        $("#noteContent").value = "";
      }else{
        currentNoteId = data.id;
        $("#noteTitle").value = data.title || "";
        $("#noteContent").value = data.content || "";
      }
      goTab("notes");
    }

    async function saveNote(){
      if(!canWrite()) return toast("B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a");
      const payload = {
        family_id: familyId,
        kind: currentNoteKind,
        title: $("#noteTitle").value.trim(),
        content: $("#noteContent").value,
        updated_at: new Date().toISOString()
      };
      if(currentNoteId){
        const { error } = await sb.from("notes").update(payload).eq("id", currentNoteId);
        if(error) return toast("L·ªói l∆∞u: "+error.message);
      }else{
        const { data, error } = await sb.from("notes").insert(payload).select().single();
        if(error) return toast("L·ªói t·∫°o: "+error.message);
        currentNoteId = data.id;
      }
      toast("ƒê√£ l∆∞u");
    }

    // ====== TREE (demo layout) ======
    function buildTree(rootId){
      const root = cachePeople.find(p=>p.id===rootId);
      if(!root) return;
      // Build children map by relations type parent/child
      const children = {};
      cachePeople.forEach(p=>children[p.id]=[]);
      // If relation type parent: A is parent of B => A->B
      cacheRelations.forEach(r=>{
        if(r.type==="parent") children[r.a]?.push(r.b);
        if(r.type==="child") children[r.b]?.push(r.a);
      });

      // BFS levels
      const levels = [];
      const seen = new Set();
      let q = [rootId]; seen.add(rootId);
      for(let depth=0; depth<8 && q.length; depth++){
        levels.push(q.slice());
        const next = [];
        q.forEach(id=>{
          (children[id]||[]).forEach(cid=>{
            if(!seen.has(cid)){ seen.add(cid); next.push(cid); }
          });
        });
        q = next;
      }

      // Simple SVG
      const nodeW=170, nodeH=54, gapX=26, gapY=44, pad=20;
      const maxCols = Math.max(...levels.map(l=>l.length));
      const svgW = pad*2 + maxCols*(nodeW+gapX);
      const svgH = pad*2 + levels.length*(nodeH+gapY);
      const pos = {};
      levels.forEach((lvl, i)=>{
        const rowW = lvl.length*(nodeW+gapX) - gapX;
        let startX = pad + (svgW - pad*2 - rowW)/2;
        lvl.forEach((id, j)=>{
          pos[id] = { x: startX + j*(nodeW+gapX), y: pad + i*(nodeH+gapY) };
        });
      });

      const lines = [];
      cacheRelations.forEach(r=>{
        let parent=null, child=null;
        if(r.type==="parent"){ parent=r.a; child=r.b; }
        if(r.type==="child"){ parent=r.b; child=r.a; }
        if(parent && child && pos[parent] && pos[child]){
          const p1 = pos[parent], p2 = pos[child];
          lines.push(`<line x1="${p1.x+nodeW/2}" y1="${p1.y+nodeH}" x2="${p2.x+nodeW/2}" y2="${p2.y}" stroke="rgba(255,255,255,.22)" stroke-width="2"/>`);
        }
      });

      const nodes = Object.keys(pos).map(id=>{
        const p = cachePeople.find(x=>x.id===id);
        const {x,y} = pos[id];
        const name = escapeHtml(p.full_name);
        const role = p.display_role ? ` ‚Ä¢ ${escapeHtml(p.display_role)}` : "";
        return `
          <g>
            <rect x="${x}" y="${y}" rx="16" ry="16" width="${nodeW}" height="${nodeH}" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.16)"/>
            <text x="${x+12}" y="${y+24}" fill="white" font-size="13" font-weight="800">${name}</text>
            <text x="${x+12}" y="${y+42}" fill="rgba(255,255,255,.72)" font-size="11">${escapeHtml(p.gender||"")}${role}</text>
          </g>`;
      }).join("");

      $("#treeBox").innerHTML = `
        <svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}">
          ${lines.join("")}
          ${nodes}
        </svg>
      `;
    }

    // ====== BACKUP ======
    async function exportJson(){
      const pack = {
        family, role,
        people: cachePeople,
        relations: cacheRelations,
        events: cacheEvents,
        notes: [], // load on demand
        media: cacheMedia,
        exported_at: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(pack, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `giapha_${familyId}.json`;
      a.click();
      toast("ƒê√£ export");
    }

    async function importJson(){
      if(!canWrite()) return toast("B·∫°n kh√¥ng c√≥ quy·ªÅn import");
      showModal("Import JSON", `
        <div class="muted small">Ch·ªçn file JSON export tr∆∞·ªõc ƒë√≥. Import s·∫Ω th√™m m·ªõi, kh√¥ng ghi ƒë√® ho√†n h·∫£o (b·∫£n v1).</div>
        <input type="file" id="jsonFile" accept="application/json" />
        <div class="row" style="margin-top:10px">
          <button class="btn warn" id="btnDoImport">Import</button>
        </div>
      `);
      $("#btnDoImport").addEventListener("click", async ()=>{
        const f = $("#jsonFile").files?.[0];
        if(!f) return toast("Ch∆∞a ch·ªçn file");
        const txt = await f.text();
        const data = JSON.parse(txt);
        // naive import: persons -> relations -> events
        if(Array.isArray(data.people) && data.people.length){
          const people = data.people.map(p=>{
            const copy = {...p};
            delete copy.id; // new ids
            copy.family_id = familyId;
            return copy;
          });
          const { error } = await sb.from("persons").insert(people);
          if(error) return toast("L·ªói import people: "+error.message);
        }
        toast("Import xong (t·∫°m)"); closeModal(); await preloadAll();
      });
    }

    // ====== MODAL ======
    function showModal(title, html){
      $("#mTitle").textContent = title;
      $("#mBody").innerHTML = html;
      show("#modal", true);
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
    }
    function closeModal(){ show("#modal", false); $("#mBody").innerHTML = ""; }
    $("#mClose").addEventListener("click", closeModal);

    // ====== NAV ======
    function goTab(tab){
      ["dashboard","tree","people","events","notes"].forEach(t=>{
        $("#screen"+cap(t)).classList.toggle("hide", t!==tab);
      });
      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("on", el.dataset.tab===tab);
      });
    }
    function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    document.querySelectorAll(".tab").forEach(el=>{
      el.addEventListener("click", ()=> goTab(el.dataset.tab));
    });

    // ====== WIRES ======
    $("#btnSendOtp").addEventListener("click", ()=> sendOtp($("#email").value.trim()));
    $("#btnMagic").addEventListener("click", ()=> sendMagic($("#email").value.trim()));
    $("#btnVerify").addEventListener("click", ()=> verifyOtp($("#email").value.trim(), $("#otp").value.trim()));

    $("#btnLogout").addEventListener("click", async ()=>{
      await sb.auth.signOut();
      familyId=null; family=null; role=null;
      show("#secApp", false); show("#tabs", false);
      await refreshSession();
    });

    $("#btnReload").addEventListener("click", loadFamilies);
    $("#btnCreateFamily").addEventListener("click", ()=> createFamily($("#famName").value, $("#famAddr").value));
    $("#btnOpenFamily").addEventListener("click", ()=> openFamily($("#familySelect").value));
    $("#btnNewFamily").addEventListener("click", ()=> toast("Nh·∫≠p form b√™n ph·∫£i r·ªìi b·∫•m T·∫°o"));
    $("#btnInvite").addEventListener("click", ()=>{
      if(role!=="owner") return toast("Ch·ªâ owner m·ªõi m·ªùi");
      showModal("M·ªùi th√†nh vi√™n", `
        <div class="muted small">Supabase membership theo user_id. B·∫£n v1: b·∫°n g·ª≠i ng∆∞·ªùi kia ƒëƒÉng nh·∫≠p email tr∆∞·ªõc, r·ªìi nh·∫≠p user_id c·ªßa h·ªç.</div>
        <div class="field"><label>User ID ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi</label><input id="invUser" placeholder="uuid..." /></div>
        <div class="field"><label>Quy·ªÅn</label>
          <select id="invRole"><option>editor</option><option>viewer</option></select>
        </div>
        <div class="row"><button class="btn good" id="btnDoInvite">M·ªùi</button></div>
        <div class="muted small">Tip: ng∆∞·ªùi kia v√†o app ‚Üí copy user id trong profile (b·∫£n sau m√¨nh th√™m n√∫t copy).</div>
      `);
      $("#btnDoInvite").addEventListener("click", async ()=>{
        const uid = $("#invUser").value.trim();
        const r = $("#invRole").value;
        if(!uid) return toast("Thi·∫øu user id");
        const { error } = await sb.from("memberships").insert({ family_id: familyId, user_id: uid, role: r });
        if(error) return toast("L·ªói m·ªùi: "+error.message);
        toast("ƒê√£ m·ªùi");
        closeModal();
      });
    });

    $("#btnAddPersonQuick").addEventListener("click", ()=> openPerson({}, true));
    $("#btnAddPerson").addEventListener("click", ()=> openPerson({}, true));
    $("#btnSearch").addEventListener("click", ()=>{
      const key = $("#q").value.trim().toLowerCase();
      if(!key) return renderPeople(cachePeople);
      const arr = cachePeople.filter(p=>{
        return (p.full_name||"").toLowerCase().includes(key)
          || String(p.birth_year||"").includes(key)
          || (p.hometown_province||"").toLowerCase().includes(key)
          || (p.current_address||"").toLowerCase().includes(key);
      });
      renderPeople(arr);
    });

    $("#btnAddRelationQuick").addEventListener("click", ()=>{
      if(!cachePeople.length) return toast("Ch∆∞a c√≥ ng∆∞·ªùi");
      openRelationEditor(cachePeople[0]);
    });

    $("#btnAddEventQuick").addEventListener("click", ()=> openEvent(null));
    $("#btnAddEvent").addEventListener("click", ()=> openEvent(null));
    $("#btnRefreshEvents").addEventListener("click", loadEvents);

    $("#btnOpenPhaky").addEventListener("click", ()=> openNote("phaky"));
    $("#btnOpenTuduong").addEventListener("click", ()=> openNote("tuduong"));
    $("#btnSaveNote").addEventListener("click", saveNote);

    $("#btnBuildTree").addEventListener("click", ()=> buildTree($("#rootSelect").value));

    $("#btnBackup").addEventListener("click", exportJson);
    $("#btnRestore").addEventListener("click", importJson);

    // ====== UTIL ======
    function escapeHtml(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
    function val(x){ return escapeHtml(x??""); }
    function opt(cur, arr){
      const c = (cur??arr[0]??"");
      return arr.map(x=>`<option ${x===c?"selected":""}>${escapeHtml(x)}</option>`).join("");
    }
    function toInt(v){ const n = parseInt(v,10); return Number.isFinite(n)?n:null; }
    function fmtY(y){ return y?`SN ${y}`:""; }

    async function compressImage(file, maxSize=512, quality=0.82){
      const img = await new Promise((res, rej)=>{
        const i = new Image();
        i.onload=()=>res(i); i.onerror=rej;
        i.src = URL.createObjectURL(file);
      });
      const w = img.width, h = img.height;
      const scale = Math.min(1, maxSize / Math.max(w,h));
      const nw = Math.round(w*scale), nh = Math.round(h*scale);
      const canvas = document.createElement("canvas");
      canvas.width = nw; canvas.height = nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0,0,nw,nh);
      const blob = await new Promise(res=> canvas.toBlob(res, "image/jpeg", quality));
      return blob;
    }

    // ====== INIT ======
    sb.auth.onAuthStateChange(()=> refreshSession());
    refreshSession();
  </script>
</body>
</html>
